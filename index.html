<!DOCTYPE html>
<html lang="en"> <!-- Language will be updated by JS -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate-key="document_title">Simplified LoLLMs Chat</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <!-- Tailwind CSS via Play CDN (for development/demo) -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <!-- Marked.js for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- KaTeX for Math Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>
    <!-- highlight.js for Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- Pyodide (for Python execution) -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>

    <style>
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Code Block Styling */
        .code-block-wrapper { margin-bottom: 1em; }
        .code-block-header {
            background-color: #3a404d; 
            color: #abb2bf; 
            padding: 0.5rem 0.75rem;
            font-size: 0.8em;
            border-top-left-radius: 6px;
            border-top-right-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .code-block-buttons button {
            background-color: #4b5563; 
            border: none;
            padding: 0.2rem 0.5rem;
            font-size: 0.75em;
            color: #d1d5db;
            cursor: pointer;
            border-radius: 4px;
            margin-left: 0.5rem;
        }
        .code-block-buttons button:hover { background-color: #5a6676; }

        .message-content.prose pre { 
            padding: 0 !important;
            margin-top: 0 !important;
            margin-bottom: 0 !important;
            border-radius: 0 !important;
            background-color: transparent !important; 
            border-bottom-left-radius: 6px !important;
            border-bottom-right-radius: 6px !important;
        }
        .message-content.prose pre code.hljs {
            padding: 1em; 
            display: block;
            overflow-x: auto;
            font-size: 0.875em; 
            line-height: 1.6;
            border-bottom-left-radius: 6px;
            border-bottom-right-radius: 6px;
        }
        .code-output { 
            background-color: #21252b; 
            color: #abb2bf;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.875em;
            padding: 0.75em 1em;
            margin-top: -1px; 
            border-bottom-left-radius: 6px;
            border-bottom-right-radius: 6px;
            border-top: 1px solid #3a404d;
            max-height: 200px;
            overflow-y: auto;
        }
        .katex-display { margin: 0.5em 0 !important; }
        .message-container { display: flex; flex-direction: column; position: relative; }
        .message-bubble { max-width: 85%; padding: 10px 15px; border-radius: 15px; margin-bottom: 10px; word-wrap: break-word; position: relative; }
        .user-bubble { background-color: #dbeafe; align-self: flex-end; border-bottom-right-radius: 5px; }
        .ai-bubble { background-color: #f3f4f6; align-self: flex-start; border-bottom-left-radius: 5px; }
        .system-bubble { background-color: #fef3c7; color: #78350f; align-self: center; font-style: italic; font-size: 0.9em; text-align: center; width: 90%; border-radius: 8px; }
        .sender-name { font-size: 0.8em; font-weight: bold; margin-bottom: 4px; color: #4b5563; }
        .rag-controls { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem; }
        .rag-toggle { padding: 6px 12px; border-radius: 20px; cursor: pointer; transition: background-color 0.3s, color 0.3s; font-weight: 500; border: 1px solid transparent; }
        .rag-toggle-off { background-color: #e5e7eb; color: #4b5563; border-color: #d1d5db; }
        .rag-toggle-on { background-color: #10b981; color: white; }
        .rag-toggle:disabled { opacity: 0.5; cursor: not-allowed; }
        #ragDataStoreSelect { font-size: 0.8rem; padding: 4px 8px; border-radius: 6px; border-color: #d1d5db; background-color: white; }
        .discussion-item-actions {
            display: none; /* Initially hidden */
            gap: 0.25rem; /* Spacing between action buttons */
            /* Removed: position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); */
            /* Removed: background-color: rgba(249, 250, 251, 0.8); */ /* No longer needed if not overlaying */
            /* Removed: padding: 2px 4px; */ /* Buttons have their own padding now */
            /* Removed: border-radius: 4px; */
            /* Removed: z-index: 10; */
            margin-right: 0.25rem; /* Add some space between actions and star */
        }
        .discussion-item:hover .discussion-item-actions {
            display: flex; /* Show on hover */
        }
        .discussion-action-btn {
            background: none;
            border: none;
            /* padding: 2px; */ /* Removed, buttons will have their own padding for better click area */
            cursor: pointer;
            color: #6b7280;
        }
        .discussion-action-btn:hover {
            color: #1f2937;
        }
        
        /* Star button fix: ensure star button is on top of actions menu */
        .star-action-button {
            position: relative; /* Establishes a stacking context */
            z-index: 11;      /* Higher than .discussion-item-actions' z-index of 10 */
        }
        .star-icon { cursor: pointer; color: #d1d5db; }
        .star-icon.starred { color: #facc15; }

        .grade-btn { background: none; border: none; padding: 2px; cursor: pointer; opacity: 0.6; }
        .grade-btn:hover { opacity: 1; }
        .grade-btn.selected-up { color: #10b981; opacity: 1; }
        .grade-btn.selected-down { color: #ef4444; opacity: 1; }
        .grade-score { font-size: 0.8em; margin: 0 5px; color: #6b7280; }
        .message-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 6px; font-size: 0.75rem; color: #6b7280; padding-top: 4px; border-top: 1px solid rgba(0,0,0,0.05); }
        .message-details span { margin-right: 8px; }
        .message-actions { display: none; gap: 0.5rem; }
        .message-bubble:hover .message-actions { display: inline-flex; }
        .message-action-btn { background: none; border: none; padding: 0; cursor: pointer; color: #9ca3af; }
        .message-action-btn:hover { color: #374151; }
        .message-action-btn svg { width: 0.875rem; height: 0.875rem; }
        .think-block { background-color: #fffbeb; border: 1px dashed #fcd34d; border-radius: 4px; margin: 8px 0; }
        .think-block summary { cursor: pointer; padding: 4px 8px; font-size: 0.8em; font-style: italic; color: #92400e; user-select: none; }
        .think-block .think-content { padding: 5px 10px; font-size: 0.9em; color: #57534e; max-height: 200px; overflow-y: auto; background-color: #fefce8; border-top: 1px dashed #fcd34d; }
        #imageUploadPreviewContainer { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px; max-height: 150px; overflow-y: auto; padding: 5px; border: 1px dashed #ccc; border-radius: 4px; }
        .image-preview-item { position: relative; }
        .image-preview-item img { width: 70px; height: 70px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }
        .remove-preview-btn { position: absolute; top: -5px; right: -5px; background-color: rgba(255,0,0,0.7); color: white; border: none; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; line-height: 16px; text-align: center; cursor: pointer; font-weight: bold; }
        .remove-preview-btn:hover { background-color: red; }
        .message-images-container { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px; }
        .message-image-item { max-width: 150px; max-height: 150px; border-radius: 8px; overflow: hidden; cursor: pointer; }
        .message-image-item img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .modal { position: fixed; inset: 0; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; pointer-events: none; transition: opacity 0.3s ease-in-out; padding: 1rem;}
        .modal.active { opacity: 1; pointer-events: auto; }
        .modal-content { background-color: white; padding: 0; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); max-width: 95vw; width: 600px; max-height: 90vh; display: flex; flex-direction: column; }
        #loginModal .modal-content { width: 400px; padding: 1.5rem 2rem; }
        #dataStoresModal .modal-content, #fileManagementModal .modal-content { width: 700px; padding: 1.5rem 2rem; }
        #settingsModal .modal-content { width: 750px; overflow: hidden; } 
        .modal-header { border-bottom: 1px solid #e5e7eb; padding: 1rem 1.5rem; margin-bottom: 0; display: flex; justify-content: space-between; align-items: center;}
        .modal-title { font-size: 1.125rem; font-weight: 600; color: #1f2937; }
        .modal-body { flex-grow: 1; overflow: hidden; padding:0; } 
        #settingsModal .modal-body { display: flex; flex-direction: row; } 
        .modal-footer { border-top: 1px solid #e5e7eb; padding: 1rem 1.5rem; margin-top:0; display: flex; justify-content: flex-end; gap: 0.75rem; }
        .modal-close-btn { position: absolute; top: 0.75rem; right: 0.75rem; color: #9ca3af; background: none; border: none; cursor: pointer; padding: 0.25rem;}
        .modal-close-btn:hover { color: #1f2937; }
        .sidebar-btn { display: flex; align-items: center; width: 100%; text-align: left; padding: 0.5rem 0.75rem; font-size: 0.875rem; color: #4b5563; border-radius: 0.375rem; background-color: #f9fafb; border: 1px solid #e5e7eb; }
        .sidebar-btn:hover { background-color: #f3f4f6; }
        .sidebar-btn svg { margin-right: 0.5rem; width: 1rem; height: 1rem; color: #6b7280; }
        #appLoadingMessage { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255,255,255,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; text-align: center; }
    
        /* Settings Tab Styles */
        .settings-tab-btn { background-color: #f9fafb; color: #374151; border: 1px solid transparent; transition: background-color 0.2s, color 0.2s; }
        .settings-tab-btn:hover { background-color: #f3f4f6; color: #1f2937; }
        .settings-tab-btn.active-tab { background-color: #e0e7ff; color: #4338ca; font-weight: 500; border-right: 2px solid #4f46e5; }
        .settings-tab-content { padding: 0.5rem; }
        /* User Menu Item Style */
        .user-menu-item { display: flex; align-items: center; width: 100%; text-align: left; padding: 0.5rem 0.75rem; font-size: 0.875rem; color: #374151; cursor: pointer; }
        .user-menu-item:hover { background-color: #f3f4f6; }
        .user-menu-item svg { margin-right: 0.75rem; width: 1rem; height: 1rem; color: #6b7280; }
        .discussion-section-header { padding: 0.25rem 0.5rem; font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; margin-top: 0.5rem; }
        .discussion-section-header:first-child { margin-top: 0; }

    </style>
</head>
<body class="bg-gray-100 text-gray-900">

    <div id="appLoadingMessage">
        <img src="/logo.png" alt="Loading LoLLMs" class="h-20 mx-auto mb-4">
        <p class="text-xl font-semibold text-gray-700 mb-2" data-translate-key="app_loading_title">Loading Application...</p>
        <p id="appLoadingStatus" class="text-gray-600" data-translate-key="app_loading_status_default">Please wait.</p>
    </div>

    <div id="app-container" class="flex h-screen overflow-hidden" style="display: none;">

        <!-- Sidebar -->
        <aside class="w-72 bg-white border-r border-gray-200 flex flex-col">
            <div class="p-4 border-b border-gray-200">
                 <img src="/logo.png" alt="Logo" class="h-10 mx-auto mb-2" data-translate-alt="logo_alt">
                 <h2 class="text-xl font-semibold text-center text-gray-700" data-translate-key="lollms_chat_title_sidebar">Lollms Chat</h2>
            </div>
            <div class="p-3 border-b border-gray-200">
                <button id="newDiscussionBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                    <span data-translate-key="new_discussion_btn">New Discussion</span>
                </button>
            </div>
            <div class="p-3 border-b border-gray-200">
                <input type="text" id="discussionSearchInput" data-translate-placeholder="discussion_search_placeholder" placeholder="Search discussions..." class="w-full px-3 py-1.5 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div id="discussionListContainer" class="flex-1 overflow-y-auto p-2">
                <p class="text-gray-500 text-sm text-center italic p-4" data-translate-key="loading_discussions_placeholder">Loading discussions...</p>
            </div>

            <div class="p-3 border-t border-gray-200 bg-gray-50">
                <div id="userInfoContainer" class="relative">
                    <button id="userMenuToggleBtn" class="w-full flex items-center justify-between text-sm p-2 rounded-md hover:bg-gray-200 transition-colors focus:outline-none">
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2 text-gray-600"><path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0a9 9 0 1 0-11.963 0m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>
                            <span id="usernameDisplay" class="font-semibold text-gray-700" data-translate-key="username_display_default">...</span>
                            <span id="adminBadge" class="ml-2 text-xs bg-red-100 text-red-800 px-1.5 py-0.5 rounded-full font-medium" style="display: none;" data-translate-key="admin_badge_text">Admin</span>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 text-gray-500 transition-transform transform" id="userMenuArrow"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /></svg>
                    </button>
                    <div id="userMenuDropdown" class="absolute bottom-full left-0 right-0 mb-1 w-full bg-white border border-gray-200 rounded-md shadow-lg py-1 z-20" style="display: none;">
                         <button id="settingsBtn" class="user-menu-item">
                             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 0 1 0 1.255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 0 1 0-1.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>
                             <span data-translate-key="settings_btn_text">Settings</span>
                         </button>
                         <button id="dataStoresBtn" class="user-menu-item">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375m16.5 0v3.75m-16.5-3.75v3.75m16.5 0v3.75C20.25 16.153 16.556 18 12 18s-8.25-1.847-8.25-4.125v-3.75m16.5 0c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125" /></svg>
                            <span data-translate-key="data_stores_btn_text">Data Stores</span>
                         </button>
                         <a href="/admin" id="adminLink" class="user-menu-item" style="display: none;">
                              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" /></svg>
                              <span data-translate-key="admin_panel_link_text">Admin Panel</span>
                         </a>
                         <div class="px-3 py-2">
                            <div class="flex space-x-2">
                                 <button id="exportDataBtn" class="flex-1 text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 py-1 px-2 rounded border border-gray-300" data-translate-key="export_data_btn_text">Export Data</button>
                                 <button id="importDataBtn" class="flex-1 text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 py-1 px-2 rounded border border-gray-300" data-translate-key="import_data_btn_text">Import Data</button>
                             </div>
                        </div>
                         <hr class="my-1 border-gray-200">
                         <button id="logoutBtn" class="user-menu-item text-red-600 hover:bg-red-100 focus:bg-red-100">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m3 0 3-3m0 0-3-3m3 3H9" /></svg>
                            <span data-translate-key="logout_btn_text">Logout</span>
                        </button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="flex-1 flex flex-col bg-gray-50">
            <header class="bg-white border-b border-gray-200 p-3 flex items-center justify-between min-h-[65px] shadow-sm">
                <h3 id="discussionTitle" class="text-lg font-semibold text-gray-800 truncate px-2" data-translate-key="default_discussion_title">Select or Create a Discussion</h3>
                <div class="rag-controls">
                    <label for="languageSelector" class="sr-only" data-translate-key="language_selector_label_sr">Select Language</label>
                    <select id="languageSelector" class="text-xs rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <div class="rag-controls">
                    <button id="ragToggleBtn" class="rag-toggle rag-toggle-off self-center" data-translate-key="rag_toggle_btn_text" data-translate-title="rag_toggle_btn_title_off">RAG</button>
                    <select id="ragDataStoreSelect" class="text-xs rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" style="display: none;">
                        <option value="" data-translate-key="rag_select_default_option">Select RAG Data Store</option>
                    </select>
                </div>
            </header>

            <div id="chatMessages" class="flex-1 overflow-y-auto p-4 flex flex-col space-y-2">
                <div class="text-center text-gray-500 italic mt-10" data-translate-key="chat_area_empty_placeholder">Select a discussion to start chatting.</div>
            </div>

            <footer class="bg-white border-t border-gray-200 p-3 shadow-inner">
                 <div id="imageUploadPreviewContainer" class="mb-2" style="display: none;"></div>
                <div class="flex items-end space-x-3">
                    <label for="imageUploadInput" class="p-2 rounded-md hover:bg-gray-100 cursor-pointer self-end">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-gray-500"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" /></svg>
                    </label>
                    <input type="file" id="imageUploadInput" multiple accept="image/*" class="hidden">
                    <textarea id="messageInput" rows="1" class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 text-sm" data-translate-placeholder="message_input_placeholder" placeholder="Type your message... (Shift+Enter for new line)" style="resize: none; overflow-y: hidden;"></textarea>
                    <button id="sendMessageBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out self-end disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" /></svg>
                    </button>
                </div>
                <div id="statusMessage" class="text-xs text-red-600 mt-1 h-4"></div>
                <div id="pyodideStatus" class="text-xs text-blue-600 mt-1 h-4"></div>
            </footer>
        </main>
    </div>

    <!-- Modals Container -->
    <div>
        <!-- Login Modal -->
        <div id="loginModal" class="modal">
            <div class="modal-content">
                <div class="modal-header"><h3 class="modal-title" data-translate-key="login_modal_title">Login Required</h3></div>
                <div class="modal-body space-y-4" style="padding: 1rem 0;">
                    <img src="/logo.png" alt="Logo" class="h-16 mx-auto mb-4" data-translate-alt="logo_alt">
                    <div>
                        <label for="loginUsername" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="login_username_label">Username</label>
                        <input type="text" id="loginUsername" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" data-translate-placeholder="login_username_placeholder" placeholder="Enter your username">
                    </div>
                    <div>
                        <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="login_password_label">Password</label>
                        <input type="password" id="loginPassword" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" data-translate-placeholder="login_password_placeholder" placeholder="Enter your password">
                    </div>
                    <div id="loginStatus" class="text-xs text-red-600 mt-1 h-4"></div>
                </div>
                <div class="modal-footer">
                    <button id="loginSubmitBtn" class="w-full px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" data-translate-key="login_submit_btn">Login</button>
                </div>
            </div>
        </div>

        <!-- Rename Discussion Modal -->
        <div id="renameModal" class="modal">
            <div class="modal-content" style="padding: 1.5rem 2rem;">
                <button class="modal-close-btn" onclick="closeModal('renameModal')">×</button>
                <div class="modal-header"><h3 class="modal-title" data-translate-key="rename_modal_title">Rename Discussion</h3></div>
                <div class="modal-body" style="padding: 1rem 0;">
                    <label for="renameInput" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="rename_input_label">New discussion title:</label>
                    <input type="text" id="renameInput" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" data-translate-placeholder="rename_input_placeholder" placeholder="Enter new title">
                    <div id="renameStatus" class="text-xs text-red-600 mt-1 h-4"></div>
                    <input type="hidden" id="renameDiscussionIdInput">
                </div>
                <div class="modal-footer">
                    <button onclick="closeModal('renameModal')" class="px-4 py-2 bg-gray-200 text-gray-800 text-sm font-medium rounded-md hover:bg-gray-300" data-translate-key="cancel_btn">Cancel</button>
                    <button id="confirmRenameBtn" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700" data-translate-key="rename_btn">Rename</button>
                </div>
            </div>
        </div>
        
        <!-- Send Discussion Modal -->
        <div id="sendDiscussionModal" class="modal">
            <div class="modal-content" style="padding: 1.5rem 2rem;">
                <button class="modal-close-btn" onclick="closeModal('sendDiscussionModal')">×</button>
                <div class="modal-header"><h3 class="modal-title" data-translate-key="send_discussion_modal_title_default">Send Discussion</h3></div>
                <div class="modal-body" style="padding: 1rem 0;">
                    <label for="sendTargetUsername" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="send_discussion_target_user_label">Target Username:</label>
                    <input type="text" id="sendTargetUsername" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" data-translate-placeholder="send_discussion_target_user_placeholder" placeholder="Enter username of recipient">
                    <div id="sendDiscussionStatus" class="text-xs text-red-600 mt-1 h-4"></div>
                    <input type="hidden" id="sendDiscussionIdInput">
                </div>
                <div class="modal-footer">
                    <button onclick="closeModal('sendDiscussionModal')" class="px-4 py-2 bg-gray-200 text-gray-800 text-sm font-medium rounded-md hover:bg-gray-300" data-translate-key="cancel_btn">Cancel</button>
                    <button id="confirmSendDiscussionBtn" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700" data-translate-key="send_btn">Send</button>
                </div>
            </div>
        </div>

        <!-- Edit Message Modal -->
        <div id="editMessageModal" class="modal">
            <div class="modal-content" style="padding: 1.5rem 2rem;">
                <button class="modal-close-btn" onclick="closeModal('editMessageModal')">×</button>
                <div class="modal-header"><h3 class="modal-title" data-translate-key="edit_message_modal_title">Edit Message</h3></div>
                <div class="modal-body" style="padding: 1rem 0;">
                    <label for="editMessageInput" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="edit_message_input_label">Message content:</label>
                    <textarea id="editMessageInput" rows="5" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></textarea>
                    <div id="editMessageStatus" class="text-xs text-red-600 mt-1 h-4"></div>
                    <input type="hidden" id="editMessageIdInput">
                </div>
                <div class="modal-footer">
                    <button onclick="closeModal('editMessageModal')" class="px-4 py-2 bg-gray-200 text-gray-800 text-sm font-medium rounded-md hover:bg-gray-300" data-translate-key="cancel_btn">Cancel</button>
                    <button id="confirmEditMessageBtn" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700" data-translate-key="save_changes_btn">Save Changes</button>
                </div>
            </div>
        </div>

        <!-- Export Modal -->
        <div id="exportModal" class="modal">
             <div class="modal-content" style="padding: 1.5rem 2rem;">
                 <button class="modal-close-btn" onclick="closeModal('exportModal')">×</button>
                 <div class="modal-header"><h3 class="modal-title" data-translate-key="export_modal_title">Export Data</h3></div>
                 <div class="modal-body" style="padding: 1rem 0;">
                     <p class="text-sm text-gray-600 mb-3" data-translate-key="export_modal_description">Select discussions to export (leave all unchecked to export all):</p>
                     <div id="exportDiscussionList" class="max-h-60 overflow-y-auto border border-gray-200 rounded p-3 space-y-2 bg-gray-50">
                         <p class="text-gray-500 italic" data-translate-key="loading_discussions_placeholder">Loading discussions...</p>
                     </div>
                 </div>
                 <div class="modal-footer">
                     <button onclick="closeModal('exportModal')" class="px-4 py-2 bg-gray-200 text-gray-800 text-sm font-medium rounded-md hover:bg-gray-300" data-translate-key="cancel_btn">Cancel</button>
                     <button id="confirmExportBtn" class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700" data-translate-key="export_selected_btn">Export Selected</button>
                 </div>
            </div>
        </div>

        <!-- Import Modal -->
         <div id="importModal" class="modal">
            <div class="modal-content" style="padding: 1.5rem 2rem;">
                <button class="modal-close-btn" onclick="closeModal('importModal')">×</button>
                <div class="modal-header"><h3 class="modal-title" data-translate-key="import_modal_title">Import Discussions</h3></div>
                <div class="modal-body" style="padding: 1rem 0;">
                    <div class="mb-4">
                        <label for="importFile" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="import_file_label">Select Exported JSON File (.json):</label>
                        <input type="file" id="importFile" accept=".json" class="block w-full text-sm text-gray-500 file:mr-4 file:py-1.5 file:px-3 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 border border-gray-300 rounded-md cursor-pointer"/>
                    </div>
                    <div id="importPreviewArea" class="mb-4" style="display: none;">
                        <p class="text-sm text-gray-600 mb-2" data-translate-key="import_preview_description">Select discussions to import from the file:</p>
                         <div id="importDiscussionList" class="max-h-60 overflow-y-auto border border-gray-200 rounded p-3 space-y-2 bg-gray-50"></div>
                    </div>
                    <p id="importStatus" class="text-sm text-red-600 h-4"></p>
                </div>
                <div class="modal-footer">
                    <button onclick="closeModal('importModal')" class="px-4 py-2 bg-gray-200 text-gray-800 text-sm font-medium rounded-md hover:bg-gray-300" data-translate-key="cancel_btn">Cancel</button>
                    <button id="confirmImportBtn" class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed" data-translate-key="import_selected_btn" disabled>Import Selected</button>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settingsModal" class="modal">
            <div class="modal-content">
                <button class="modal-close-btn" onclick="closeModal('settingsModal')">×</button>
                <div class="modal-header">
                    <h3 class="modal-title" data-translate-key="settings_modal_title">User Settings</h3>
                </div>
                
                <div class="modal-body flex flex-row flex-grow overflow-hidden">
                    <nav class="w-52 border-r border-gray-200 pr-3 mr-3 py-3 space-y-1 flex-shrink-0 overflow-y-auto">
                        <button data-tab="llmConfigTab" class="settings-tab-btn active-tab w-full text-left px-3 py-2 rounded-md text-sm font-medium" data-translate-key="settings_tab_llm_config">LLM Configuration</button>
                        <button data-tab="llmParamsTab" class="settings-tab-btn w-full text-left px-3 py-2 rounded-md text-sm font-medium" data-translate-key="settings_tab_llm_params">LLM Parameters</button>
                        <button data-tab="accountTab" class="settings-tab-btn w-full text-left px-3 py-2 rounded-md text-sm font-medium" data-translate-key="settings_tab_account">Account Settings</button>
                    </nav>
        
                    <div class="flex-grow overflow-y-auto pl-3 py-3 pr-1">
                        <div id="llmConfigTab" class="settings-tab-content">
                            <div class="space-y-3">
                                <h4 class="text-md font-semibold text-gray-800 mb-1" data-translate-key="settings_llm_config_model_header">Default LLM Model</h4>
                                <div>
                                    <select id="settingsLollmsModelSelect" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                        <option data-translate-key="settings_llm_models_loading">Loading models...</option>
                                    </select>
                                </div>
                                <div class="text-right">
                                     <button id="saveModelAndVectorizerBtn" class="px-3 py-1.5 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 disabled:opacity-50" data-translate-key="settings_llm_config_save_model_btn">Save Model</button>
                                </div>
                                <div id="settingsStatus_llmConfig" class="text-sm h-4"></div>
                            </div>
                        </div>
                        <div id="llmParamsTab" class="settings-tab-content" style="display: none;">
                            <div class="space-y-4">
                                <h4 class="text-md font-semibold text-gray-800 mb-1" data-translate-key="settings_llm_params_header">LLM Generation Parameters</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="settingsTemperature" class="block text-sm font-medium text-gray-700" data-translate-key="settings_llm_param_temp_label">Temperature</label>
                                        <input type="number" id="settingsTemperature" step="0.01" min="0" max="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="e.g., 0.7">
                                    </div>
                                    <div>
                                        <label for="settingsTopK" class="block text-sm font-medium text-gray-700" data-translate-key="settings_llm_param_topk_label">Top K</label>
                                        <input type="number" id="settingsTopK" step="1" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="e.g., 50">
                                    </div>
                                    <div>
                                        <label for="settingsTopP" class="block text-sm font-medium text-gray-700" data-translate-key="settings_llm_param_topp_label">Top P</label>
                                        <input type="number" id="settingsTopP" step="0.01" min="0" max="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="e.g., 0.95">
                                    </div>
                                    <div>
                                        <label for="settingsRepeatPenalty" class="block text-sm font-medium text-gray-700" data-translate-key="settings_llm_param_repeatpenalty_label">Repeat Penalty</label>
                                        <input type="number" id="settingsRepeatPenalty" step="0.01" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="e.g., 1.1">
                                    </div>
                                    <div>
                                        <label for="settingsRepeatLastN" class="block text-sm font-medium text-gray-700" data-translate-key="settings_llm_param_repeatlastn_label">Repeat Last N</label>
                                        <input type="number" id="settingsRepeatLastN" step="1" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="e.g., 64">
                                    </div>
                                </div>
                                <div class="text-right">
                                    <button id="saveLLMParamsBtn" class="px-3 py-1.5 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 disabled:opacity-50" data-translate-key="settings_llm_params_save_btn">Save LLM Parameters</button>
                                </div>
                                <div id="settingsStatus_llmParams" class="text-sm h-4"></div>
                            </div>
                        </div>
                        <div id="accountTab" class="settings-tab-content" style="display: none;">
                             <div class="space-y-3">
                                <h4 class="text-md font-semibold text-gray-800 mb-1" data-translate-key="settings_account_change_pwd_header">Change Password</h4>
                                <div>
                                    <label for="settingsCurrentPassword" class="block text-sm font-medium text-gray-700" data-translate-key="settings_account_current_pwd_label">Current Password</label>
                                    <input type="password" id="settingsCurrentPassword" autocomplete="current-password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" data-translate-placeholder="settings_account_current_pwd_placeholder" placeholder="Enter current password">
                                </div>
                                <div>
                                    <label for="settingsNewPassword" class="block text-sm font-medium text-gray-700" data-translate-key="settings_account_new_pwd_label">New Password</label>
                                    <input type="password" id="settingsNewPassword" autocomplete="new-password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" data-translate-placeholder="settings_account_new_pwd_placeholder" placeholder="Enter new password (min 8 characters)">
                                </div>
                                <div>
                                    <label for="settingsConfirmPassword" class="block text-sm font-medium text-gray-700" data-translate-key="settings_account_confirm_pwd_label">Confirm New Password</label>
                                    <input type="password" id="settingsConfirmPassword" autocomplete="new-password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" data-translate-placeholder="settings_account_confirm_pwd_placeholder" placeholder="Confirm new password">
                                </div>
                                <div class="text-right">
                                    <button id="changePasswordBtn" class="px-3 py-1.5 bg-orange-600 text-white text-sm font-medium rounded-md hover:bg-orange-700 disabled:opacity-50" data-translate-key="settings_account_change_pwd_btn" disabled>Change Password</button>
                                </div>
                                <div id="passwordChangeStatus" class="text-sm h-4"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button onclick="closeModal('settingsModal')" class="px-4 py-2 bg-gray-200 text-gray-800 text-sm font-medium rounded-md hover:bg-gray-300" data-translate-key="close_btn">Close</button>
                </div>
            </div>
        </div>

        <!-- Data Stores Management Modal -->
        <div id="dataStoresModal" class="modal">
            <div class="modal-content" style="padding: 1.5rem 2rem;">
                <button class="modal-close-btn" onclick="closeModal('dataStoresModal')">×</button>
                <div class="modal-header"><h3 class="modal-title" data-translate-key="datastores_modal_title">Manage Data Stores (RAG)</h3></div>
                <div class="modal-body space-y-6" style="padding: 1rem 0;">
                    <section class="border border-gray-200 rounded-md p-4">
                        <h4 class="text-md font-medium text-gray-800 mb-3" data-translate-key="datastores_create_header">Create New Data Store</h4>
                        <form id="createDataStoreForm" class="space-y-3">
                            <div>
                                <label for="newDataStoreName" class="block text-sm font-medium text-gray-700" data-translate-key="datastores_name_label">Name</label>
                                <input type="text" id="newDataStoreName" required minlength="3" maxlength="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="newDataStoreDescription" class="block text-sm font-medium text-gray-700" data-translate-key="datastores_description_label">Description (Optional)</label>
                                <textarea id="newDataStoreDescription" rows="2" maxlength="500" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></textarea>
                            </div>
                            <div class="text-right">
                                <button type="submit" class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700" data-translate-key="datastores_create_btn">Create Store</button>
                            </div>
                        </form>
                        <div id="createDataStoreStatus" class="text-sm h-4 mt-2"></div>
                    </section>
                    <section>
                        <h4 class="text-md font-medium text-gray-800 mb-2" data-translate-key="datastores_owned_header">Your Data Stores</h4>
                        <div id="ownedDataStoresList" class="max-h-48 overflow-y-auto space-y-2 bg-gray-50 border border-gray-100 rounded p-3">
                            <p class="text-gray-500 italic" data-translate-key="datastores_loading_owned">Loading your stores...</p>
                        </div>
                    </section>
                    <section>
                        <h4 class="text-md font-medium text-gray-800 mb-2" data-translate-key="datastores_shared_header">Data Stores Shared With You</h4>
                        <div id="sharedDataStoresList" class="max-h-48 overflow-y-auto space-y-2 bg-gray-50 border border-gray-100 rounded p-3">
                           <p class="text-gray-500 italic" data-translate-key="datastores_loading_shared">Loading shared stores...</p>
                        </div>
                    </section>
                </div>
                <div class="modal-footer">
                    <button onclick="closeModal('dataStoresModal')" class="px-4 py-2 bg-gray-200 text-gray-800 text-sm font-medium rounded-md hover:bg-gray-300" data-translate-key="close_btn">Close</button>
                </div>
            </div>
        </div>
        
        <!-- Share Data Store Modal -->
        <div id="shareDataStoreModal" class="modal">
            <div class="modal-content" style="width: 450px; padding: 1.5rem 2rem;">
                <button class="modal-close-btn" onclick="closeModal('shareDataStoreModal')">×</button>
                <div class="modal-header"><h3 id="shareDataStoreTitle" class="modal-title" data-translate-key="share_datastore_modal_title_default">Share Data Store</h3></div>
                <div class="modal-body" style="padding: 1rem 0;">
                    <label for="shareTargetUsernameDS" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="share_datastore_target_user_label">Share with Username:</label>
                    <input type="text" id="shareTargetUsernameDS" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" data-translate-placeholder="share_datastore_target_user_placeholder" placeholder="Enter username to share with">
                    <div id="shareDataStoreStatus" class="text-xs text-red-600 mt-1 h-4"></div>
                    <input type="hidden" id="shareDataStoreIdInput">
                </div>
                <div class="modal-footer">
                    <button onclick="closeModal('shareDataStoreModal')" class="px-4 py-2 bg-gray-200 text-gray-800 text-sm font-medium rounded-md hover:bg-gray-300" data-translate-key="cancel_btn">Cancel</button>
                    <button id="confirmShareDataStoreBtn" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700" data-translate-key="share_btn">Share</button>
                </div>
            </div>
        </div>

        <!-- File Management Modal -->
        <div id="fileManagementModal" class="modal">
            <div class="modal-content" style="padding: 1.5rem 2rem;">
                <button class="modal-close-btn" onclick="closeModal('fileManagementModal')">×</button>
                <div class="modal-header"><h3 class="modal-title"><span data-translate-key="file_manager_modal_title_prefix">Manage Files in Data Store:</span> <span id="fileManagerDataStoreName" class="font-normal"></span></h3></div>
                <div class="modal-body space-y-5" style="padding: 1rem 0;">
                    <input type="hidden" id="fileManagerCurrentDataStoreId">
                    <div class="border border-gray-200 rounded-md p-4">
                         <h4 class="text-md font-medium text-gray-800 mb-3" data-translate-key="file_manager_upload_header">Upload New Documents</h4>
                         <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                             <div>
                                 <label for="fileVectorizerSelect" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="file_manager_vectorizer_label">Vectorizer for Upload</label>
                                 <select id="fileVectorizerSelect" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                     <option value="" data-translate-key="file_manager_vectorizer_select_default">Select Vectorizer</option>
                                 </select>
                             </div>
                             <div>
                                <label for="fileUploadInputFS" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="file_manager_select_files_label">Select Files</label>
                                <input type="file" id="fileUploadInputFS" multiple class="block w-full text-sm text-gray-500 file:mr-4 file:py-1.5 file:px-3 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 border border-gray-300 rounded-md cursor-pointer"/>
                            </div>
                         </div>
                         <div class="text-right mt-3">
                            <button id="confirmUploadBtn" class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 disabled:opacity-50" disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline-block mr-1 align-text-bottom"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0 3 3m-3-3-3 3M6.75 19.5a4.5 4.5 0 0 1-1.41-8.775 5.25 5.25 0 0 1 10.233-2.33 3 3 0 0 1 3.758 3.848A3.752 3.752 0 0 1 18 19.5H6.75Z" /></svg>
                                <span data-translate-key="file_manager_upload_btn">Upload Files</span>
                            </button>
                         </div>
                         <div id="uploadStatus" class="text-sm h-4 mt-2"></div>
                    </div>
                     <div class="border border-gray-200 rounded-md p-4">
                         <h4 class="text-md font-medium text-gray-800 mb-3" data-translate-key="file_manager_indexed_docs_header">Indexed Documents in this Store</h4>
                         <div id="indexedFileList" class="max-h-60 overflow-y-auto space-y-2 bg-gray-50 border border-gray-100 rounded p-3">
                            <p class="text-gray-500 italic" data-translate-key="file_manager_loading_files">Loading files...</p>
                         </div>
                          <div id="fileListStatus" class="text-sm h-4 mt-2"></div>
                    </div>
                </div>
                 <div class="modal-footer">
                    <button onclick="closeModal('fileManagementModal')" class="px-4 py-2 bg-gray-200 text-gray-800 text-sm font-medium rounded-md hover:bg-gray-300" data-translate-key="close_btn">Close</button>
                </div>
            </div>
        </div>
        
        <!-- Image Viewer Modal -->
        <div id="imageViewerModal" class="modal">
            <div class="modal-content p-2 relative" style="max-width: 90vw; max-height: 90vh; width: auto; height: auto;">
                 <button class="modal-close-btn text-2xl font-bold text-white bg-black bg-opacity-50 rounded-full p-1 leading-none" style="top:10px; right:10px; width:30px; height:30px;" onclick="closeModal('imageViewerModal')">×</button>
                <img id="imageViewerSrc" src="" alt="Enlarged Image" class="max-w-full max-h-full object-contain" data-translate-alt="image_viewer_alt">
            </div>
        </div>

    </div> <!-- End Modals Container -->


    <script>
        // --- Localization State ---
        let currentTranslations = {};
        let currentLang = 'en'; // Default language
        let availableLanguages = { 'en': 'English', 'fr': 'French' }; // Default, will be updated

        // --- Global State ---
        let currentUser = null; 
        let currentDiscussionId = null;
        let discussions = {}; 
        let currentMessages = []; 
        let aiMessageStreaming = false;
        let currentAiMessageElement = null;
        let currentAiMessageContent = "";
        let currentAiMessageId = null;
        let pyodide = null;
        let pyodideLoading = false;
        let isRagActive = false; 
        let availableLollmsModels = [];
        let availableVectorizers = []; 
        let userDefaultVectorizer = null; 
        
        let ownedDataStores = []; 
        let sharedDataStores = []; 
        let availableDataStoresForRag = [];

        let uploadedImageServerPaths = []; 

        let tempLoginUsername = null;
        let tempLoginPassword = null;

        // --- DOM Elements ---
        const languageSelector = document.getElementById('languageSelector');
        const appLoadingMessage = document.getElementById('appLoadingMessage');
        const appLoadingStatus = document.getElementById('appLoadingStatus');
        const appContainer = document.getElementById('app-container');
        const loginModal = document.getElementById('loginModal');
        const loginUsernameInput = document.getElementById('loginUsername');
        const loginPasswordInput = document.getElementById('loginPassword');
        const loginSubmitBtn = document.getElementById('loginSubmitBtn');
        const loginStatus = document.getElementById('loginStatus');
        const discussionSearchInput = document.getElementById('discussionSearchInput');
        const discussionListContainer = document.getElementById('discussionListContainer');
        const newDiscussionBtn = document.getElementById('newDiscussionBtn');
        const usernameDisplay = document.getElementById('usernameDisplay');
        const adminBadge = document.getElementById('adminBadge');
        const userMenuToggleBtn = document.getElementById('userMenuToggleBtn');
        const userMenuDropdown = document.getElementById('userMenuDropdown');
        const userMenuArrow = document.getElementById('userMenuArrow');
        const adminLink = document.getElementById('adminLink');
        const settingsBtn = document.getElementById('settingsBtn');
        const dataStoresBtn = document.getElementById('dataStoresBtn');
        const exportDataBtn = document.getElementById('exportDataBtn');
        const importDataBtn = document.getElementById('importDataBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const discussionTitle = document.getElementById('discussionTitle');
        const ragToggleBtn = document.getElementById('ragToggleBtn');
        const ragDataStoreSelect = document.getElementById('ragDataStoreSelect');
        const imageUploadInput = document.getElementById('imageUploadInput');
        const imageUploadPreviewContainer = document.getElementById('imageUploadPreviewContainer');
        const statusMessage = document.getElementById('statusMessage');
        const pyodideStatus = document.getElementById('pyodideStatus');
        // Modals
        const renameModal = document.getElementById('renameModal');
        const renameInput = document.getElementById('renameInput');
        const confirmRenameBtn = document.getElementById('confirmRenameBtn');
        const renameStatus = document.getElementById('renameStatus');
        const renameDiscussionIdInput = document.getElementById('renameDiscussionIdInput');
        const sendDiscussionModal = document.getElementById('sendDiscussionModal');
        const sendTargetUsernameInput = document.getElementById('sendTargetUsername');
        const confirmSendDiscussionBtn = document.getElementById('confirmSendDiscussionBtn');
        const sendDiscussionStatus = document.getElementById('sendDiscussionStatus');
        const sendDiscussionIdInput = document.getElementById('sendDiscussionIdInput');
        const editMessageModal = document.getElementById('editMessageModal');
        const editMessageInput = document.getElementById('editMessageInput');
        const confirmEditMessageBtn = document.getElementById('confirmEditMessageBtn');
        const editMessageStatus = document.getElementById('editMessageStatus');
        const editMessageIdInput = document.getElementById('editMessageIdInput');
        const exportModal = document.getElementById('exportModal');
        const exportDiscussionList = document.getElementById('exportDiscussionList');
        const confirmExportBtn = document.getElementById('confirmExportBtn');
        const importModal = document.getElementById('importModal');
        const importFile = document.getElementById('importFile');
        const importPreviewArea = document.getElementById('importPreviewArea');
        const importDiscussionList = document.getElementById('importDiscussionList');
        const confirmImportBtn = document.getElementById('confirmImportBtn');
        const importStatus = document.getElementById('importStatus');
        
        // Settings Modal Elements
        const settingsModal = document.getElementById('settingsModal');
        const settingsLollmsModelSelect = document.getElementById('settingsLollmsModelSelect');
        const saveModelAndVectorizerBtn = document.getElementById('saveModelAndVectorizerBtn');
        const settingsTemperature = document.getElementById('settingsTemperature');
        const settingsTopK = document.getElementById('settingsTopK');
        const settingsTopP = document.getElementById('settingsTopP');
        const settingsRepeatPenalty = document.getElementById('settingsRepeatPenalty');
        const settingsRepeatLastN = document.getElementById('settingsRepeatLastN');
        const saveLLMParamsBtn = document.getElementById('saveLLMParamsBtn');
        const settingsStatus_llmConfig = document.getElementById('settingsStatus_llmConfig'); 
        const settingsStatus_llmParams = document.getElementById('settingsStatus_llmParams'); 
        const settingsCurrentPassword = document.getElementById('settingsCurrentPassword');
        const settingsNewPassword = document.getElementById('settingsNewPassword');
        const settingsConfirmPassword = document.getElementById('settingsConfirmPassword');
        const changePasswordBtn = document.getElementById('changePasswordBtn');
        const passwordChangeStatus = document.getElementById('passwordChangeStatus');

        const dataStoresModal = document.getElementById('dataStoresModal');
        const createDataStoreForm = document.getElementById('createDataStoreForm');
        const newDataStoreNameInput = document.getElementById('newDataStoreName');
        const newDataStoreDescriptionInput = document.getElementById('newDataStoreDescription');
        const createDataStoreStatus = document.getElementById('createDataStoreStatus');
        const ownedDataStoresList = document.getElementById('ownedDataStoresList');
        const sharedDataStoresList = document.getElementById('sharedDataStoresList');
        const shareDataStoreModal = document.getElementById('shareDataStoreModal');
        const shareDataStoreTitle = document.getElementById('shareDataStoreTitle');
        const shareTargetUsernameDSInput = document.getElementById('shareTargetUsernameDS');
        const confirmShareDataStoreBtn = document.getElementById('confirmShareDataStoreBtn');
        const shareDataStoreStatus = document.getElementById('shareDataStoreStatus');
        const shareDataStoreIdInput = document.getElementById('shareDataStoreIdInput');
        const fileManagementModal = document.getElementById('fileManagementModal');
        const fileManagerDataStoreName = document.getElementById('fileManagerDataStoreName');
        const fileManagerCurrentDataStoreId = document.getElementById('fileManagerCurrentDataStoreId');
        const fileVectorizerSelect = document.getElementById('fileVectorizerSelect');
        const fileUploadInputFS = document.getElementById('fileUploadInputFS'); 
        const confirmUploadBtn = document.getElementById('confirmUploadBtn');
        const uploadStatus = document.getElementById('uploadStatus');
        const indexedFileList = document.getElementById('indexedFileList');
        const fileListStatus = document.getElementById('fileListStatus');
        const imageViewerModal = document.getElementById('imageViewerModal');
        const imageViewerSrc = document.getElementById('imageViewerSrc');

        // --- Localization Functions ---
        function translate(key, fallback = null, vars = {}) {
            let translation = currentTranslations[key];
            if (translation === undefined) {
                // Try to find a more generic version if specific one not found (e.g., placeholder_key.specific -> placeholder_key)
                const parts = key.split('.');
                if (parts.length > 1) {
                    parts.pop();
                    const genericKey = parts.join('.');
                    if (currentTranslations && currentTranslations[genericKey]) {
                         console.warn(`Translation for "${key}" not found, using generic "${genericKey}".`);
                         translation = currentTranslations[genericKey];
                    }
                }
            }

            if (translation === undefined) {
                console.warn(`Translation for "${key}" not found.`);
                return fallback !== null ? fallback : key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            }

            // Replace variables
            for (const varKey in vars) {
                translation = translation.replace(new RegExp(`{{${varKey}}}`, 'g'), vars[varKey]);
            }
            return translation;
        }

        function updateUIText() {
            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.dataset.translateKey;
                const fallback = el.textContent; // Use current text as fallback initially
                if (el.dataset.translateAttr) {
                    const attr = el.dataset.translateAttr;
                     if (el.tagName === 'INPUT' && attr === 'placeholder' || el.tagName === 'TEXTAREA' && attr === 'placeholder') {
                         el.placeholder = translate(key, el.placeholder);
                     } else if (attr === 'title') {
                         el.title = translate(key, el.title);
                     } else {
                         el.setAttribute(attr, translate(key, el.getAttribute(attr)));
                     }
                } else if (el.dataset.translateAlt) {
                     el.alt = translate(key, el.alt);
                }
                else {
                    // Preserve child nodes for elements like buttons with SVGs
                    if (el.childNodes.length > 1 && Array.from(el.childNodes).some(n => n.nodeType === Node.ELEMENT_NODE)) {
                        const textNode = Array.from(el.childNodes).find(n => n.nodeType === Node.TEXT_NODE && n.textContent.trim() !== '');
                        if (textNode) {
                            textNode.textContent = translate(key, fallback);
                        } else { // If complex structure, look for a span with the key
                            const span = el.querySelector(`span[data-translate-key="${key}"]`);
                            if (span) span.textContent = translate(key, fallback);
                            else el.textContent = translate(key, fallback); // Fallback to full replace
                        }
                    } else {
                         el.textContent = translate(key, fallback);
                    }
                }
            });
            
            // For dynamically generated content, ensure their render functions use translate()
            renderDiscussionList(); // Re-renders discussion list items with translated text
            if (currentDiscussionId && discussions[currentDiscussionId]) { // If a discussion is selected
                discussionTitle.textContent = discussions[currentDiscussionId].title; // Titles are user-generated, not translated
            } else {
                 discussionTitle.textContent = translate('default_discussion_title');
            }
            // Update RAG button title based on state
            updateRagToggleButtonState();
            // Update current messages if any
            if (currentMessages.length > 0) {
                renderMessages(currentMessages);
            } else if (!currentDiscussionId) {
                 chatMessages.innerHTML = `<div class="text-center text-gray-500 italic mt-10">${translate('chat_area_empty_placeholder')}</div>`;
            } else {
                 chatMessages.innerHTML = `<p class="text-gray-500 text-center italic mt-10">${translate('chat_area_loading_messages')}</p>`;
            }
        }
        // Helper function 3: updateUIWithTranslations
        function updateUIWithTranslations() {
            console.log("Updating UI with translations. Current translations:", currentTranslations);
            document.querySelectorAll('[data-translate-key]').forEach(element => {
                const key = element.getAttribute('data-translate-key');
                const fallback = element.dataset.fallback || element.textContent;
                element.textContent = translate(key, fallback);
            });
            const titleElement = document.querySelector('title[data-translate-key]');
            if (titleElement) {
                 document.title = translate(titleElement.getAttribute('data-translate-key'), 'App');
            }
        }        
        // Load a specific language
        async function loadLanguage(langCode) {
            appLoadingStatus.textContent = translate('app_loading_status_loading_language', `Loading ${langCode}...`);
            try {
                // Fetch from the correct, prefixed path
                const response = await apiRequest(`/api/languages/locals/${langCode}.json`);
                currentTranslations = await response.json();
                localStorage.setItem('preferredLang', langCode);
                languageSelector.value = langCode; // Ensure selector reflects loaded language
                updateUIWithTranslations();
                appLoadingStatus.textContent = translate('app_loading_status_ready', "Ready.");
            } catch (error) {
                console.error(`Failed to load language ${langCode}:`, error);
                currentTranslations = {}; // Clear translations on error
                updateUIWithTranslations(); // Attempt to revert to keys/fallbacks
                appLoadingStatus.textContent = translate('app_loading_status_error_loading_language', `Error loading ${langCode}.`);
                // Optionally load a default language like 'en' on error
                // if (langCode !== 'en') await loadLanguage('en');
            }
        }

        // Initialize localization
        async function initializeLocalization() {
            // Set initial status text before full translation system is up
            appLoadingStatus.textContent = "Localizing..."; 
            
            try {
                // Fetch from the corrected "/api/languages" (which becomes "/api/languages/" due to router prefix)
                const response = await apiRequest('/api/languages/'); 
                availableLanguages = await response.json();
            } catch (e) {
                console.warn("Could not fetch available languages, using predefined English:", e);
                availableLanguages = { 'en': 'English' }; // Fallback
            }

            languageSelector.innerHTML = ''; // Clear previous options
            for (const code in availableLanguages) {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = availableLanguages[code];
                languageSelector.appendChild(option);
            }

            languageSelector.addEventListener('change', (e) => {
                loadLanguage(e.target.value);
            });

            let langToLoad = localStorage.getItem('preferredLang');
            if (!langToLoad || !availableLanguages[langToLoad]) {
                const browserLang = navigator.language.split('-')[0]; // e.g., "en" from "en-US"
                if (availableLanguages[browserLang]) {
                    langToLoad = browserLang;
                } else {
                    // Check for full browser language code (e.g., "en-US") if base not found
                    const fullBrowserLang = navigator.language;
                    if (availableLanguages[fullBrowserLang]) {
                         langToLoad = fullBrowserLang;
                    } else {
                        langToLoad = 'en'; // Ultimate default
                        if (!availableLanguages['en']) { // If even 'en' is not in available list (e.g. error response)
                            const firstAvailable = Object.keys(availableLanguages)[0];
                            if(firstAvailable) langToLoad = firstAvailable;
                            else { // No languages at all, critical error
                                appLoadingStatus.textContent = "No languages available.";
                                return;
                            }
                        }
                    }
                }
            }
            
            // Initial load
            await loadLanguage(langToLoad); 
            // The loadLanguage function will set languageSelector.value and update status text
        }

        // --- API Helper ---
        async function apiRequest(url, options = {}) {
            if (!options.statusElement) showStatus('');
            const fetchOptions = { ...options };
            fetchOptions.headers = { ...fetchOptions.headers };
            if (tempLoginUsername && tempLoginPassword && !fetchOptions.headers['Authorization']) {
                const basicAuth = btoa(`${tempLoginUsername}:${tempLoginPassword}`);
                fetchOptions.headers['Authorization'] = `Basic ${basicAuth}`;
            }
            try {
                const response = await fetch(url, fetchOptions);
                if (!response.ok) {
                    let errorDetail = `HTTP error ${response.status}`;
                    try { const errorData = await response.json(); errorDetail = errorData.detail || errorDetail; } catch (e) { /* Ignore */ }
                    const errorMsg = translate('api_error_prefix', "API Error:") + ` ${errorDetail}`;
                    showStatus(errorMsg, "error", options.statusElement || statusMessage);
                    const error = new Error(errorMsg); error.status = response.status; throw error;
                }
                if (response.status === 204) return null;
                return response;
            } catch (error) {
                console.error("API Request Error:", url, fetchOptions, error);
                if (!error.status) showStatus(translate('api_request_failed_prefix', "Request failed:") + ` ${error.message}`, "error", options.statusElement || statusMessage);
                throw error;
            } finally {
                if (url === '/api/auth/me' && fetchOptions.headers['Authorization'] && fetchOptions.headers['Authorization'].startsWith('Basic')) {
                    tempLoginUsername = null; tempLoginPassword = null;
                }
            }
        }

        // --- Initialization ---
        window.onload = async () => {
            marked.setOptions({
                highlight: function(code, lang) {
                    const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                    try {
                        return hljs.highlight(code, { language, ignoreIllegals: true }).value;
                    } catch (e) {
                        console.error("Highlight.js error:", e, "Lang:", lang, "Code snippet:", code.substring(0,100));
                        return hljs.highlight(code, { language: 'plaintext', ignoreIllegals: true }).value;
                    }
                },
                gfm: true,
                breaks: true
            });
            hljs.configure({ ignoreUnescapedHTML: true });

            await initializeLocalization(); // Load language first
            await attemptInitialAuthAndLoad();
            imageUploadInput.addEventListener('change', handleImageFileSelection);
            
            const settingsTabButtons = document.querySelectorAll('#settingsModal .settings-tab-btn');
            settingsTabButtons.forEach(button => {
                button.addEventListener('click', () => handleSettingsTabSwitch(button.dataset.tab));
            });

            userMenuToggleBtn.addEventListener('click', toggleUserMenu);
            document.addEventListener('click', handleClickOutsideUserMenu);
            discussionSearchInput.addEventListener('input', renderDiscussionList);
        };

        async function attemptInitialAuthAndLoad() {
            appLoadingStatus.textContent = translate('app_loading_status_authenticating', "Authenticating...");
            try {
                const response = await apiRequest('/api/auth/me');
                currentUser = await response.json();
                loginModal.classList.remove('active');
                appContainer.style.display = 'flex';
                appLoadingMessage.style.display = 'none';
                await initializeAppContent();
            } catch (error) {
                if (error.status === 401) {
                    appLoadingMessage.style.display = 'none';
                    showStatus(translate('login_failed_or_required_status', "Login failed or required."), "error", loginStatus);
                    openModal('loginModal', false);
                    loginUsernameInput.focus();
                } else {
                    appLoadingStatus.textContent = translate('initialization_failed_status', `Initialization failed: ${error.message}. Please refresh.`, { message: error.message });
                    appLoadingStatus.classList.add('text-red-600');
                }
            }
        }

        async function initializeAppContent() {
            appLoadingStatus.textContent = translate('app_loading_status_user_data', "Loading user data...");
            usernameDisplay.textContent = currentUser.username;
            userDefaultVectorizer = currentUser.safe_store_vectorizer; 

            if (currentUser.is_admin) {
                adminBadge.style.display = 'inline-block';
                adminLink.style.display = 'flex';
            } else {
                adminBadge.style.display = 'none';
                adminLink.style.display = 'none';
            }

            appLoadingStatus.textContent = translate('app_loading_status_discussions_stores', "Loading discussions & data stores...");
            await Promise.all([
                loadDiscussions(),
                loadDataStores() 
            ]);
            
            appLoadingStatus.textContent = translate('app_loading_status_models_vectorizers', "Loading models and vectorizers...");
            await loadAvailableLollmsModels(); 

            updateRagToggleButtonState(); 

            confirmRenameBtn.onclick = confirmInlineRename;
            confirmSendDiscussionBtn.onclick = confirmSendDiscussion;
            confirmEditMessageBtn.onclick = confirmMessageEdit;
            logoutBtn.onclick = handleLogout;
            loginSubmitBtn.onclick = handleLoginAttempt;
            loginPasswordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLoginAttempt(); });
            
            createDataStoreForm.addEventListener('submit', handleCreateDataStore);
            changePasswordBtn.onclick = handleChangePassword;

            showStatus(translate('status_ready', 'Ready.'), 'success');
            updateUIText(); // Final pass to ensure all is translated after data load
        }

        // --- User Menu Logic ---
        function toggleUserMenu() {
            const isHidden = userMenuDropdown.style.display === 'none' || userMenuDropdown.style.display === '';
            userMenuDropdown.style.display = isHidden ? 'block' : 'none';
            userMenuArrow.classList.toggle('rotate-180', isHidden);
        }

        function handleClickOutsideUserMenu(event) {
            if (userMenuDropdown.style.display === 'block' &&
                !userMenuToggleBtn.contains(event.target) &&
                !userMenuDropdown.contains(event.target)) {
                userMenuDropdown.style.display = 'none';
                userMenuArrow.classList.remove('rotate-180');
            }
        }

        // --- Login and Logout ---
        async function handleLoginAttempt() {
            const username = loginUsernameInput.value.trim(); const password = loginPasswordInput.value;
            if (!username || !password) { showStatus(translate('login_username_password_required', "Username and password are required."), "error", loginStatus); return; }
            showStatus(translate('login_attempting_status', "Attempting login..."), "info", loginStatus); loginSubmitBtn.disabled = true;
            tempLoginUsername = username; tempLoginPassword = password;
            try { await attemptInitialAuthAndLoad(); }
            catch (error) {
                if (error.status === 401) showStatus(translate('login_invalid_credentials', "Invalid username or password."), "error", loginStatus);
                else showStatus(translate('login_error_status', `Login error: ${error.message}`, { message: error.message }), "error", loginStatus);
            } finally { loginSubmitBtn.disabled = false; }
        }

        async function handleLogout() {
            showStatus(translate('logout_status_logging_out', "Logging out..."), "info");
            try { await apiRequest('/api/auth/logout', { method: 'POST' }); }
            catch (error) { 
                console.warn("Logout API call failed:", error); 
                showStatus(translate('logout_server_failed_status', "Logout from server failed, but resetting UI."), "warning"); 
            }
            finally {
                currentUser = null; discussions = {}; currentMessages = []; currentDiscussionId = null;
                aiMessageStreaming = false; currentAiMessageElement = null; currentAiMessageContent = ""; currentAiMessageId = null;
                isRagActive = false; uploadedImageServerPaths = [];
                ownedDataStores = []; sharedDataStores = []; availableDataStoresForRag = [];

                usernameDisplay.textContent = translate('username_display_default'); 
                adminBadge.style.display = 'none'; adminLink.style.display = 'none';
                discussionListContainer.innerHTML = `<p class="text-gray-500 text-sm text-center italic p-4">${translate('login_required_placeholder')}</p>`;
                clearChatArea(true); sendMessageBtn.disabled = true; messageInput.value = ''; autoGrowTextarea(messageInput);
                ragToggleBtn.classList.remove('rag-toggle-on'); ragToggleBtn.classList.add('rag-toggle-off');
                ragDataStoreSelect.style.display = 'none'; 
                ragDataStoreSelect.innerHTML = `<option value="">${translate('rag_select_default_option')}</option>`;
                imageUploadPreviewContainer.innerHTML = ''; imageUploadPreviewContainer.style.display = 'none';
                updateRagToggleButtonState();
                userMenuDropdown.style.display = 'none'; userMenuArrow.classList.remove('rotate-180');

                appContainer.style.display = 'none'; appLoadingMessage.style.display = 'none';
                showStatus('', 'info', statusMessage); showStatus('', 'info', pyodideStatus);
                loginUsernameInput.value = ''; loginPasswordInput.value = ''; loginSubmitBtn.disabled = false;
                showStatus(translate('logout_success_status', "You have been logged out."), "info", loginStatus);
                openModal('loginModal', false); loginUsernameInput.focus();
            }
        }

        // --- Modal Management ---
        function openModal(modalId, allowOverlayClose = true) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
                if (modalId === 'loginModal') { modal.dataset.allowOverlayClose = allowOverlayClose.toString(); loginUsernameInput.focus(); }
                else if (modalId === 'settingsModal') { populateSettingsModal(); userMenuDropdown.style.display = 'none'; userMenuArrow.classList.remove('rotate-180');}
                else if (modalId === 'dataStoresModal') { populateDataStoresModal(); userMenuDropdown.style.display = 'none'; userMenuArrow.classList.remove('rotate-180');}
                else if (modalId === 'exportModal') { populateExportModal(); userMenuDropdown.style.display = 'none'; userMenuArrow.classList.remove('rotate-180');}
                else if (modalId === 'importModal') { userMenuDropdown.style.display = 'none'; userMenuArrow.classList.remove('rotate-180');}
                if (modalId === 'renameModal' && renameInput) renameInput.focus();
                if (modalId === 'sendDiscussionModal' && sendTargetUsernameInput) sendTargetUsernameInput.focus();
                if (modalId === 'editMessageModal' && editMessageInput) editMessageInput.focus();
                if (modalId === 'shareDataStoreModal' && shareTargetUsernameDSInput) shareTargetUsernameDSInput.focus();
            }
        }
        function closeModal(modalId) {
            const modal = document.getElementById(modalId); if (modal) modal.classList.remove('active');
            const statusElement = document.getElementById(modalId.replace('Modal', 'Status')); if (statusElement) showStatus('', 'info', statusElement);
            if (modalId === 'renameModal') renameDiscussionIdInput.value = '';
            if (modalId === 'sendDiscussionModal') { sendDiscussionIdInput.value = ''; sendTargetUsernameInput.value = ''; }
            if (modalId === 'editMessageModal') editMessageIdInput.value = '';
            if (modalId === 'shareDataStoreModal') { shareDataStoreIdInput.value = ''; shareTargetUsernameDSInput.value = '';}
        }
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (event) => {
                const allowClose = modal.dataset.allowOverlayClose !== 'false';
                if (event.target === modal && allowClose) closeModal(modal.id);
            });
        });

        // --- Discussion Management ---
        async function loadDiscussions() {
            try {
                const response = await apiRequest('/api/discussions');
                const loadedDiscussions = await response.json();
                discussions = {}; 
                loadedDiscussions.forEach(d => {
                    discussions[d.id] = { 
                        id: d.id, title: d.title, is_starred: d.is_starred,
                        rag_datastore_id: d.rag_datastore_id, messages_loaded_fully: false,
                        last_activity_at: d.last_activity_at || d.created_at || `1970-01-01T00:00:00Z`
                    };
                });
                renderDiscussionList();
                if (currentDiscussionId && discussions[currentDiscussionId]) {
                    selectDiscussion(currentDiscussionId); 
                } else if (currentDiscussionId) { 
                    clearChatArea(); currentDiscussionId = null;
                }
            } catch (error) {
                console.error("Failed to load discussions:", error);
                discussionListContainer.innerHTML = `<p class="text-red-500 text-sm text-center p-4">${translate('failed_to_load_discussions_error')}</p>`;
            }
        }

        function createDiscussionItemElement(d) {
            const item = document.createElement('div');
            item.className = `relative discussion-item p-2 rounded cursor-pointer hover:bg-gray-100 flex justify-between items-center text-sm transition-colors duration-150 ${d.id === currentDiscussionId ? 'bg-blue-100 font-medium text-blue-800' : 'text-gray-700'}`;
            item.dataset.id = d.id; item.onclick = () => selectDiscussion(d.id);

            const titleSpan = document.createElement('span');
            titleSpan.textContent = d.title || translate('untitled_discussion_prefix', `Discussion ${d.id.substring(0, 6)}`, {id_short: d.id.substring(0,6)});
            titleSpan.className = 'truncate mr-2 flex-1'; // Removed pr-20, let flex handle spacing

            const controlsDiv = document.createElement('div');
            // controlsDiv.className = 'flex items-center flex-shrink-0 space-x-1'; // Added space-x-1 for items within controls
            controlsDiv.className = 'flex items-center flex-shrink-0';


            // Action buttons (send, rename, delete) - will be shown on hover
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'discussion-item-actions flex items-center'; // Keep flex, remove absolute positioning from JS, handle via CSS
            // Note: The 'discussion-item-actions' class in CSS will still handle initial 'display: none' and 'display: flex' on hover.

            const sendBtn = document.createElement('button');
            sendBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" /></svg>`;
            sendBtn.title = translate('send_discussion_tooltip'); sendBtn.className = 'discussion-action-btn p-1 hover:bg-gray-200 rounded'; // Added padding & rounding like star
            sendBtn.onclick = (e) => { e.stopPropagation(); initiateSendDiscussion(d.id); };
            actionsDiv.appendChild(sendBtn);

            const renameBtn = document.createElement('button');
            renameBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" /></svg>`;
            renameBtn.title = translate('rename_discussion_tooltip'); renameBtn.className = 'discussion-action-btn p-1 hover:bg-gray-200 rounded'; // Added padding & rounding
            renameBtn.onclick = (e) => { e.stopPropagation(); initiateInlineRename(d.id); };
            actionsDiv.appendChild(renameBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-red-500"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12.508 0A48.067 48.067 0 0 1 7.8 5.397m7.454 0M12 10.75h.008v.008H12v-.008Z" /></svg>`;
            deleteBtn.title = translate('delete_discussion_tooltip'); deleteBtn.className = 'discussion-action-btn p-1 hover:bg-red-100 rounded'; // Added padding & rounding
            deleteBtn.onclick = (e) => { e.stopPropagation(); deleteInlineDiscussion(d.id); };
            actionsDiv.appendChild(deleteBtn);
            
            // Star button - now appears after the action buttons in the DOM order
            const starSpan = document.createElement('span');
            // starSpan.className = 'star-action-button p-1 hover:bg-gray-200 rounded-full'; // Removed 'mr-1' as space-x will handle it
            starSpan.className = 'p-1 hover:bg-gray-200 rounded-full'; // star-action-button class for z-index is no longer needed if actions aren't absolute
            starSpan.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" stroke-width="1.5" stroke="none" class="w-4 h-4 star-icon ${d.is_starred ? 'starred' : ''} transition-colors duration-150"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-2.885a.562.562 0 0 0-.586 0L6.982 21.1a.562.562 0 0 1-.84-.61l1.285-5.386a.562.562 0 0 0-.182-.557l-4.204-3.602a.562.562 0 0 1 .321-.988l5.518-.442a.563.563 0 0 0 .475-.345L11.48 3.5Z" /></svg>`;
            starSpan.title = d.is_starred ? translate('unstar_discussion_tooltip') : translate('star_discussion_tooltip');
            starSpan.onclick = (e) => { e.stopPropagation(); toggleStarDiscussion(d.id, d.is_starred); };

            // Add actionDiv first, then starSpan to controlsDiv
            controlsDiv.appendChild(actionsDiv); // Actions appear first visually if on left
            controlsDiv.appendChild(starSpan);  // Star appears to the right of actions

            item.appendChild(titleSpan);
            item.appendChild(controlsDiv);
            return item;
        }

        function renderDiscussionList() {
            discussionListContainer.innerHTML = ''; 
            const searchTerm = discussionSearchInput.value.toLowerCase();

            const allDiscussionValues = Object.values(discussions);
            
            const filteredDiscussions = searchTerm 
                ? allDiscussionValues.filter(d => (d.title || '').toLowerCase().includes(searchTerm))
                : allDiscussionValues;

            const starredDiscussions = filteredDiscussions.filter(d => d.is_starred);
            const regularDiscussions = filteredDiscussions.filter(d => !d.is_starred);

            const sortByDateDesc = (a, b) => {
                const dateA = new Date(a.last_activity_at || 0);
                const dateB = new Date(b.last_activity_at || 0);
                if (dateB - dateA !== 0) return dateB - dateA;
                const idA = a.id.split('-').pop(); 
                const idB = b.id.split('-').pop();
                if (!isNaN(idA) && !isNaN(idB) && parseInt(idB) - parseInt(idA) !==0) return parseInt(idB) - parseInt(idA);
                return (a.title || '').localeCompare(b.title || '');
            };
            
            starredDiscussions.sort(sortByDateDesc);
            regularDiscussions.sort(sortByDateDesc);

            if (filteredDiscussions.length === 0) {
                discussionListContainer.innerHTML = `<p class="text-gray-500 text-sm text-center italic p-4">${searchTerm ? translate('no_discussions_match_search') : translate('no_discussions_yet')}</p>`;
                return;
            }

            if (starredDiscussions.length > 0) {
                const starredSection = document.createElement('div');
                starredSection.id = 'starredDiscussionsSection';
                const starredHeader = document.createElement('h3');
                starredHeader.className = 'discussion-section-header';
                starredHeader.textContent = translate('discussion_section_starred');
                starredSection.appendChild(starredHeader);
                const starredListDiv = document.createElement('div');
                starredListDiv.className = 'space-y-1';
                starredDiscussions.forEach(d => starredListDiv.appendChild(createDiscussionItemElement(d)));
                starredSection.appendChild(starredListDiv);
                discussionListContainer.appendChild(starredSection);
            } else if (searchTerm && allDiscussionValues.some(d => d.is_starred)) {
                const starredSection = document.createElement('div');
                const starredHeader = document.createElement('h3');
                starredHeader.className = 'discussion-section-header';
                starredHeader.textContent = translate('discussion_section_starred');
                starredSection.appendChild(starredHeader);
                starredSection.innerHTML += `<p class="text-gray-500 text-xs text-center italic p-2">${translate('no_starred_discussions_match_search')}</p>`;
                discussionListContainer.appendChild(starredSection);
            }

            const regularSection = document.createElement('div');
            regularSection.id = 'regularDiscussionsSection';
            if (starredDiscussions.length > 0) regularSection.classList.add('mt-3'); 

            const regularHeader = document.createElement('h3');
            regularHeader.className = 'discussion-section-header';
            regularHeader.textContent = translate('discussion_section_recent');
            regularSection.appendChild(regularHeader);

            const regularListDiv = document.createElement('div');
            regularListDiv.className = 'space-y-1';
            if (regularDiscussions.length > 0) {
                regularDiscussions.forEach(d => regularListDiv.appendChild(createDiscussionItemElement(d)));
            } else {
                 regularListDiv.innerHTML = `<p class="text-gray-500 text-xs text-center italic p-2">${searchTerm ? translate('no_other_discussions_match_search') : translate('no_other_discussions')}</p>`;
            }
            regularSection.appendChild(regularListDiv);
            discussionListContainer.appendChild(regularSection);
        }

        newDiscussionBtn.onclick = async () => {
            showStatus(translate('status_creating_discussion', 'Creating new discussion...'), 'info');
            try {
                const response = await apiRequest('/api/discussions', { method: 'POST' });
                const newDiscussion = await response.json();
                discussions[newDiscussion.id] = { 
                    id: newDiscussion.id, title: newDiscussion.title, is_starred: newDiscussion.is_starred,
                    rag_datastore_id: newDiscussion.rag_datastore_id, messages_loaded_fully: true,
                    last_activity_at: newDiscussion.last_activity_at || newDiscussion.created_at || new Date().toISOString()
                };
                renderDiscussionList();
                selectDiscussion(newDiscussion.id);
                showStatus(translate('status_new_discussion_created', 'New discussion created.'), 'success');
            } catch (error) { console.error("Failed to create discussion:", error); }
        };
        async function selectDiscussion(id) {
            if (!discussions[id] || aiMessageStreaming) return;
            currentDiscussionId = id;
            const discussionData = discussions[id];
            discussionTitle.textContent = discussionData.title; // User-generated, not translated
            sendMessageBtn.disabled = false;
            renderDiscussionList(); 
            clearChatArea(false);
            chatMessages.innerHTML = `<p class="text-gray-500 text-center italic mt-10">${translate('chat_area_loading_messages')}</p>`;
            
            isRagActive = discussionData.rag_datastore_id !== null && discussionData.rag_datastore_id !== "";
            updateRagToggleButtonState(); 
            if(isRagActive && discussionData.rag_datastore_id) {
                ragDataStoreSelect.value = discussionData.rag_datastore_id;
            } else if (availableDataStoresForRag.length > 0) { 
                ragDataStoreSelect.value = ""; 
            }

            try {
                const response = await apiRequest(`/api/discussions/${id}`);
                const loadedMessages = await response.json();
                currentMessages = loadedMessages;
                discussions[id].messages_loaded_fully = true;
                
                if (loadedMessages.length > 0) {
                    const lastMessage = loadedMessages[loadedMessages.length -1];
                    if (lastMessage.created_at && new Date(lastMessage.created_at) > new Date(discussions[id].last_activity_at)) {
                        discussions[id].last_activity_at = lastMessage.created_at;
                        renderDiscussionList(); 
                    }
                }
                renderMessages(currentMessages);
            } catch (error) {
                 console.error(`Failed to load messages for ${id}:`, error);
                 chatMessages.innerHTML = `<p class="text-red-500 text-center mt-10">${translate('chat_area_error_loading_messages')}</p>`;
            }
        }
        function initiateInlineRename(id) {
            if (!discussions[id]) return;
            renameDiscussionIdInput.value = id; renameInput.value = discussions[id].title;
            showStatus('', 'info', renameStatus); openModal('renameModal');
        }
        async function confirmInlineRename() {
             const idToRename = renameDiscussionIdInput.value; if (!idToRename || !discussions[idToRename]) return;
             const newTitle = renameInput.value.trim(); if (!newTitle) { showStatus(translate('rename_title_empty_error'), 'error', renameStatus); return; }
             showStatus(translate('status_renaming', 'Renaming...'), 'info', renameStatus);
             try {
                 const response = await apiRequest(`/api/discussions/${idToRename}/title`, {
                     method: 'PUT', headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify({ title: newTitle }), statusElement: renameStatus
                 });
                 const updatedInfo = await response.json();
                 discussions[idToRename].title = updatedInfo.title;
                 discussions[idToRename].last_activity_at = updatedInfo.last_activity_at || new Date().toISOString();
                 if (idToRename === currentDiscussionId) discussionTitle.textContent = updatedInfo.title;
                 renderDiscussionList(); showStatus(translate('status_renamed_success', 'Renamed successfully.'), 'success', renameStatus);
                 setTimeout(() => closeModal('renameModal'), 1000);
             } catch (error) { console.error("Rename failed:", error); }
        }
        function initiateSendDiscussion(id) {
            if (!discussions[id]) return;
            sendDiscussionIdInput.value = id;
            document.getElementById('sendDiscussionModal').querySelector('.modal-title').textContent = translate('send_discussion_modal_title', `Send Discussion: "${discussions[id].title}"`, {title: discussions[id].title});
            sendTargetUsernameInput.value = '';
            showStatus('', 'info', sendDiscussionStatus);
            openModal('sendDiscussionModal');
        }
        async function confirmSendDiscussion() {
            const discussionId = sendDiscussionIdInput.value;
            const targetUsername = sendTargetUsernameInput.value.trim();
            if (!discussionId || !targetUsername) {
                showStatus(translate('send_discussion_target_user_required'), 'error', sendDiscussionStatus);
                return;
            }
            showStatus(translate('status_sending_discussion_to_user', `Sending discussion to ${targetUsername}...`, {username: targetUsername}), 'info', sendDiscussionStatus);
            try {
                await apiRequest(`/api/discussions/${discussionId}/send`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target_username: targetUsername }),
                    statusElement: sendDiscussionStatus
                });
                showStatus(translate('status_discussion_sent_success', 'Discussion sent successfully!'), 'success', sendDiscussionStatus);
                setTimeout(() => closeModal('sendDiscussionModal'), 1500);
            } catch (error) {
                console.error("Send discussion failed:", error);
            }
        }
        async function deleteInlineDiscussion(id) {
             if (!discussions[id]) return;
             if (confirm(translate('confirm_delete_discussion', `Are you sure you want to delete discussion "${discussions[id].title}"? This cannot be undone.`, {title: discussions[id].title}))) {
                 showStatus(translate('status_deleting_discussion', 'Deleting discussion...'), 'info');
                 try {
                     await apiRequest(`/api/discussions/${id}`, { method: 'DELETE' });
                     delete discussions[id];
                     if (id === currentDiscussionId) { currentDiscussionId = null; clearChatArea(true); }
                     renderDiscussionList(); showStatus(translate('status_discussion_deleted', `Discussion deleted.`), 'success');
                 } catch (error) { console.error("Delete failed:", error); }
             }
        }
        async function toggleStarDiscussion(id, isCurrentlyStarred) {
             const method = isCurrentlyStarred ? 'DELETE' : 'POST';
             try {
                const response = await apiRequest(`/api/discussions/${id}/star`, { method: method });
                const updatedInfo = await response.json();
                discussions[id].is_starred = updatedInfo.is_starred; 
                discussions[id].last_activity_at = updatedInfo.last_activity_at || discussions[id].last_activity_at;
                renderDiscussionList();
             } catch (error) { showStatus(translate(isCurrentlyStarred ? 'status_unstar_failed' : 'status_star_failed', `Failed to ${isCurrentlyStarred ? 'unstar' : 'star'} discussion.`), 'error'); }
        }


        // --- Chat Interaction ---
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
            autoGrowTextarea(messageInput);
        });
        messageInput.addEventListener('input', () => {
            autoGrowTextarea(messageInput);
            sendMessageBtn.disabled = !(messageInput.value.trim() || uploadedImageServerPaths.length > 0) || aiMessageStreaming;
        });
        sendMessageBtn.onclick = sendMessage;
        function autoGrowTextarea(element) { 
            element.style.height = 'auto'; const maxHeight = 200;
            element.style.height = Math.min(element.scrollHeight, maxHeight) + 'px';
            element.style.overflowY = element.scrollHeight > maxHeight ? 'auto' : 'hidden';
        }
        async function sendMessage() {
            if (aiMessageStreaming || !currentDiscussionId) return;
            const prompt = messageInput.value.trim();
            if (!prompt && uploadedImageServerPaths.length === 0) return; 

            const userMessageData = {
                id: `temp-user-${Date.now()}`, sender: translate(currentUser.lollms_client_ai_name ? 'sender_you' : (currentUser.username || 'sender_user'), 'User'),
                content: prompt, user_grade: 0, token_count: null, model_name: null,
                image_references: uploadedImageServerPaths.map(img => URL.createObjectURL(img.file_obj)) 
            };
            renderMessage(userMessageData); 
            
            const formData = new FormData();
            formData.append('prompt', prompt);
            formData.append('image_server_paths_json', JSON.stringify(uploadedImageServerPaths.map(img => img.server_path)));
            formData.append('use_rag', isRagActive);
            if(isRagActive && discussions[currentDiscussionId] && discussions[currentDiscussionId].rag_datastore_id) {
                formData.append('rag_datastore_id', discussions[currentDiscussionId].rag_datastore_id);
            }
            
            messageInput.value = ''; uploadedImageServerPaths = [];
            imageUploadPreviewContainer.innerHTML = ''; imageUploadPreviewContainer.style.display = 'none';
            autoGrowTextarea(messageInput); sendMessageBtn.disabled = true; scrollChatToBottom();

            aiMessageStreaming = true; currentAiMessageContent = ""; currentAiMessageElement = null; currentAiMessageId = `temp-ai-${Date.now()}`;
            discussions[currentDiscussionId].last_activity_at = new Date().toISOString();
            renderDiscussionList(); 

            try {
                 const response = await fetch(`/api/discussions/${currentDiscussionId}/chat`, { method: 'POST', body: formData });
                 if (!response.ok || !response.body) {
                     const errorData = await response.json().catch(() => ({ detail: `HTTP error ${response.status}` }));
                     throw new Error(translate('chat_stream_start_error', `Error starting chat stream: ${errorData.detail || response.statusText}`, { detail: errorData.detail || response.statusText }));
                 }
                 const reader = response.body.getReader(); const decoder = new TextDecoder();
                 while (true) {
                     const { done, value } = await reader.read(); if (done) break;
                     const textChunk = decoder.decode(value, { stream: true });
                     const lines = textChunk.split('\n').filter(line => line.trim() !== '');
                     lines.forEach(line => {
                         try { handleStreamChunk(JSON.parse(line)); }
                         catch (e) { console.warn("Error parsing stream chunk:", line, e); renderMessage({ id: `warn-${Date.now()}`, sender: 'system', content: translate('malformed_data_chunk_error') }); }
                     });
                 }
                 handleStreamEnd();
             } catch (error) {
                 console.error("Chat stream error:", error); showStatus(translate('chat_stream_failed_error', `Chat stream failed: ${error.message}`, {message: error.message}), "error");
                 renderMessage({ id: `err-${Date.now()}`, sender: 'system', content: translate('stream_error_prefix', `Stream Error: ${error.message}`, {message: error.message}) });
                 handleStreamEnd(true);
             }
        }
        function handleStreamChunk(data) {
             if (data.type === 'chunk') {
                 if (!currentAiMessageElement) {
                     const aiMessage = { id: currentAiMessageId, sender: currentUser.lollms_client_ai_name || translate('sender_assistant', 'Assistant'), content: "", user_grade: 0, token_count: null, model_name: null, image_references: [] };
                     renderMessage(aiMessage); 
                 }
                 currentAiMessageContent += data.content;
                 const contentDiv = currentAiMessageElement?.querySelector('.message-content');
                 if (contentDiv) {
                    renderProcessedContent(contentDiv, currentAiMessageContent, currentAiMessageId); 
                 }
                 scrollChatToBottom();
             } else if (data.type === 'error') {
                 console.error("LLM Error:", data.content);
                 renderMessage({ id: `err-${Date.now()}`, sender: 'system', content: translate('llm_error_prefix', `LLM Error: ${data.content}`, {content: data.content}) });
                 handleStreamEnd(true);
             }
        }
        function handleStreamEnd(errorOccurred = false) { 
            aiMessageStreaming = false; 
            sendMessageBtn.disabled = !(messageInput.value.trim() || uploadedImageServerPaths.length > 0);
            if (currentDiscussionId) {
                refreshMessagesAfterStream();
            }
            scrollChatToBottom();
        }
        async function refreshMessagesAfterStream() {
            await new Promise(resolve => setTimeout(resolve, 500)); 
            if (!currentDiscussionId || aiMessageStreaming) return;
            try {
                const response = await apiRequest(`/api/discussions/${currentDiscussionId}`);
                const loadedMessages = await response.json();
                currentMessages = loadedMessages;

                if (loadedMessages.length > 0) {
                    const lastMessage = loadedMessages[loadedMessages.length - 1];
                    if (lastMessage.created_at) {
                        discussions[currentDiscussionId].last_activity_at = lastMessage.created_at;
                    }
                } else {
                     const discussionResponse = await apiRequest(`/api/discussions`);
                     const allDiscs = await discussionResponse.json();
                     const updatedDisc = allDiscs.find(d => d.id === currentDiscussionId);
                     if (updatedDisc && updatedDisc.last_activity_at) {
                         discussions[currentDiscussionId].last_activity_at = updatedDisc.last_activity_at;
                     }
                }
                renderMessages(currentMessages);
                renderDiscussionList();
            } catch (error) {
                 console.error(`Failed to refresh messages for ${currentDiscussionId}:`, error);
                 renderMessage({ id: `err-refresh-${Date.now()}`, sender: 'system', content: translate('refresh_message_list_failed_error') });
            }
        }


        // --- Message Rendering ---
        function clearChatArea(clearHeader = true) {
            chatMessages.innerHTML = '';
             if (clearHeader) {
                discussionTitle.textContent = translate('default_discussion_title');
                sendMessageBtn.disabled = true;
                ragToggleBtn.classList.remove('rag-toggle-on'); ragToggleBtn.classList.add('rag-toggle-off');
                ragDataStoreSelect.style.display = 'none'; ragDataStoreSelect.value = '';
                isRagActive = false; updateRagToggleButtonState();
             } else {
                // If not clearing header, means a discussion is selected or being loaded
                if (!currentDiscussionId) { // No discussion selected, show placeholder
                    chatMessages.innerHTML = `<div class="text-center text-gray-500 italic mt-10">${translate('chat_area_empty_placeholder')}</div>`;
                }
             }
            currentMessages = []; 
        }
        function renderMessages(messagesToRender) {
            chatMessages.innerHTML = ''; 
            if (messagesToRender.length === 0 && currentDiscussionId) {
                chatMessages.innerHTML = `<p class="text-gray-500 text-center italic mt-10">${translate('chat_area_no_messages_yet')}</p>`;
                return;
            }
            messagesToRender.forEach((msg, index) => {
                 msg.addSpacing = (index > 0 && messagesToRender[index-1].sender !== msg.sender);
                 renderMessage(msg);
            });
            scrollChatToBottom();
        }
        function renderMessage(message) {
             if (!message || typeof message.sender === 'undefined' || typeof message.content === 'undefined') {
                 console.warn("Skipping invalid message:", message); return;
             }
            const messageId = message.id || `temp-${Date.now()}`; const domId = `message-${messageId}`;
            
            let isUpdate = false;
            let existingBubbleDiv = document.getElementById(domId);
            if (existingBubbleDiv && messageId === currentAiMessageId && aiMessageStreaming) {
                isUpdate = true; 
            } else if (existingBubbleDiv) {
                existingBubbleDiv.closest('.message-container')?.remove();
                existingBubbleDiv = null; 
            }

            const messageContainer = existingBubbleDiv ? existingBubbleDiv.closest('.message-container') : document.createElement('div');
            if (!existingBubbleDiv) { 
                messageContainer.className = 'message-container flex flex-col';
                if (message.addSpacing) messageContainer.classList.add('mt-3');
            }

            let bubbleClass = 'ai-bubble'; let senderNameText = message.sender; let showGrade = false;
            const userNames = [currentUser.username, 'user', 'You', translate('sender_you', 'You'), translate('sender_user', 'User'), currentUser.lollms_client_ai_name ? null : currentUser.username];

            if (userNames.includes(senderNameText) || (message.sender === "User" && currentUser.username === "user")) { 
                bubbleClass = 'user-bubble'; senderNameText = '';
            } else if (senderNameText.toLowerCase() === 'system' || senderNameText.toLowerCase() === 'error') {
                bubbleClass = 'system-bubble'; senderNameText = '';
            } else {
                bubbleClass = 'ai-bubble'; senderNameText = currentUser.lollms_client_ai_name || message.sender || translate('sender_assistant', 'Assistant');
                showGrade = !messageId.startsWith('temp-');
            }

            const bubbleDiv = existingBubbleDiv || document.createElement('div');
            if (!existingBubbleDiv) { 
                bubbleDiv.className = `message-bubble ${bubbleClass}`; bubbleDiv.id = domId;
            }
            
            if (isUpdate && messageId !== currentAiMessageId) { 
                 bubbleDiv.innerHTML = ''; 
            } else if (!existingBubbleDiv) {
                 bubbleDiv.innerHTML = ''; 
            }

            if (senderNameText && (!existingBubbleDiv || !bubbleDiv.querySelector('.sender-name'))) { 
                const senderDiv = document.createElement('div');
                senderDiv.className = 'sender-name'; senderDiv.textContent = senderNameText;
                bubbleDiv.insertBefore(senderDiv, bubbleDiv.firstChild); 
            }

            let imagesContainer = bubbleDiv.querySelector('.message-images-container');
            if (message.image_references && message.image_references.length > 0) {
                if (!imagesContainer) {
                    imagesContainer = document.createElement('div');
                    imagesContainer.className = 'message-images-container';
                    bubbleDiv.appendChild(imagesContainer); 
                }
                imagesContainer.innerHTML = ''; 
                message.image_references.forEach(imgSrc => {
                    const imgItem = document.createElement('div');
                    imgItem.className = 'message-image-item';
                    const imgTag = document.createElement('img');
                    imgTag.src = imgSrc; 
                    imgTag.alt = translate('chat_image_alt', 'Chat Image');
                    imgTag.onclick = () => viewImage(imgSrc);
                    imgItem.appendChild(imgTag);
                    imagesContainer.appendChild(imgItem);
                });
            } else if (imagesContainer) {
                imagesContainer.remove(); 
            }

            let contentDiv = bubbleDiv.querySelector('.message-content');
            if (!contentDiv) {
                contentDiv = document.createElement('div');
                contentDiv.className = 'message-content prose prose-sm max-w-none prose-code:before:content-none prose-code:after:content-none prose-code:font-normal prose-code:bg-gray-100 prose-code:text-gray-800 prose-code:px-1 prose-code:py-0.5 prose-code:rounded';
                if (imagesContainer) imagesContainer.insertAdjacentElement('afterend', contentDiv);
                else if (bubbleDiv.querySelector('.sender-name')) bubbleDiv.querySelector('.sender-name').insertAdjacentElement('afterend', contentDiv);
                else bubbleDiv.insertBefore(contentDiv, bubbleDiv.firstChild);
            }
            
            if (message.content || (aiMessageStreaming && messageId === currentAiMessageId)) {
                if (aiMessageStreaming && messageId === currentAiMessageId) {
                     renderProcessedContent(contentDiv, currentAiMessageContent, messageId); 
                     currentAiMessageElement = bubbleDiv;
                } else {
                     renderProcessedContent(contentDiv, message.content || "", messageId);
                }
            } else if (!message.image_references || message.image_references.length === 0) {
                contentDiv.innerHTML = `<p class="italic text-gray-500">${translate('empty_message_placeholder')}</p>`;
            } else {
                contentDiv.innerHTML = ''; 
            }

            let footerDiv = bubbleDiv.querySelector('.message-footer');
            if (!footerDiv) { 
                footerDiv = document.createElement('div'); footerDiv.className = 'message-footer';
                bubbleDiv.appendChild(footerDiv);
            }
            footerDiv.innerHTML = ''; 
            
            const detailsSpan = document.createElement('span'); detailsSpan.className = 'message-details';
            let detailsContent = '';
            if (message.token_count) detailsContent += `<span>${translate('tokens_label', 'Tokens:')} ${message.token_count}</span>`;
            if (message.model_name) detailsContent += `<span>${translate('model_label', 'Model:')} ${message.model_name}</span>`;
            detailsSpan.innerHTML = detailsContent;

            const actionsSpan = document.createElement('span'); actionsSpan.className = 'message-actions items-center'; 
            if (!messageId.startsWith('temp-')) {
                const copyBtn = document.createElement('button');
                copyBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0 0 13.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 0 1-.75.75H9a.75.75 0 0 1-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 0 1-2.25 2.25H6.75A2.25 2.25 0 0 1 4.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0 1 1.927-.184" /></svg>`;
                copyBtn.title = translate('copy_content_tooltip'); copyBtn.className = 'message-action-btn';
                copyBtn.onclick = () => {
                    navigator.clipboard.writeText(message.content || "").then(() => {
                        showStatus(translate('status_content_copied', "Content copied!"), "success");
                    }).catch(err => showStatus(translate('status_copy_failed', "Copy failed."), "error"));
                };
                actionsSpan.appendChild(copyBtn);

                const editBtn = document.createElement('button');
                editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg>`;
                editBtn.title = translate('edit_message_tooltip'); editBtn.className = 'message-action-btn';
                editBtn.onclick = () => initiateEditMessage(messageId);
                actionsSpan.appendChild(editBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="text-red-500"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12.508 0A48.067 48.067 0 0 1 7.8 5.397m7.454 0M12 10.75h.008v.008H12v-.008Z" /></svg>`;
                deleteBtn.title = translate('delete_message_tooltip'); deleteBtn.className = 'message-action-btn';
                deleteBtn.onclick = () => deleteMessage(messageId);
                actionsSpan.appendChild(deleteBtn);
            }

            const gradeSpanContainer = document.createElement('span'); gradeSpanContainer.className = 'flex items-center justify-end ml-auto'; 
            if (showGrade) { 
                const userGrade = message.user_grade || 0;
                const upvoteBtn = document.createElement('button'); upvoteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" /></svg>`;
                upvoteBtn.title = translate('grade_good_tooltip'); upvoteBtn.className = `grade-btn ${userGrade > 0 ? 'selected-up' : ''} p-1 rounded hover:bg-gray-200`;
                upvoteBtn.onclick = () => gradeMessage(messageId, 1);
                const gradeDisplaySpan = document.createElement('span'); gradeDisplaySpan.className = 'grade-score font-medium'; gradeDisplaySpan.textContent = userGrade;
                const downvoteBtn = document.createElement('button'); downvoteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>`;
                downvoteBtn.title = translate('grade_bad_tooltip'); downvoteBtn.className = `grade-btn ${userGrade < 0 ? 'selected-down' : ''} p-1 rounded hover:bg-gray-200`;
                downvoteBtn.onclick = () => gradeMessage(messageId, -1);
                gradeSpanContainer.appendChild(upvoteBtn); gradeSpanContainer.appendChild(gradeDisplaySpan); gradeSpanContainer.appendChild(downvoteBtn);
            }

            footerDiv.appendChild(detailsSpan); footerDiv.appendChild(actionsSpan); footerDiv.appendChild(gradeSpanContainer);
            
            if (!existingBubbleDiv) { 
                messageContainer.appendChild(bubbleDiv); 
                chatMessages.appendChild(messageContainer); 
                if (messageId === currentAiMessageId && aiMessageStreaming) currentAiMessageElement = bubbleDiv; 
            } else if (messageId === currentAiMessageId && aiMessageStreaming) {
                currentAiMessageElement = bubbleDiv; 
            }
        }
        function renderProcessedContent(element, rawContent, messageId) { 
            let processedHtml = ''; const thinkRegex = /<think>([\s\S]*?)<\/think>/g;
            let lastIndex = 0; let match;
            while ((match = thinkRegex.exec(rawContent)) !== null) {
                const before = rawContent.substring(lastIndex, match.index);
                if (before.trim()) processedHtml += marked.parse(before);
                processedHtml += `<details class="think-block"><summary data-translate-key="assistant_thoughts_summary">Assistant's Thoughts</summary><div class="think-content prose prose-sm max-w-none">${marked.parse(match[1])}</div></details>`;
                lastIndex = thinkRegex.lastIndex;
            }
            const after = rawContent.substring(lastIndex); if (after.trim()) processedHtml += marked.parse(after);
            
            element.innerHTML = processedHtml || '<p></p>'; // Ensure there's always a paragraph for spacing
            
            try { renderMathInElement(element, { delimiters: [ {left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}, {left: '\\(', right: '\\)', display: false}, {left: '\\[', right: '\\]', display: true} ], throwOnError: false }); }
            catch(e) { console.warn("KaTeX rendering error:", e); }
            
            renderCustomCodeBlocks(element, messageId);
        }
        function renderCustomCodeBlocks(element, messageId) {
            element.querySelectorAll('pre').forEach((preElement, index) => {
                if (preElement.parentElement.classList.contains('code-block-wrapper')) {
                    return; 
                }

                const codeElement = preElement.querySelector('code');
                if (!codeElement) return;

                let language = 'plaintext';
                const langClassMatch = Array.from(codeElement.classList).find(cls => cls.startsWith('language-'));
                if (langClassMatch) {
                    language = langClassMatch.substring('language-'.length);
                } else { 
                    const hljsLangClass = Array.from(codeElement.classList).find(cls => hljs.getLanguage(cls));
                    if(hljsLangClass) language = hljsLangClass;
                }

                const code = codeElement.textContent || '';
                const wrapperDiv = document.createElement('div');
                wrapperDiv.className = 'code-block-wrapper'; 

                const header = document.createElement('div');
                header.className = 'code-block-header';

                const langSpan = document.createElement('span');
                langSpan.textContent = language;
                langSpan.className = 'text-xs font-semibold';

                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'code-block-buttons';

                const copyBtn = document.createElement('button');
                copyBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg><span data-translate-key="copy_code_btn_text">Copy</span>`;
                copyBtn.title = translate('copy_code_tooltip');
                copyBtn.onclick = () => {
                    navigator.clipboard.writeText(code).then(() => {
                        const originalText = copyBtn.querySelector('span').textContent;
                        copyBtn.querySelector('span').textContent = translate('copied_code_btn_text', 'Copied!');
                        setTimeout(() => { copyBtn.querySelector('span').textContent = originalText; }, 1500);
                    }).catch(err => console.error("Copy failed", err));
                };
                buttonsDiv.appendChild(copyBtn);

                if (language === 'python') {
                    const execBtn = document.createElement('button');
                    execBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span data-translate-key="run_code_btn_text">Run</span>`;
                    execBtn.title = translate('execute_python_code_tooltip');
                    execBtn.onclick = () => executePythonCode(code, wrapperDiv); 
                    buttonsDiv.appendChild(execBtn);
                }
                header.appendChild(langSpan);
                header.appendChild(buttonsDiv);
                
                preElement.parentNode.insertBefore(wrapperDiv, preElement);
                wrapperDiv.appendChild(header);
                wrapperDiv.appendChild(preElement); 

                preElement.classList.add('relative'); 
            });
        }
        async function gradeMessage(messageId, change) { 
             if (!currentDiscussionId || !messageId || messageId.startsWith('temp-')) return;
             const messageElement = document.getElementById(`message-${messageId}`); if (!messageElement) return;
             try {
                const response = await apiRequest(`/api/discussions/${currentDiscussionId}/messages/${messageId}/grade`, {
                    method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ change: change })
                });
                 const updatedMessage = await response.json();
                 const gradeSpan = messageElement.querySelector('.grade-score');
                 const upBtn = messageElement.querySelector('.grade-btn:first-of-type'); 
                 const downBtn = messageElement.querySelector('.grade-btn:last-of-type');
                 if (gradeSpan) gradeSpan.textContent = updatedMessage.user_grade;
                 if (upBtn) upBtn.classList.toggle('selected-up', updatedMessage.user_grade > 0); else if (upBtn) upBtn.classList.remove('selected-up');
                 if (downBtn) downBtn.classList.toggle('selected-down', updatedMessage.user_grade < 0); else if (downBtn) downBtn.classList.remove('selected-down');
                 const msgIndex = currentMessages.findIndex(m => m.id === messageId);
                 if (msgIndex > -1) currentMessages[msgIndex].user_grade = updatedMessage.user_grade;
             } catch (error) { console.error("Grading failed:", error); showStatus(translate('status_grade_update_failed'), 'error'); }
        }


        // --- Message Edit/Delete ---
        function initiateEditMessage(messageId) { 
            const messageData = currentMessages.find(m => m.id === messageId);
            if (!messageData) { showStatus(translate('status_cannot_find_message_to_edit'), "error"); return; }
            editMessageIdInput.value = messageId; editMessageInput.value = messageData.content;
            showStatus('', 'info', editMessageStatus); openModal('editMessageModal');
        }
        async function confirmMessageEdit() { 
            const messageId = editMessageIdInput.value; const newContent = editMessageInput.value;
            if (!messageId || !currentDiscussionId) return;
            showStatus(translate('status_saving_changes', 'Saving changes...'), 'info', editMessageStatus); confirmEditMessageBtn.disabled = true;
            try {
                const response = await apiRequest(`/api/discussions/${currentDiscussionId}/messages/${messageId}`, {
                    method: 'PUT', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: newContent }), statusElement: editMessageStatus
                });
                const updatedMessageData = await response.json(); 
                const msgIndex = currentMessages.findIndex(m => m.id === messageId);
                if (msgIndex > -1) currentMessages[msgIndex] = updatedMessageData; 
                
                const messageElementContainer = document.getElementById(`message-${messageId}`)?.closest('.message-container');
                if (messageElementContainer) { 
                    const tempMsg = { ...updatedMessageData, addSpacing: messageElementContainer.classList.contains('mt-3') };
                    const oldScroll = chatMessages.scrollTop; 
                    renderMessage(tempMsg); 
                    chatMessages.scrollTop = oldScroll;
                }
                if(discussions[currentDiscussionId] && updatedMessageData.created_at) {
                    discussions[currentDiscussionId].last_activity_at = updatedMessageData.created_at;
                    renderDiscussionList();
                }
                showStatus(translate('status_message_updated_success', 'Message updated successfully.'), 'success', editMessageStatus);
                setTimeout(() => closeModal('editMessageModal'), 1000);
            } catch (error) { console.error("Message edit failed:", error); }
            finally { confirmEditMessageBtn.disabled = false; }
        }
        async function deleteMessage(messageId) { 
             if (!currentDiscussionId || !messageId || messageId.startsWith('temp-')) return;
             const messageElement = document.getElementById(`message-${messageId}`);
             const msgPreview = messageElement ? (messageElement.querySelector('.message-content')?.textContent || translate('image_message_placeholder', 'Image message')).substring(0,50)+'...' : translate('message_id_placeholder', `message ${messageId}`, {id: messageId});
             if (confirm(translate('confirm_delete_message', `Are you sure you want to delete this message?\n\n"${msgPreview}"`, {preview: msgPreview}))) {
                 showStatus(translate('status_deleting_message', 'Deleting message...'), 'info');
                 try {
                     await apiRequest(`/api/discussions/${currentDiscussionId}/messages/${messageId}`, { method: 'DELETE' });
                     currentMessages = currentMessages.filter(m => m.id !== messageId);
                     messageElement?.closest('.message-container')?.remove();
                     showStatus(translate('status_message_deleted_success', 'Message deleted successfully.'), 'success');
                     await refreshMessagesAfterStream();
                 } catch (error) { console.error("Message deletion failed:", error); }
             }
        }


        // --- Pyodide Python Execution ---
        async function loadPyodide() {
            if (pyodide || pyodideLoading) return;
            pyodideLoading = true; showPyodideStatus(translate('pyodide_loading_interpreter', 'Loading Python interpreter...'));
            try {
                if (typeof window.loadPyodide !== "function") {
                    throw new Error(translate('pyodide_script_not_loaded_error'));
                }
                pyodide = await window.loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.25.1/full/" });
                if (!pyodide || typeof pyodide.loadPackage !== 'function') {
                    throw new Error(translate('pyodide_object_load_failed_error'));
                }
                await pyodide.loadPackage("micropip");
                showPyodideStatus(translate('pyodide_ready_status', 'Python ready.')); setTimeout(() => showPyodideStatus(''), 3000);
            } catch (error) { 
                console.error("Pyodide loading failed:", error); 
                showPyodideStatus(translate('pyodide_load_error', `Error loading Python: ${error.message}`, {message: error.message}), true); 
                pyodide = null; 
            }
            finally { pyodideLoading = false; }
        }
        async function executePythonCode(code, codeContainerElement) { 
             await loadPyodide(); if (!pyodide) { showPyodideStatus(translate('pyodide_not_available_error'), true); return; }
             
             let outputDiv = codeContainerElement.querySelector('.code-output');
             if (outputDiv) { 
                 outputDiv.textContent = '';
             } else { 
                 outputDiv = document.createElement('pre');
                 outputDiv.className = 'code-output'; 
                 codeContainerElement.appendChild(outputDiv);
             }
             outputDiv.textContent = translate('pyodide_executing_text', 'Executing...') + '\n'; 

             let stdoutBuffer = ''; let stderrBuffer = '';
             pyodide.setStdout({ batched: (msg) => { stdoutBuffer += msg + '\n'; outputDiv.textContent += msg + '\n'; outputDiv.scrollTop = outputDiv.scrollHeight;} });
             pyodide.setStderr({ batched: (msg) => { stderrBuffer += msg + '\n'; outputDiv.textContent += `${translate('pyodide_error_prefix', 'Error:')} ${msg}\n`; outputDiv.scrollTop = outputDiv.scrollHeight;} });
             
             showPyodideStatus(translate('pyodide_running_code_status', 'Running Python code...'));
             try {
                 const lines = code.split('\n');
                 const installCommands = lines.filter(line => line.trim().startsWith('%pip install') || line.trim().startsWith('!pip install'));
                 const codeToRun = lines.filter(line => !line.trim().startsWith('%pip install') && !line.trim().startsWith('!pip install')).join('\n');
                 
                 if (installCommands.length > 0) {
                     outputDiv.textContent += translate('pyodide_installing_packages_text', 'Installing packages...') + '\n';
                     const micropip = pyodide.pyimport("micropip");
                     for (const cmd of installCommands) {
                         const packages = cmd.split('install')[1].trim().split(' ');
                         outputDiv.textContent += `> ${cmd}\n`; 
                         await micropip.install(packages);
                         outputDiv.textContent += translate('pyodide_packages_installed_text', `Packages installed: ${packages.join(', ')}`, { packages: packages.join(', ')}) + '\n';
                         outputDiv.scrollTop = outputDiv.scrollHeight;
                     }
                     outputDiv.textContent += translate('pyodide_installation_complete_text', 'Installation complete. Running code...') + '\n';
                     outputDiv.scrollTop = outputDiv.scrollHeight;
                 }
                 
                 let result = await pyodide.runPythonAsync(codeToRun);
                 if (result !== undefined) {
                    outputDiv.textContent += `\n${translate('pyodide_result_prefix', 'Result:')} ${result}\n`;
                    outputDiv.scrollTop = outputDiv.scrollHeight;
                 }
                 if (!stderrBuffer) outputDiv.textContent += '\n' + translate('pyodide_execution_finished_text', 'Execution finished.');
                 showPyodideStatus(translate('pyodide_execution_finished_status', 'Python execution finished.'));
             } catch (error) { 
                 console.error("Python execution error:", error); 
                 outputDiv.textContent += `\n${translate('pyodide_execution_error_prefix', 'Execution Error:')} ${error.message}\n`; 
                 outputDiv.scrollTop = outputDiv.scrollHeight;
                 showPyodideStatus(translate('pyodide_execution_failed_status', 'Python execution failed.'), true); 
            }
             finally { 
                 pyodide.setStdout({}); pyodide.setStderr({}); 
                 setTimeout(() => showPyodideStatus(''), 3000); 
            }
        }
         function showPyodideStatus(msg, isError = false) {
            pyodideStatus.textContent = msg;
            pyodideStatus.className = `text-xs mt-1 h-4 ${isError ? 'text-red-600' : 'text-blue-600'}`;
        }


        // --- Settings Modal Logic --- 
        settingsBtn.onclick = () => openModal('settingsModal');
        
        function handleSettingsTabSwitch(tabId) {
            document.querySelectorAll('#settingsModal .settings-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            document.querySelectorAll('#settingsModal .settings-tab-btn').forEach(button => {
                button.classList.remove('active-tab');
            });

            document.getElementById(tabId).style.display = 'block';
            document.querySelector(`#settingsModal .settings-tab-btn[data-tab="${tabId}"]`).classList.add('active-tab');
        }
        
        async function loadAvailableLollmsModels() { 
             try {
                const response = await apiRequest('/api/config/lollms-models');
                if (!response.ok) throw new Error(`API failed: ${response.status}`);
                availableLollmsModels = await response.json();
                populateDropdown(settingsLollmsModelSelect, availableLollmsModels, currentUser.lollms_model_name, translate('settings_no_models_found'));
             } catch (error) {
                 console.error("Failed to load LoLLMs models:", error); availableLollmsModels = [];
                 populateDropdown(settingsLollmsModelSelect, [], null, translate('settings_error_loading_models', `Error: ${error.message || 'Failed to load'}`, {message: error.message || 'Failed to load'}));
             }
         }
        
        settingsLollmsModelSelect.onchange = () => { saveModelAndVectorizerBtn.disabled = (settingsLollmsModelSelect.value === currentUser.lollms_model_name); };

        saveModelAndVectorizerBtn.onclick = async () => {
            const selectedModel = settingsLollmsModelSelect.value;
            let modelChanged = selectedModel && selectedModel !== currentUser.lollms_model_name;
            if (!modelChanged) return;

            showStatus(translate('status_saving_model', 'Saving model...'), 'info', settingsStatus_llmConfig); 
            saveModelAndVectorizerBtn.disabled = true;
            try {
                if (modelChanged) {
                    const formData = new FormData(); formData.append('model_name', selectedModel);
                    await apiRequest('/api/config/lollms-model', { method: 'POST', body: formData, statusElement: settingsStatus_llmConfig });
                    currentUser.lollms_model_name = selectedModel;
                }
                showStatus(translate('status_model_saved_success', 'Model saved. LLM Client will re-init if model changed.'), 'success', settingsStatus_llmConfig);
            } catch (error) {
                console.error("Failed to save model:", error); 
            } finally {
                saveModelAndVectorizerBtn.disabled = (settingsLollmsModelSelect.value === currentUser.lollms_model_name);
            }
        };

        [settingsTemperature, settingsTopK, settingsTopP, settingsRepeatPenalty, settingsRepeatLastN].forEach(el => {
            el.oninput = () => { saveLLMParamsBtn.disabled = false; };
        });

        saveLLMParamsBtn.onclick = async () => {
            const params = {
                llm_temperature: parseFloat(settingsTemperature.value) || null,
                llm_top_k: parseInt(settingsTopK.value) || null,
                llm_top_p: parseFloat(settingsTopP.value) || null,
                llm_repeat_penalty: parseFloat(settingsRepeatPenalty.value) || null,
                llm_repeat_last_n: parseInt(settingsRepeatLastN.value) || null,
            };
            const payload = Object.fromEntries(Object.entries(params).filter(([_, v]) => v !== null && !isNaN(v)));

            showStatus(translate('status_saving_llm_params', 'Saving LLM parameters...'), 'info', settingsStatus_llmParams); 
            saveLLMParamsBtn.disabled = true;
            try {
                await apiRequest('/api/config/llm-params', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    statusElement: settingsStatus_llmParams
                });
                Object.assign(currentUser, payload);
                showStatus(translate('status_llm_params_saved_success', 'LLM parameters saved.'), 'success', settingsStatus_llmParams);
            } catch (error) {
                console.error("Failed to save LLM params:", error); 
            } finally {
                saveLLMParamsBtn.disabled = false;
            }
        };
        
        [settingsCurrentPassword, settingsNewPassword, settingsConfirmPassword].forEach(el => {
            el.oninput = () => {
                changePasswordBtn.disabled = !(settingsCurrentPassword.value && settingsNewPassword.value && settingsConfirmPassword.value);
            };
        });

        async function handleChangePassword() {
            const currentPassword = settingsCurrentPassword.value;
            const newPassword = settingsNewPassword.value;
            const confirmPassword = settingsConfirmPassword.value;

            if (!currentPassword || !newPassword || !confirmPassword) {
                showStatus(translate('settings_pwd_all_fields_required'), "error", passwordChangeStatus);
                return;
            }
            if (newPassword.length < 8) { 
                showStatus(translate('settings_pwd_new_min_length_error'), "error", passwordChangeStatus);
                return;
            }
            if (newPassword !== confirmPassword) {
                showStatus(translate('settings_pwd_mismatch_error'), "error", passwordChangeStatus);
                return;
            }

            showStatus(translate('status_changing_password', "Changing password..."), "info", passwordChangeStatus);
            changePasswordBtn.disabled = true;

            try {
                await apiRequest('/api/auth/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    }),
                    statusElement: passwordChangeStatus 
                });
                showStatus(translate('status_password_changed_success', "Password changed successfully."), "success", passwordChangeStatus);
                settingsCurrentPassword.value = '';
                settingsNewPassword.value = '';
                settingsConfirmPassword.value = '';
            } catch (error) {
                console.error("Password change failed:", error);
            } finally {
                changePasswordBtn.disabled = true;
            }
        }

        function populateSettingsModal() {
             populateDropdown(settingsLollmsModelSelect, availableLollmsModels, currentUser.lollms_model_name, translate('settings_no_models_found'));
             saveModelAndVectorizerBtn.disabled = true;
             showStatus('', 'info', settingsStatus_llmConfig);
             
             settingsTemperature.value = currentUser.llm_temperature ?? '';
             settingsTopK.value = currentUser.llm_top_k ?? '';
             settingsTopP.value = currentUser.llm_top_p ?? '';
             settingsRepeatPenalty.value = currentUser.llm_repeat_penalty ?? '';
             settingsRepeatLastN.value = currentUser.llm_repeat_last_n ?? '';
             saveLLMParamsBtn.disabled = true;
             showStatus('', 'info', settingsStatus_llmParams);

             settingsCurrentPassword.value = '';
             settingsNewPassword.value = '';
             settingsConfirmPassword.value = '';
             changePasswordBtn.disabled = true;
             showStatus('', 'info', passwordChangeStatus);
             
             handleSettingsTabSwitch('llmConfigTab');
        }


        // --- Data Store Management --- 
        dataStoresBtn.onclick = () => openModal('dataStoresModal');

        async function loadDataStores() { 
            try {
                const response = await apiRequest('/api/datastores');
                const allStores = await response.json();
                ownedDataStores = allStores.filter(ds => ds.owner_username === currentUser.username);
                sharedDataStores = allStores.filter(ds => ds.owner_username !== currentUser.username);
                
                availableDataStoresForRag = [...ownedDataStores, ...sharedDataStores].sort((a,b) => a.name.localeCompare(b.name));
                
                populateDataStoresModal(); 
                populateRagDataStoreSelect(); 
            } catch (error) {
                console.error("Failed to load data stores:", error);
                if(ownedDataStoresList) ownedDataStoresList.innerHTML = `<p class="text-red-500 italic">${translate('datastores_error_loading')}</p>`;
                if(sharedDataStoresList) sharedDataStoresList.innerHTML = `<p class="text-red-500 italic">${translate('datastores_error_loading')}</p>`;
            }
        }
        
        function populateRagDataStoreSelect() {
            ragDataStoreSelect.innerHTML = `<option value="">${translate('rag_select_default_option')}</option>`;
            availableDataStoresForRag.forEach(ds => {
                const option = document.createElement('option');
                option.value = ds.id;
                option.textContent = `${ds.name} (${ds.owner_username === currentUser.username ? translate('datastores_owned_by_you_suffix') : translate('datastores_shared_by_suffix', `Shared by ${ds.owner_username}`, {owner: ds.owner_username})})`;
                ragDataStoreSelect.appendChild(option);
            });
            if (currentDiscussionId && discussions[currentDiscussionId] && discussions[currentDiscussionId].rag_datastore_id) {
                ragDataStoreSelect.value = discussions[currentDiscussionId].rag_datastore_id;
            }
        }
        
        ragDataStoreSelect.onchange = async () => {
            if (!currentDiscussionId) return;
            const selectedDataStoreId = ragDataStoreSelect.value || null; 
            try {
                await apiRequest(`/api/discussions/${currentDiscussionId}/rag_datastore`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rag_datastore_id: selectedDataStoreId })
                });
                discussions[currentDiscussionId].rag_datastore_id = selectedDataStoreId;
                const dsName = selectedDataStoreId ? availableDataStoresForRag.find(ds=>ds.id===selectedDataStoreId)?.name : translate('none_text');
                showStatus(translate('status_rag_datastore_set', `RAG datastore for this discussion set to: ${dsName}.`, {name: dsName}), 'success');
                updateRagToggleButtonState(); 
            } catch (error) {
                showStatus(translate('status_rag_datastore_set_failed'), 'error');
                ragDataStoreSelect.value = discussions[currentDiscussionId].rag_datastore_id || "";
            }
        };


        function populateDataStoresModal() {
            ownedDataStoresList.innerHTML = '';
            if (ownedDataStores.length === 0) {
                ownedDataStoresList.innerHTML = `<p class="text-gray-500 italic">${translate('datastores_no_owned_stores')}</p>`;
            } else {
                ownedDataStores.forEach(ds => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center py-1.5 px-2 hover:bg-gray-100 rounded text-sm';
                    div.innerHTML = `
                        <div class="flex-1">
                            <strong class="text-gray-800">${ds.name}</strong>
                            <p class="text-xs text-gray-500 truncate">${ds.description || translate('datastores_no_description')}</p>
                        </div>
                        <div class="space-x-1">
                            <button title="${translate('manage_files_tooltip')}" onclick="openFileManagerForStore('${ds.id}', '${ds.name}')" class="p-1 hover:bg-blue-100 rounded"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-blue-600"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9.776c.112-.017.227-.026.344-.026h15.812c.117 0 .232.009.344.026m-16.5 0a2.25 2.25 0 0 0-1.883 2.542l.857 6a2.25 2.25 0 0 0 2.227 1.932H19.05a2.25 2.25 0 0 0 2.227-1.932l.857-6a2.25 2.25 0 0 0-1.883-2.542m-16.5 0V6A2.25 2.25 0 0 1 6 3.75h3.879a1.5 1.5 0 0 1 1.06.44l2.122 2.12a1.5 1.5 0 0 0 1.06.44H18A2.25 2.25 0 0 1 20.25 9v.776" /></svg></button>
                            <button title="${translate('share_datastore_tooltip')}" onclick="initiateShareDataStore('${ds.id}', '${ds.name}')" class="p-1 hover:bg-green-100 rounded"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-green-600"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0ZM3 19.235v-.11a6.375 6.375 0 0 1 12.75 0v.109A12.318 12.318 0 0 1 9.374 21c-2.331 0-4.512-.645-6.374-1.766Z" /></svg></button>
                            <button title="${translate('rename_edit_datastore_tooltip')}" onclick="initiateEditDataStore('${ds.id}', '${ds.name}', '${ds.description || ''}')" class="p-1 hover:bg-yellow-100 rounded"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-yellow-600"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" /></svg></button>
                            <button title="${translate('delete_datastore_tooltip')}" onclick="deleteDataStore('${ds.id}', '${ds.name}')" class="p-1 hover:bg-red-100 rounded"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-red-600"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12.508 0A48.067 48.067 0 0 1 7.8 5.397m7.454 0M12 10.75h.008v.008H12v-.008Z" /></svg></button>
                        </div>
                    `;
                    ownedDataStoresList.appendChild(div);
                });
            }
            sharedDataStoresList.innerHTML = '';
            if (sharedDataStores.length === 0) {
                sharedDataStoresList.innerHTML = `<p class="text-gray-500 italic">${translate('datastores_no_shared_stores')}</p>`;
            } else {
                 sharedDataStores.forEach(ds => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center py-1.5 px-2 text-sm'; 
                    div.innerHTML = `
                        <div class="flex-1">
                            <strong class="text-gray-800">${ds.name}</strong> (${translate('datastores_owned_by_prefix')}: ${ds.owner_username})
                            <p class="text-xs text-gray-500 truncate">${ds.description || translate('datastores_no_description')}</p>
                        </div>
                        <button title="${translate('use_for_rag_tooltip')}" onclick="setDiscussionRagStore('${ds.id}')" class="p-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200" data-translate-key="use_for_rag_btn">Use for RAG</button>
                    `;
                    sharedDataStoresList.appendChild(div);
                });
            }
        }
        
        async function handleCreateDataStore(event) {
            event.preventDefault();
            const name = newDataStoreNameInput.value.trim();
            const description = newDataStoreDescriptionInput.value.trim();
            if (!name) { showStatus(translate('datastores_name_required_error'), "error", createDataStoreStatus); return; }
            showStatus(translate('status_creating_datastore', "Creating data store..."), "info", createDataStoreStatus);
            try {
                await apiRequest('/api/datastores', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description }),
                    statusElement: createDataStoreStatus
                });
                showStatus(translate('status_datastore_created_success', `Data Store "${name}" created.`, {name: name}), "success", createDataStoreStatus);
                createDataStoreForm.reset();
                await loadDataStores(); 
            } catch (error) { console.error("Create Data Store failed:", error); }
        }

        function initiateEditDataStore(id, name, description) { // This function seems to be for UI population only, not actual edit.
            newDataStoreNameInput.value = name;
            newDataStoreDescriptionInput.value = description;
            showStatus(translate('status_editing_datastore_note', `Editing store: ${name}. (Note: Save functionality for edit uses the 'Create Store' button logic but would ideally be a PUT request to /api/datastores/${id})`, {name: name}), 'info', createDataStoreStatus);
        }

        async function deleteDataStore(id, name) {
            if (!confirm(translate('confirm_delete_datastore', `Are you sure you want to delete data store "${name}" and all its indexed files? This cannot be undone.`, {name: name}))) return;
            showStatus(translate('status_deleting_datastore', `Deleting data store ${name}...`, {name: name}), 'info', createDataStoreStatus); 
            try {
                await apiRequest(`/api/datastores/${id}`, { method: 'DELETE', statusElement: createDataStoreStatus });
                showStatus(translate('status_datastore_deleted_success', `Data Store "${name}" deleted.`, {name: name}), 'success', createDataStoreStatus);
                await loadDataStores(); 
            } catch (error) { console.error("Delete Data Store failed:", error); }
        }
        
        function initiateShareDataStore(id, name) {
            shareDataStoreIdInput.value = id;
            shareDataStoreTitle.textContent = translate('share_datastore_modal_title', `Share Data Store: "${name}"`, {name: name});
            shareTargetUsernameDSInput.value = '';
            showStatus('', 'info', shareDataStoreStatus);
            openModal('shareDataStoreModal');
        }

        confirmShareDataStoreBtn.onclick = async () => {
            const datastoreId = shareDataStoreIdInput.value;
            const targetUsername = shareTargetUsernameDSInput.value.trim();
            if (!datastoreId || !targetUsername) {
                showStatus(translate('share_datastore_target_user_required_error'), 'error', shareDataStoreStatus);
                return;
            }
            showStatus(translate('status_sharing_datastore_with_user', `Sharing data store with ${targetUsername}...`, {username: targetUsername}), 'info', shareDataStoreStatus);
            try {
                await apiRequest(`/api/datastores/${datastoreId}/share`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target_username: targetUsername, permission_level: "read_query" }), 
                    statusElement: shareDataStoreStatus
                });
                showStatus(translate('status_datastore_shared_success', 'Data Store shared successfully!'), 'success', shareDataStoreStatus);
                setTimeout(() => closeModal('shareDataStoreModal'), 1500);
            } catch (error) {
                console.error("Share Data Store failed:", error);
            }
        };
        
        function setDiscussionRagStore(datastoreId) {
            if (!currentDiscussionId) {
                showStatus(translate('status_select_discussion_first_warning'), "warning");
                closeModal('dataStoresModal'); 
                return;
            }
            ragDataStoreSelect.value = datastoreId;
            ragDataStoreSelect.dispatchEvent(new Event('change')); 
            closeModal('dataStoresModal');
        }


        // --- File Management Modal Logic ---
        async function openFileManagerForStore(datastoreId, datastoreName) {
            closeModal('dataStoresModal'); 
            fileManagerCurrentDataStoreId.value = datastoreId;
            fileManagerDataStoreName.textContent = datastoreName;
            
            showStatus('', 'info', uploadStatus); showStatus('', 'info', fileListStatus);
            if(fileUploadInputFS) fileUploadInputFS.value = ''; 
            confirmUploadBtn.disabled = true;
            
            try {
                const response = await apiRequest(`/api/store/${datastoreId}/vectorizers`);
                const storeVectorizers = await response.json();
                populateDropdown(fileVectorizerSelect, storeVectorizers, null, translate('file_manager_vectorizer_select_default'), true);
            } catch (error) {
                console.error(`Failed to load vectorizers for store ${datastoreId}:`, error);
                populateDropdown(fileVectorizerSelect, [], null, translate('file_manager_error_loading_vectorizers'), true);
            }
            
            await loadIndexedRagFilesInStore(datastoreId);
            openModal('fileManagementModal');
        }
        async function loadIndexedRagFilesInStore(datastoreId) {
             indexedFileList.innerHTML = `<p class="text-gray-500 italic px-1">${translate('file_manager_loading_files')}</p>`;
             try {
                 const response = await apiRequest(`/api/store/${datastoreId}/files`);
                 const files = await response.json(); renderRagFileList(files);
             } catch (error) { console.error("Failed to load RAG files:", error); renderRagFileList(null, translate('file_manager_error_loading_files_detail')); }
        }
        function updateConfirmUploadBtnState() {
              if (!fileUploadInputFS) return; 
              const filesSelected = fileUploadInputFS.files && fileUploadInputFS.files.length > 0;
              const vectorizerSelected = fileVectorizerSelect.value !== ""; confirmUploadBtn.disabled = !(filesSelected && vectorizerSelected);
        }
        if(fileUploadInputFS) fileUploadInputFS.onchange = updateConfirmUploadBtnState;
        if(fileVectorizerSelect) fileVectorizerSelect.onchange = updateConfirmUploadBtnState;

        confirmUploadBtn.onclick = async () => {
            const datastoreId = fileManagerCurrentDataStoreId.value;
            if (!datastoreId) { showStatus(translate('file_manager_no_datastore_selected_error'), "error", uploadStatus); return; }
            if (!fileUploadInputFS) { showStatus(translate('file_manager_file_input_not_found_error'), "error", uploadStatus); return; }

            const files = fileUploadInputFS.files; const vectorizer = fileVectorizerSelect.value;
            if (!files || files.length === 0 || !vectorizer) return;

            const formData = new FormData();
            for (const file of files) formData.append('files', file);
            formData.append('vectorizer_name', vectorizer);

            showStatus(translate('status_uploading_files_to_store', `Uploading ${files.length} file(s) to store using ${vectorizer}...`, {count: files.length, vectorizer: vectorizer}), 'info', uploadStatus);
            confirmUploadBtn.disabled = true;
            try {
                 const response = await apiRequest(`/api/store/${datastoreId}/upload-files`, { method: 'POST', body: formData, statusElement: uploadStatus });
                 const result = await response.json();
                 let message = result.message || translate('status_upload_completed', "Upload completed.");
                 let statusType = response.status === 207 ? 'warning' : 'success';
                 if (response.status === 207) message = translate('status_upload_partial_success', `Upload finished. Processed: ${result.processed_files?.length || 0}, Errors: ${result.errors?.length || 0}`, {processed: result.processed_files?.length || 0, errors: result.errors?.length || 0});
                 showStatus(message, statusType, uploadStatus);
                 await loadIndexedRagFilesInStore(datastoreId);
                 fileUploadInputFS.value = ''; updateConfirmUploadBtnState();
            } catch (error) { console.error("Upload failed:", error); }
            finally { confirmUploadBtn.disabled = false; updateConfirmUploadBtnState(); }
        };
        function renderRagFileList(files, message = null) { 
             indexedFileList.innerHTML = ''; if (message) { const msgElement = document.createElement('p'); msgElement.className = 'text-gray-500 italic px-1'; if(message.toLowerCase().includes("error")) msgElement.classList.add('text-red-500'); msgElement.textContent = message; indexedFileList.appendChild(msgElement); return; }
             if (!files || files.length === 0) { indexedFileList.innerHTML = `<p class="text-gray-500 italic px-1">${translate('file_manager_no_indexed_docs')}</p>`; return; }
             files.forEach(file => {
                 const fileDiv = document.createElement('div'); fileDiv.className = 'flex justify-between items-center py-1 px-1 hover:bg-gray-100 rounded';
                 const fileNameSpan = document.createElement('span'); fileNameSpan.textContent = file.filename; fileNameSpan.className = 'truncate text-sm text-gray-700'; fileNameSpan.title = file.filename;
                 const deleteBtn = document.createElement('button');
                 deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>`;
                 deleteBtn.className = 'flex-shrink-0 text-red-500 hover:text-red-700 p-1 rounded hover:bg-red-100 ml-2'; 
                 deleteBtn.title = translate('delete_rag_file_tooltip', `Delete ${file.filename}`, {filename: file.filename});
                 deleteBtn.onclick = () => deleteRagFileInModal(file.filename);
                 fileDiv.appendChild(fileNameSpan); fileDiv.appendChild(deleteBtn); indexedFileList.appendChild(fileDiv);
             });
        }
        async function deleteRagFileInModal(filename) {
             const datastoreId = fileManagerCurrentDataStoreId.value;
             if (!datastoreId) { showStatus(translate('file_manager_no_datastore_for_delete_error'), "error", fileListStatus); return; }
             if (!confirm(translate('confirm_delete_rag_file', `Are you sure you want to delete RAG document "${filename}" from this store?`, {filename: filename}))) return;
             showStatus(translate('status_deleting_rag_file', `Deleting ${filename}...`, {filename: filename}), 'info', fileListStatus);
             try {
                 await apiRequest(`/api/store/${datastoreId}/files/${encodeURIComponent(filename)}`, { method: 'DELETE', statusElement: fileListStatus });
                 showStatus(translate('status_rag_file_deleted_success', `Deleted ${filename}.`, {filename: filename}), 'success', fileListStatus);
                 await loadIndexedRagFilesInStore(datastoreId); 
             } catch (error) { console.error(`Delete failed for ${filename}:`, error); }
        }

        // --- RAG Toggle Logic ---
        ragToggleBtn.onclick = () => {
             if (availableDataStoresForRag.length === 0) {
                 showStatus(translate('rag_cannot_enable_no_stores_warning'), 'warning');
                 return;
             }
             isRagActive = !isRagActive;
             updateRagToggleButtonState();
             if (isRagActive && !ragDataStoreSelect.value && availableDataStoresForRag.length > 0) {
                 ragDataStoreSelect.value = availableDataStoresForRag[0].id; // Select first available
                 ragDataStoreSelect.dispatchEvent(new Event('change')); 
             } else if (!isRagActive && currentDiscussionId && discussions[currentDiscussionId]) {
                 ragDataStoreSelect.value = ""; // Clear selection
                 ragDataStoreSelect.dispatchEvent(new Event('change'));
             }
             showStatus(translate(isRagActive ? 'status_rag_active' : 'status_rag_inactive', `RAG is now ${isRagActive ? 'ACTIVE' : 'INACTIVE'}.`), 'info');
        };
        function updateRagToggleButtonState() {
            const hasDataStores = availableDataStoresForRag.length > 0;
            ragToggleBtn.disabled = !hasDataStores;
            ragDataStoreSelect.style.display = (isRagActive && hasDataStores) ? 'inline-block' : 'none';

            if (!hasDataStores) {
                ragToggleBtn.classList.remove('rag-toggle-on'); ragToggleBtn.classList.add('rag-toggle-off');
                ragToggleBtn.title = translate('rag_toggle_btn_title_no_stores'); 
                isRagActive = false; return;
            }
            if (isRagActive) {
                ragToggleBtn.classList.remove('rag-toggle-off'); ragToggleBtn.classList.add('rag-toggle-on');
                const selectedDS = availableDataStoresForRag.find(ds => ds.id === ragDataStoreSelect.value);
                ragToggleBtn.title = translate('rag_toggle_btn_title_on', `RAG Active ${selectedDS ? `(Using: ${selectedDS.name})` : '(Select Store)'} - Click to disable`, {datastore_name: selectedDS ? selectedDS.name : translate('rag_select_store_text', '(Select Store)')});
            } else {
                ragToggleBtn.classList.remove('rag-toggle-on'); ragToggleBtn.classList.add('rag-toggle-off');
                ragToggleBtn.title = translate('rag_toggle_btn_title_off');
            }
        }
        
        // --- Image Upload Handling ---
        async function handleImageFileSelection(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            if (uploadedImageServerPaths.length + files.length > 5) { 
                showStatus(translate('max_5_images_warning'), "warning"); return;
            }

            imageUploadPreviewContainer.style.display = 'flex';
            const formData = new FormData();
            files.forEach(file => formData.append('files', file));

            showStatus(translate('status_uploading_images', "Uploading images..."), "info");
            try {
                const response = await apiRequest('/api/upload/chat_image', { method: 'POST', body: formData });
                const newUploadedImages = await response.json(); 
                
                newUploadedImages.forEach(imgInfo => {
                    const originalFile = files.find(f => f.name === imgInfo.filename);
                    if (originalFile) {
                        uploadedImageServerPaths.push({ ...imgInfo, file_obj: originalFile }); 
                        renderImagePreview(originalFile, imgInfo.server_path);
                    }
                });
                showStatus(translate('status_images_ready_to_send', "Images ready to send."), "success");
                sendMessageBtn.disabled = aiMessageStreaming; // Enable send if not streaming
            } catch (error) {
                showStatus(translate('status_image_upload_failed', "Image upload failed."), "error");
                console.error("Image upload error:", error);
            } finally {
                imageUploadInput.value = ''; 
            }
        }
        function renderImagePreview(file, serverPath) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const itemDiv = document.createElement('div'); itemDiv.className = 'image-preview-item';
                itemDiv.dataset.serverPath = serverPath; 
                const img = document.createElement('img'); img.src = e.target.result;
                const removeBtn = document.createElement('button'); removeBtn.className = 'remove-preview-btn';
                removeBtn.textContent = '×';
                removeBtn.title = translate('remove_image_preview_tooltip');
                removeBtn.onclick = () => {
                    uploadedImageServerPaths = uploadedImageServerPaths.filter(p => p.server_path !== serverPath);
                    itemDiv.remove();
                    if (imageUploadPreviewContainer.children.length === 0) imageUploadPreviewContainer.style.display = 'none';
                    sendMessageBtn.disabled = !(messageInput.value.trim() || uploadedImageServerPaths.length > 0) || aiMessageStreaming;
                };
                itemDiv.appendChild(img); itemDiv.appendChild(removeBtn);
                imageUploadPreviewContainer.appendChild(itemDiv);
            };
            reader.readAsDataURL(file);
        }
        function viewImage(src) {
            imageViewerSrc.src = src;
            openModal('imageViewerModal');
        }


        // --- Export / Import Logic ---
        function populateExportModal() { 
            exportDiscussionList.innerHTML = '';
            const sortedDiscussions = Object.values(discussions).sort((a,b) => (a.title || '').localeCompare(b.title || ''));
            if (sortedDiscussions.length === 0) { exportDiscussionList.innerHTML = `<p class="text-gray-500 italic">${translate('export_no_discussions')}</p>`; return; }
            sortedDiscussions.forEach(d => {
                const div = document.createElement('div'); div.className = 'flex items-center';
                const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.id = `export-check-${d.id}`; checkbox.value = d.id; checkbox.className = 'h-4 w-4 mr-2 rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-offset-0 focus:ring-blue-200 focus:ring-opacity-50';
                const label = document.createElement('label'); label.htmlFor = `export-check-${d.id}`; label.textContent = `${d.title || translate('untitled_discussion_placeholder')} (ID: ...${d.id.slice(-6)})`; label.className = 'text-sm text-gray-700';
                div.appendChild(checkbox); div.appendChild(label); exportDiscussionList.appendChild(div);
            });
        }
        exportDataBtn.onclick = () => openModal('exportModal');
        confirmExportBtn.onclick = async () => { 
            const selectedIds = Array.from(exportDiscussionList.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value); closeModal('exportModal'); showStatus(translate('status_exporting_data', 'Exporting data...'), 'info');
            try {
                 const requestBody = { discussion_ids: selectedIds.length > 0 ? selectedIds : null };
                 const response = await apiRequest('/api/discussions/export', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
                 const exportData = await response.json(); const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob);
                 const a = document.createElement('a'); a.href = url; const timestamp = new Date().toISOString().replace(/[:.]/g, '-'); a.download = `simplified_lollms_export_${currentUser.username}_${timestamp}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
                 showStatus(translate('status_data_exported_success', 'Data exported successfully.'), 'success');
            } catch (error) { console.error("Export failed:", error); }
        };
        importDataBtn.onclick = () => { 
             importFile.value = ''; importPreviewArea.style.display = 'none'; importDiscussionList.innerHTML = ''; confirmImportBtn.disabled = true; showStatus('', 'info', importStatus); parsedImportData = null; openModal('importModal');
        };
        let parsedImportData = null; 
        importFile.onchange = async () => { 
            const file = importFile.files[0]; parsedImportData = null; importPreviewArea.style.display = 'none'; importDiscussionList.innerHTML = ''; confirmImportBtn.disabled = true; showStatus('', 'info', importStatus); if (!file) return;
            if (file.type !== 'application/json') { showStatus(translate('import_invalid_json_error'), 'error', importStatus); return; }
            showStatus(translate('status_reading_import_file', 'Reading file...'), 'info', importStatus);
            try {
                const content = await file.text(); parsedImportData = JSON.parse(content);
                if (!parsedImportData || !Array.isArray(parsedImportData.discussions)) throw new Error(translate('import_invalid_file_format_error'));
                 if (parsedImportData.discussions.length === 0) { importDiscussionList.innerHTML = `<p class="text-gray-500 italic">${translate('import_no_discussions_in_file')}</p>`; confirmImportBtn.disabled = true; }
                 else { parsedImportData.discussions.forEach((disc, index) => { if (!disc || typeof disc.discussion_id !== 'string') { console.warn("Skipping invalid discussion data:", disc); return; } const div = document.createElement('div'); div.className = 'flex items-center'; const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.id = `import-check-${disc.discussion_id}`; checkbox.value = disc.discussion_id; checkbox.checked = true; checkbox.className = 'h-4 w-4 mr-2 rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-offset-0 focus:ring-blue-200 focus:ring-opacity-50'; const label = document.createElement('label'); label.htmlFor = `import-check-${disc.discussion_id}`; label.textContent = `${disc.title || translate('untitled_discussion_placeholder')} (ID: ...${disc.discussion_id.slice(-6)})`; label.className = 'text-sm text-gray-700'; div.appendChild(checkbox); div.appendChild(label); importDiscussionList.appendChild(div); }); confirmImportBtn.disabled = importDiscussionList.childElementCount === 0; }
                 importPreviewArea.style.display = 'block'; showStatus('', 'info', importStatus);
            } catch (error) { console.error("Error reading import file:", error); showStatus(translate('import_error_reading_file', `Error reading file: ${error.message}`, {message: error.message}), 'error', importStatus); parsedImportData = null; confirmImportBtn.disabled = true; }
        };
        confirmImportBtn.onclick = async () => { 
             if (!parsedImportData || !importFile.files[0]) return;
             const selectedOriginalIds = Array.from(importDiscussionList.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value); if (selectedOriginalIds.length === 0) { showStatus(translate('import_select_one_discussion_error'), 'error', importStatus); return; }
             showStatus(translate('status_importing_discussions', 'Importing discussions...'), 'info', importStatus); confirmImportBtn.disabled = true;
             try {
                const importRequest = { discussion_ids_to_import: selectedOriginalIds }; const formData = new FormData(); formData.append('import_file', importFile.files[0]); formData.append('import_request_json', JSON.stringify(importRequest));
                 const response = await apiRequest('/api/discussions/import', { method: 'POST', body: formData, statusElement: importStatus });
                 const result = await response.json(); showStatus(result.message || translate('status_import_count_success', `Imported ${result.imported_count} discussions.`, {count: result.imported_count}), 'success', importStatus); console.log("Import errors/skipped:", result.errors);
                 await loadDiscussions(); setTimeout(() => closeModal('importModal'), 2000);
             } catch (error) { console.error("Import failed:", error); confirmImportBtn.disabled = false; }
        };


        // --- Utilities ---
        function scrollChatToBottom() { requestAnimationFrame(() => { chatMessages.scrollTop = chatMessages.scrollHeight; }); }
        function showStatus(msg, type = 'info', statusElement = statusMessage) {
            const targetElement = statusElement || statusMessage; if (targetElement) { targetElement.textContent = msg; let typeClass = 'text-gray-600'; if (type === 'error') typeClass = 'text-red-600'; else if (type === 'success') typeClass = 'text-green-600'; else if (type === 'warning') typeClass = 'text-yellow-600'; targetElement.className = targetElement.className.replace(/text-(gray|red|green|yellow)-[0-9]{3}/g, ''); targetElement.classList.add(typeClass); if (targetElement === statusMessage && msg) { clearTimeout(targetElement.timer); targetElement.timer = setTimeout(() => { if (targetElement.textContent === msg) targetElement.textContent = ''; }, 5000); } } else { console.log(`Status [${type}]: ${msg}`); }
        }
        function populateDropdown(selectElement, items, selectedValue, emptyText = "Nothing found", allowEmpty = false) {
            if (!selectElement) { console.error("populateDropdown: selectElement is null"); return; } selectElement.innerHTML = '';
            if (allowEmpty) { const emptyOption = document.createElement('option'); emptyOption.value = ""; emptyOption.textContent = emptyText; selectElement.appendChild(emptyOption); }
            if (!items || !Array.isArray(items) || items.length === 0) { if (!allowEmpty) { const placeholder = document.createElement('option'); placeholder.disabled = true; placeholder.selected = true; placeholder.textContent = emptyText; selectElement.appendChild(placeholder); } }
            else { items.forEach(item => { if (!item || typeof item.name !== 'string') { console.warn(`Dropdown '${selectElement.id}': Skipping invalid item:`, item); return; } const option = document.createElement('option'); option.value = item.name; option.textContent = item.method_name || item.name; if (item.name === selectedValue) { option.selected = true; } selectElement.appendChild(option); }); }
        }
    </script>
</body>
</html>
