<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="appTitle">LoLLMs Chat</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              primary: { light: '#a5b4fc', DEFAULT: '#6366f1', dark: '#4f46e5' },
              secondary: {
                50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1', 400: '#94a3b8',
                500: '#64748b', 600: '#475569', 700: '#334155', 800: '#1e293b', 900: '#0f172a',
                950: '#020617'
              },
              accent: { light: '#6ee7b7', DEFAULT: '#10b981', dark: '#059669' },
              danger: { light: '#fca5a5', DEFAULT: '#ef4444', dark: '#dc2626' },
              warning: { light: '#fcd34d', DEFAULT: '#f59e0b', dark: '#d97706' }
            },
            animation: { 'spin-slow': 'spin 3s linear infinite', 'fade-in': 'fadeIn 0.3s ease-out', 'slide-in': 'slideIn 0.3s ease-out', 'pulse-bg': 'pulseBg 2s infinite ease-in-out' },
            keyframes: { 
                fadeIn: { '0%': { opacity: 0 }, '100%': { opacity: 1 } }, 
                slideIn: { '0%': { transform: 'translateY(20px)', opacity: 0 }, '100%': { transform: 'translateY(0)', opacity: 1 } },
                pulseBg: { '0%, 100%': { backgroundColor: 'theme("colors.primary.DEFAULT / 80%")' }, '50%': { backgroundColor: 'theme("colors.primary.DEFAULT")' } }
            },
            fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui', '-apple-system', 'BlinkMacSystemFont', '"Segoe UI"', 'Roboto', '"Helvetica Neue"', 'Arial', '"Noto Sans"', 'sans-serif', '"Apple Color Emoji"', '"Segoe UI Emoji"', '"Segoe UI Symbol"', '"Noto Color Emoji"'], },
            typography: ({ theme }) => ({
                DEFAULT: { css: { 
                    '--tw-prose-body': theme('colors.secondary.700'), '--tw-prose-headings': theme('colors.secondary.900'), 
                    '--tw-prose-pre-bg': theme('colors.secondary.100'),
                    '--tw-prose-code': theme('colors.primary.dark'), 
                    'code': { 
                        backgroundColor: theme('colors.secondary.100'), padding: '0.1em 0.3em', borderRadius: '0.25rem', border: `1px solid ${theme('colors.secondary.200')}`,
                        fontWeight: '500', color: theme('colors.primary.dark'),
                    },
                    'pre': {
                        backgroundColor: theme('colors.secondary.100') + '!important', // Override for CM parent
                        padding: '0 !important', // Override for CM parent
                        color: theme('colors.secondary.700'),
                        border: `1px solid ${theme('colors.secondary.200')}`,
                        borderRadius: '0.375rem',
                    },
                    'pre code': { // Styles for code inside pre, before CM takes over
                        backgroundColor: 'transparent', padding: '0', border: 'none', color: 'inherit',
                    },
                    'a': {color: theme('colors.primary.DEFAULT')} 
                }},
                invert: { css: { 
                    '--tw-prose-body': theme('colors.secondary.300'), '--tw-prose-headings': theme('colors.secondary.100'),
                    '--tw-prose-pre-bg': theme('colors.secondary.800'),
                    '--tw-prose-code': theme('colors.primary.light'),
                     'code': { 
                        backgroundColor: theme('colors.secondary.800'), border: `1px solid ${theme('colors.secondary.700')}`,
                        fontWeight: '500', color: theme('colors.primary.light'),
                    },
                    'pre': {
                        backgroundColor: theme('colors.secondary.800') + '!important',
                        padding: '0 !important',
                        color: theme('colors.secondary.300'),
                        border: `1px solid ${theme('colors.secondary.700')}`,
                        borderRadius: '0.375rem',
                    },
                    'pre code': {
                         backgroundColor: 'transparent', padding: '0', border: 'none', color: 'inherit',
                    },
                    'a': {color: theme('colors.primary.light')}
                }},
            }),
          }
        }
      }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/neo.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/material-darker.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/meta.js"></script> <!-- For findModeByExtension -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/markdown/markdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/shell/shell.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/sql/sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/yaml/yaml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/runmode/runmode.min.js"></script>


    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: theme('colors.secondary.200'); border-radius: 3px; }
        .dark ::-webkit-scrollbar-track { background: theme('colors.secondary.800'); }
        ::-webkit-scrollbar-thumb { background: theme('colors.secondary.400'); border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: theme('colors.secondary.600'); }
        ::-webkit-scrollbar-thumb:hover { background: theme('colors.secondary.500'); }
        .dark ::-webkit-scrollbar-thumb:hover { background: theme('colors.secondary.500'); }
        
        .prose code::before, .prose code::after { content: none; }
        
        .cm-readonly-display .CodeMirror {
            border-radius: 0.375rem; font-size: 0.875rem; line-height: 1.5;
            height: auto; /* Allow CM to size based on content */
        }
        .cm-readonly-display .CodeMirror-gutters { 
            background-color: theme('colors.secondary.100') !important; 
            border-right: 1px solid theme('colors.secondary.300') !important;
            border-top-left-radius: 0.375rem; border-bottom-left-radius: 0.375rem;
        }
        .dark .cm-readonly-display .CodeMirror-gutters { 
            background-color: theme('colors.secondary.800') !important; 
            border-right: 1px solid theme('colors.secondary.700') !important;
        }
        .cm-readonly-display .CodeMirror-linenumber { color: theme('colors.secondary.500') !important; padding: 0 3px 0 5px; }
        .dark .cm-readonly-display .CodeMirror-linenumber { color: theme('colors.secondary.400') !important; }
        .cm-readonly-display .CodeMirror-scroll { 
            overflow-y: hidden !important; /* Prevent double scrollbars */
            overflow-x: auto !important; 
        }
        /* Ensure CodeMirror themes are applied */
        .cm-s-default.CodeMirror { background-color: theme('colors.secondary.100'); color: theme('colors.secondary.800'); }
        .cm-s-neo.CodeMirror, .cm-s-material-darker.CodeMirror { background-color: theme('colors.secondary.800'); color: theme('colors.secondary.200'); }
        .cm-s-neo .CodeMirror-gutters { background: theme('colors.secondary.800'); border-right: 1px solid theme('colors.secondary.700');}
        .cm-s-material-darker .CodeMirror-gutters { background: #31363f; border-right: 1px solid #444;}
        .cm-s-neo .CodeMirror-cursor { border-left: 1px solid theme('colors.secondary.100'); }
        .cm-s-material-darker .CodeMirror-cursor { border-left: 1px solid #f8f8f0; }


        .loader { border: 3px solid theme('colors.secondary.300'); border-top: 3px solid theme('colors.primary.DEFAULT'); border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        .dark .loader { border-color: theme('colors.secondary.700'); border-top-color: theme('colors.primary.light');}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        textarea { scrollbar-width: thin; scrollbar-color: theme('colors.secondary.400') transparent; }
        .dark textarea { scrollbar-color: theme('colors.secondary.600') transparent; }
        .think-block details { background-color: theme('colors.warning.DEFAULT / 10%'); border: 1px solid theme('colors.warning.DEFAULT / 30%'); border-radius: 6px; margin: 0.5em 0; }
        .dark .think-block details { background-color: theme('colors.warning.dark / 15%'); border-color: theme('colors.warning.dark / 40%');}
        .think-block summary { cursor: pointer; padding: 0.35em 0.7em; font-style: italic; color: theme('colors.secondary.500'); list-style-position: inside; font-weight: 500; }
        .dark .think-block summary { color: theme('colors.secondary.400'); }
        .think-block summary::marker { font-size: 0.8em; }
        .think-block summary:focus { outline: none; box-shadow: 0 0 0 2px theme('colors.primary.DEFAULT / 50%'); }
        .think-block div { padding: 0.5em 0.7em; font-size: 0.9em; white-space: pre-wrap; color: theme('colors.secondary.600'); border-top: 1px dashed theme('colors.warning.DEFAULT / 30%'); margin-top: 0.25em; }
        .dark .think-block div { color: theme('colors.secondary.300'); border-top-color: theme('colors.warning.dark / 40%'); }
        .message-actions { display: none; position: absolute; bottom: 4px; opacity: 0; transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out; z-index: 10; transform: translateY(5px); }
        .message-bubble-outer:hover .message-actions { display: flex; opacity: 0.9; transform: translateY(0); }
        .message-actions:hover { opacity: 1; }
        .user-message .message-actions { right: 4px; }
        .assistant-message .message-actions { left: 4px; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); }
        *:focus-visible { outline: 2px solid theme('colors.primary.DEFAULT'); outline-offset: 2px; border-radius: 4px;}
        .dark *:focus-visible { outline-color: theme('colors.primary.light'); }

        .send-button-loading { animation: pulseBg 1.5s infinite ease-in-out; cursor: not-allowed; }
        .send-button-loading svg:not(.loader) { display: none; }
        .send-button-loading .loader { display: inline-block !important; }
        .initial-load-spinner {
            border: 4px solid theme('colors.secondary.300');
            border-top-color: theme('colors.primary.DEFAULT');
            width: 40px; height: 40px;
        }
        .dark .initial-load-spinner {
            border-color: theme('colors.secondary.600');
            border-top-color: theme('colors.primary.light');
        }
        .image-preview-container { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
        .image-preview-item { position: relative; }
        .image-preview-item img { max-height: 60px; max-width: 80px; border-radius: 4px; border: 1px solid theme('colors.secondary.300'); object-fit: cover; }
        .dark .image-preview-item img { border-color: theme('colors.secondary.600'); }
        .remove-image-btn {
            position: absolute; top: -6px; right: -6px; background-color: theme('colors.danger.DEFAULT'); color: white;
            border-radius: 50%; width: 18px; height: 18px; font-size: 11px; line-height: 16px; text-align: center;
            cursor: pointer; border: 2px solid white; box-shadow: 0 1px 2px rgba(0,0,0,0.2); display: flex; justify-content: center; align-items: center;
        }
        .remove-image-btn:hover { background-color: theme('colors.danger.dark'); }

        .sender-label {
            font-size: 0.75rem; /* text-xs */
            font-weight: 600; /* font-semibold */
            margin-bottom: 0.25rem; /* mb-1 */
            color: theme('colors.secondary.500');
        }
        .dark .sender-label { color: theme('colors.secondary.400'); }
        .user-message .sender-label { text-align: right; margin-right: 0.5rem; /* Adjust as needed */ }
        .assistant-message .sender-label { text-align: left; margin-left: 0.5rem; /* Adjust as needed */ }

    </style>
</head>
<body class="bg-secondary-100 dark:bg-secondary-900 text-secondary-900 dark:text-secondary-100 font-sans antialiased overflow-hidden">

    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white dark:bg-secondary-800 p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-sm animate-fade-in">
            <div class="text-center mb-6">
                <img src="/logo.png" alt="App Logo" class="mx-auto h-16 w-auto mb-4">
                <h2 class="text-2xl sm:text-3xl font-bold text-secondary-900 dark:text-white" data-i18n="loginTitle">Login</h2>
            </div>
            <form id="login-form-tag">
                <div class="space-y-4">
                    <input type="text" id="username" name="username" required autocomplete="username" class="w-full px-4 py-2.5 border border-secondary-300 dark:border-secondary-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-secondary-700 placeholder-secondary-400 dark:placeholder-secondary-500" data-i18n-placeholder="usernamePlaceholder">
                    <input type="password" id="password" name="password" required autocomplete="current-password" class="w-full px-4 py-2.5 border border-secondary-300 dark:border-secondary-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-secondary-700 placeholder-secondary-400 dark:placeholder-secondary-500" data-i18n-placeholder="passwordPlaceholder">
                </div>
                <button type="submit" id="login-button" class="mt-6 w-full bg-primary hover:bg-primary-dark text-white font-semibold py-2.5 px-4 rounded-lg transition duration-150 ease-in-out focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary-light dark:focus-visible:ring-offset-secondary-800 flex items-center justify-center">
                    <span data-i18n="loginButton">Login</span>
                    <div id="login-spinner" class="loader ml-2 hidden" style="width:20px; height:20px; border-width:2px;"></div>
                </button>
                <p id="login-error" class="text-danger text-sm mt-3 text-center hidden"></p>
            </form>
        </div>
    </div>
    
    <div id="initial-loading-overlay" class="fixed inset-0 z-[60] flex flex-col items-center justify-center p-4 modal-backdrop hidden">
        <div class="initial-load-spinner loader animate-spin rounded-full"></div>
        <p class="mt-4 text-white text-lg" data-i18n="initializingApp">Initializing Application...</p>
    </div>

    <div id="app-container" class="flex h-screen hidden">
        <aside id="sidebar" class="w-64 sm:w-72 bg-secondary-800 dark:bg-secondary-950 text-secondary-300 flex flex-col p-3 sm:p-4 border-r border-secondary-700 dark:border-secondary-800 shadow-lg shrink-0">
            <img src="/logo.png" alt="Logo" class="mx-auto h-10 w-auto mb-4">
            <div id="user-info" class="p-2 text-center text-sm mb-3">
                <span data-i18n="welcomeMessage">Welcome</span>, <span id="user-display-name" class="font-semibold text-primary-light">User</span>!
            </div>
            <button id="new-discussion-btn" class="w-full flex items-center justify-center space-x-2 bg-primary hover:bg-primary-dark text-white font-medium py-2 px-3 rounded-lg transition duration-150 mb-3 text-sm shadow hover:shadow-md">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span data-i18n="newDiscussionButton">New Discussion</span>
            </button>
            <h2 class="text-xs font-semibold uppercase text-secondary-500 dark:text-secondary-400 pt-2 pb-1 px-1 tracking-wider" data-i18n="discussionsTitle">Discussions</h2>
            <div id="discussion-list-container" class="flex-grow overflow-y-auto space-y-1 -mr-2 pr-2">
                 <ul id="discussion-list"></ul>
                 <p id="discussion-list-loader" class="text-center text-xs text-secondary-400 hidden" data-i18n="loadingDiscussions">Loading discussions...</p>
            </div>
            <div class="mt-auto pt-4 space-y-2 border-t border-secondary-700 dark:border-secondary-800">
                 <button id="file-manager-btn" class="w-full flex items-center justify-start space-x-3 bg-secondary-700 hover:bg-secondary-600 dark:bg-secondary-850 dark:hover:bg-secondary-700 text-secondary-300 dark:text-secondary-200 text-xs py-2 px-3 rounded-md transition duration-150">
                    <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>
                    <span data-i18n="fileManagerButton">File Manager</span>
                </button>
                 <button id="settings-btn" class="w-full flex items-center justify-start space-x-3 bg-secondary-700 hover:bg-secondary-600 dark:bg-secondary-850 dark:hover:bg-secondary-700 text-secondary-300 dark:text-secondary-200 text-xs py-2 px-3 rounded-md transition duration-150">
                    <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826 3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span data-i18n="settingsMenu">Settings</span>
                </button>
                <button id="export-discussions-btn-modal-trigger" class="w-full flex items-center justify-start space-x-3 bg-secondary-700 hover:bg-secondary-600 dark:bg-secondary-850 dark:hover:bg-secondary-700 text-secondary-300 dark:text-secondary-200 text-xs py-2 px-3 rounded-md transition duration-150">
                    <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    <span data-i18n="exportDiscussionsButton">Export Data</span>
                </button>
                 <button id="theme-toggle-btn" class="w-full flex items-center justify-start space-x-3 bg-secondary-700 hover:bg-secondary-600 dark:bg-secondary-850 dark:hover:bg-secondary-700 text-secondary-300 dark:text-secondary-200 text-xs py-2 px-3 rounded-md transition duration-150">
                    <svg class="w-4 h-4 block dark:hidden shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <svg class="w-4 h-4 hidden dark:block shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    <span data-i18n="toggleTheme">Toggle Theme</span>
                </button>
                 <button id="admin-btn" class="w-full flex items-center justify-start space-x-3 bg-yellow-500 hover:bg-yellow-600 dark:bg-yellow-600 dark:hover:bg-yellow-700 text-white text-xs py-2 px-3 rounded-md transition duration-150 hidden">
                    <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                    <span data-i18n="adminButton">Admin Panel</span>
                </button>
                <button id="logout-btn" class="w-full flex items-center justify-start space-x-3 bg-danger/80 hover:bg-danger text-white text-xs py-2 px-3 rounded-md transition duration-150 mt-2">
                   <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    <span data-i18n="logoutButton">Logout</span>
                </button>
            </div>
        </aside>

        <main id="main-content" class="flex-grow flex flex-col bg-white dark:bg-secondary-900 overflow-hidden">
            <div id="chat-header" class="p-3 sm:p-4 border-b border-secondary-200 dark:border-secondary-800 text-base sm:text-lg font-semibold text-secondary-700 dark:text-secondary-200 flex items-center justify-between shrink-0 shadow-sm">
                <span id="chat-title-text" class="truncate mr-2" data-i18n="selectDiscussionPrompt">Select a discussion...</span>
                <button id="edit-chat-title-btn" class="ml-2 p-1.5 text-secondary-500 hover:text-primary dark:hover:text-primary-light focus:outline-none rounded-md hidden transition-colors" data-i18n-title="editTitleTooltip">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                </button>
            </div>
            <div id="chat-messages" class="flex-grow p-3 sm:p-4 md:p-6 space-y-4 overflow-y-auto bg-secondary-50 dark:bg-secondary-850">
                 <p id="chat-messages-placeholder" class="text-center text-secondary-500 dark:text-secondary-400" data-i18n="noMessagesYet">No messages yet. Start the conversation!</p>
            </div>
            <div class="p-3 sm:p-4 border-t border-secondary-200 dark:border-secondary-800 bg-secondary-100 dark:bg-secondary-900 shrink-0">
                <div id="image-preview-area" class="image-preview-container mb-2 hidden">
                </div>
                <div class="flex items-end space-x-2 sm:space-x-3">
                    <button id="image-upload-btn" title="Attach Images" class="p-2.5 text-secondary-500 hover:text-primary dark:hover:text-primary-light rounded-lg border border-secondary-300 dark:border-secondary-600 bg-white dark:bg-secondary-700 hover:bg-secondary-50 dark:hover:bg-secondary-600 transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-primary">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    </button>
                    <input type="file" id="image-upload-input" accept="image/*" multiple class="hidden">
                    
                    <textarea id="message-input" class="flex-grow p-2.5 sm:p-3 text-sm sm:text-base border border-secondary-300 dark:border-secondary-600 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-secondary-700 resize-none transition-shadow shadow-sm focus:shadow-md" rows="1" data-i18n-placeholder="typeYourMessage" disabled></textarea>
                    <button id="send-button" class="bg-primary hover:bg-primary-dark text-white font-semibold p-2.5 sm:p-3 rounded-xl flex items-center justify-center transition duration-150 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary-light dark:focus-visible:ring-offset-secondary-900 disabled:opacity-50 disabled:cursor-not-allowed shadow hover:shadow-md" disabled>
                        <svg class="w-5 h-5 icon-send" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                         <div class="loader w-5 h-5 hidden" style="border-width: 2px;"></div>
                    </button>
                </div>
                <div id="rag-toggle-container" class="mt-2.5 flex items-center" style="display: none;">
                    <input type="checkbox" id="use-rag-checkbox" class="h-4 w-4 text-primary border-secondary-300 dark:border-secondary-600 rounded focus:ring-primary dark:bg-secondary-700 focus:ring-offset-0 dark:focus:ring-offset-secondary-900">
                    <label for="use-rag-checkbox" class="ml-2 text-xs sm:text-sm text-secondary-600 dark:text-secondary-300 select-none cursor-pointer" data-i18n="ragToggleLabel">Use RAG</label>
                </div>
            </div>
        </main>
    </div>

    <div id="settings-modal" class="fixed inset-0 z-40 flex items-center justify-center p-4 hidden modal-backdrop animate-fade-in">
        <div class="bg-white dark:bg-secondary-800 p-5 sm:p-6 rounded-xl shadow-2xl w-full max-w-lg space-y-4 sm:space-y-5 transform transition-all max-h-[90vh] overflow-y-auto animate-slide-in">
            <div class="flex justify-between items-center pb-3 border-b border-secondary-200 dark:border-secondary-700">
                <h3 class="text-lg sm:text-xl font-semibold" data-i18n="settingsMenu">Settings</h3>
                <button id="close-settings-btn" class="text-secondary-400 hover:text-secondary-600 dark:hover:text-secondary-300 p-1 rounded-full">
                     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="space-y-4">
                 <div>
                    <label for="language-select" class="block text-xs sm:text-sm font-medium text-secondary-700 dark:text-secondary-300 mb-1" data-i18n="languageLabel">Language</label>
                    <select id="language-select" class="w-full p-2 text-sm border border-secondary-300 dark:border-secondary-600 rounded-md focus:ring-1 focus:ring-primary focus:border-primary dark:bg-secondary-700">
                        <option value="en">English</option><option value="fr">Français</option>
                    </select>
                </div>
                 <div>
                    <label for="lollms-model-select" class="block text-xs sm:text-sm font-medium text-secondary-700 dark:text-secondary-300 mb-1" data-i18n="lollmsModelLabel">LoLLMs Model:</label>
                    <select id="lollms-model-select" class="w-full p-2 text-sm border border-secondary-300 dark:border-secondary-600 rounded-md focus:ring-1 focus:ring-primary focus:border-primary dark:bg-secondary-700"></select>
                    <button id="set-lollms-model-btn" class="mt-1.5 w-full bg-primary/80 hover:bg-primary text-white py-1.5 rounded-md text-xs font-medium shadow-sm hover:shadow" data-i18n="setModelButton">Set Model</button>
                </div>
                 <div>
                    <label for="vectorizer-select" class="block text-xs sm:text-sm font-medium text-secondary-700 dark:text-secondary-300 mb-1" data-i18n="activeVectorizerLabel">Active RAG Vectorizer:</label>
                    <select id="vectorizer-select" class="w-full p-2 text-sm border border-secondary-300 dark:border-secondary-600 rounded-md focus:ring-1 focus:ring-primary focus:border-primary dark:bg-secondary-700"></select>
                    <input type="text" id="new-vectorizer-name" data-i18n-placeholder="newVectorizerPlaceholder" class="mt-1.5 w-full p-2 text-sm border border-secondary-300 dark:border-secondary-600 rounded-md focus:ring-1 focus:ring-primary focus:border-primary dark:bg-secondary-700 placeholder-secondary-400 dark:placeholder-secondary-500">
                    <button id="set-vectorizer-btn" class="mt-1.5 w-full bg-accent/80 hover:bg-accent text-white py-1.5 rounded-md text-xs font-medium shadow-sm hover:shadow" data-i18n="setVectorizerButton">Set Active Vectorizer</button>
                </div>
                 <p id="settings-status" class="text-xs text-center text-secondary-600 dark:text-secondary-400 min-h-[1rem]"></p>
            </div>
        </div>
    </div>

     <div id="file-manager-modal" class="fixed inset-0 z-40 flex items-center justify-center p-4 hidden modal-backdrop animate-fade-in">
        <div class="bg-white dark:bg-secondary-800 p-5 sm:p-6 rounded-xl shadow-2xl w-full max-w-xl space-y-4 sm:space-y-5 transform transition-all max-h-[90vh] flex flex-col animate-slide-in">
            <div class="flex justify-between items-center pb-3 border-b border-secondary-200 dark:border-secondary-700 shrink-0">
                <h3 class="text-lg sm:text-xl font-semibold" data-i18n="fileManagerTitle">RAG File Manager</h3>
                 <button id="close-file-manager-btn" class="text-secondary-400 hover:text-secondary-600 dark:hover:text-secondary-300 p-1 rounded-full">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                 </button>
            </div>
            <div id="rag-file-list-container" class="flex-grow overflow-y-auto border border-secondary-300 dark:border-secondary-600 rounded-md p-2 min-h-[150px]">
                <ul id="rag-file-list" class="space-y-1"></ul>
                <p id="rag-list-loader" class="text-center text-xs text-secondary-400 hidden" data-i18n="loadingFiles">Loading files...</p>
            </div>
             <div class="pt-3 border-t border-secondary-200 dark:border-secondary-700 shrink-0 space-y-2">
                 <label class="block text-xs sm:text-sm font-medium text-secondary-700 dark:text-secondary-300" data-i18n="addDocumentLabel">Add Document(s)/Folder:</label>
                 <div class="flex flex-col sm:flex-row gap-2">
                    <input type="file" id="file-upload-input-fm" multiple class="flex-grow text-xs sm:text-sm text-secondary-500 dark:text-secondary-400 file:mr-3 file:py-1.5 file:px-3 file:rounded-md file:border-0 file:text-xs file:font-semibold file:bg-primary/80 file:text-white hover:file:bg-primary file:cursor-pointer dark:file:bg-secondary-600 dark:file:text-secondary-200 dark:hover:file:bg-secondary-500 border border-secondary-300 dark:border-secondary-600 rounded-md">
                     <input type="file" id="folder-upload-input" webkitdirectory directory style="display:none;">
                    <button id="upload-folder-btn" class="shrink-0 bg-blue-500 hover:bg-blue-600 text-white py-1.5 px-3 rounded-md text-xs flex items-center justify-center gap-1 shadow-sm hover:shadow" data-i18n-title="uploadFolderTooltip">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>
                        <span data-i18n="uploadFolderButton">Folder</span>
                    </button>
                </div>
                <button id="upload-document-btn" class="w-full bg-accent hover:bg-accent-dark text-white py-1.5 rounded-md text-xs flex items-center justify-center gap-1 font-medium shadow hover:shadow-md" data-i18n="uploadDocumentButton">
                     <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    <span>Upload Selected File(s)</span>
                </button>
                <p id="upload-status" class="text-xs text-center text-secondary-600 dark:text-secondary-400 min-h-[1rem]"></p>
            </div>
        </div>
    </div>

    <div id="export-modal" class="fixed inset-0 z-40 flex items-center justify-center p-4 hidden modal-backdrop animate-fade-in">
        <div class="bg-white dark:bg-secondary-800 p-5 sm:p-6 rounded-xl shadow-2xl w-full max-w-lg space-y-4 sm:space-y-5 transform transition-all max-h-[90vh] flex flex-col animate-slide-in">
            <div class="flex justify-between items-center pb-3 border-b border-secondary-200 dark:border-secondary-700 shrink-0">
                <h3 class="text-lg sm:text-xl font-semibold" data-i18n="exportDiscussionsTitle">Export Discussions</h3>
                <button id="close-export-modal-btn" class="text-secondary-400 hover:text-secondary-600 dark:hover:text-secondary-300 p-1 rounded-full">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="export-discussion-list-container" class="flex-grow overflow-y-auto border border-secondary-300 dark:border-secondary-600 rounded-md p-3 min-h-[200px]">
                <div id="export-discussion-list-loader" class="text-center hidden"><span class="loader"></span> <span data-i18n="loadingDiscussions">Loading...</span></div>
                <ul id="export-discussion-list" class="space-y-1"></ul>
            </div>
            <div class="flex justify-between items-center pt-3 border-t border-secondary-200 dark:border-secondary-700 shrink-0">
                <div>
                    <button id="export-select-all-btn" class="text-xs text-primary hover:underline" data-i18n="selectAll">Select All</button>
                    <span class="mx-1 text-xs text-secondary-400">|</span>
                    <button id="export-select-none-btn" class="text-xs text-primary hover:underline" data-i18n="selectNone">Select None</button>
                </div>
                <button id="confirm-export-btn" class="bg-accent hover:bg-accent-dark text-white font-semibold py-2 px-4 rounded-lg text-sm shadow hover:shadow-md" data-i18n="exportSelectedButton">Export Selected</button>
            </div>
             <p id="export-status" class="text-xs text-center text-secondary-600 dark:text-secondary-400 min-h-[1rem]"></p>
        </div>
    </div>

<script>
    const $ = (selector) => document.getElementById(selector);
    const loginScreen = $('login-screen'), loginFormTag = $('login-form-tag'),
          loginButton = $('login-button'), loginSpinner = $('login-spinner'), loginError = $('login-error'),
          usernameInput = $('username'), passwordInput = $('password');
    const initialLoadingOverlay = $('initial-loading-overlay');
    const appContainer = $('app-container'), sidebar = $('sidebar'),
          mainContent = $('main-content'), userDisplayName = $('user-display-name');
    const discussionListContainer = $('discussion-list-container'), 
          discussionList = $('discussion-list'), discussionListLoader = $('discussion-list-loader'),
          newDiscussionBtn = $('new-discussion-btn'),
          exportDiscussionsBtnModalTrigger = $('export-discussions-btn-modal-trigger'), 
          settingsBtn = $('settings-btn'), fileManagerBtn = $('file-manager-btn'), 
          themeToggleBtn = $('theme-toggle-btn'), logoutBtn = $('logout-btn'), adminBtn = $('admin-btn');
    const chatHeader = $('chat-header'), chatTitleText = $('chat-title-text'),
          editChatTitleBtn = $('edit-chat-title-btn'), chatMessages = $('chat-messages'),
          chatMessagesPlaceholder = $('chat-messages-placeholder'),
          messageInput = $('message-input'), sendButton = $('send-button'),
          sendLoader = $('send-loader'), useRagCheckbox = $('use-rag-checkbox'),
          ragToggleContainer = $('rag-toggle-container');
    const imageUploadBtn = $('image-upload-btn'), imageUploadInput = $('image-upload-input'),
          imagePreviewArea = $('image-preview-area');
    const settingsModal = $('settings-modal'), closeSettingsBtn = $('close-settings-btn'),
          languageSelect = $('language-select'), lollmsModelSelect = $('lollms-model-select'),
          setLollmsModelBtn = $('set-lollms-model-btn'), vectorizerSelect = $('vectorizer-select'),
          newVectorizerNameInput = $('new-vectorizer-name'), setVectorizerBtn = $('set-vectorizer-btn'),
          settingsStatus = $('settings-status');
    const fileManagerModal = $('file-manager-modal'), closeFileManagerBtn = $('close-file-manager-btn'),
          fileUploadInputFM = $('file-upload-input-fm'),
          folderUploadInput = $('folder-upload-input'),
          uploadFolderBtn = $('upload-folder-btn'), uploadDocumentBtn = $('upload-document-btn'),
          uploadStatus = $('upload-status'), ragFileList = $('rag-file-list'), ragListLoader = $('rag-list-loader');
    const exportModal = $('export-modal'), closeExportModalBtn = $('close-export-modal-btn'),
          exportDiscussionListContainer = $('export-discussion-list-container'),
          exportDiscussionList = $('export-discussion-list'), exportDiscussionListLoader = $('export-discussion-list-loader'),
          exportSelectAllBtn = $('export-select-all-btn'), exportSelectNoneBtn = $('export-select-none-btn'),
          confirmExportBtn = $('confirm-export-btn'), exportStatus = $('export-status');

    let currentAuth = null;
    let currentDiscussionId = null;
    let currentUserDetails = null; 
    let currentLanguage = localStorage.getItem('preferredLanguage') || navigator.language.split('-')[0] || 'en';
    let translations = {};
    let isSendingMessage = false;
    let attachedImageFiles = []; 
    let codeMirrorInstances = {}; // To manage CM instances for debounce/updates


    async function apiRequest(url, options = {}) {
        if (!currentAuth && !url.startsWith('./locales/')) {
            console.error("Authentication token not set for API request to:", url);
            showFlashMessage(t('authError') || "Authentication error. Please log in again.", 'error');
            showLoginScreen(); 
            throw new Error("Not authenticated for API request.");
        }

        const defaultHeaders = {};
        if (!(options.body instanceof FormData) && !url.startsWith('./locales/')) {
            defaultHeaders['Content-Type'] = 'application/json';
        }
        if (currentAuth && !url.startsWith('./locales/')) {
            defaultHeaders['Authorization'] = `Basic ${currentAuth}`;
        }

        const mergedOptions = { ...options, headers: { ...defaultHeaders, ...options.headers } };
        if (mergedOptions.body && !(mergedOptions.body instanceof FormData) && mergedOptions.headers['Content-Type'] === 'application/json') {
            mergedOptions.body = JSON.stringify(mergedOptions.body);
        }
        
        try {
            const response = await fetch(url, mergedOptions);
            if (response.status === 401 && !url.startsWith('./locales/')) {
                showFlashMessage(t('authError') || "Authentication error. Please log in again.", 'error');
                showLoginScreen();
                throw new Error("Authentication failed or token expired.");
            }
            return response;
        } catch (error) {
            console.error("API Request Fetch Error:", error, "URL:", url);
            if (!(error.message.includes("Authentication failed") || error.message.includes("Not authenticated"))) {
                 showFlashMessage(t('networkError', {error: error.message || 'Unknown fetch error'}), 'error', 7000);
            }
            throw error;
        }
    }

    async function loadTranslations(lang) {
        try {
            const response = await apiRequest(`./locales/${lang}.json`);
            if (!response.ok) throw new Error(`Failed to load ${lang}.json`);
            translations = await response.json();
            currentLanguage = lang;
            localStorage.setItem('preferredLanguage', lang);
            applyTranslations();
            document.documentElement.lang = lang;
        } catch (error) {
            console.error('Error loading translations:', error);
            if (lang !== 'en') await loadTranslations('en'); 
        }
    }

    function t(key, params = {}) {
        let text = translations[key] || key; 
        for (const param in params) {
            text = text.replace(new RegExp(`{${param}}`, 'g'), params[param]);
        }
        return text;
    }

    function applyTranslations() {
        document.querySelectorAll('[data-i18n]').forEach(el => {
            el.textContent = t(el.dataset.i18n);
        });
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
            el.placeholder = t(el.dataset.i18nPlaceholder);
        });
        document.querySelectorAll('[data-i18n-title]').forEach(el => {
            el.title = t(el.dataset.i18nTitle);
        });
        document.title = t('appTitle'); 

        if (chatTitleText && !currentDiscussionId) chatTitleText.textContent = t('selectDiscussionPrompt');
        if (chatMessagesPlaceholder && chatMessages.children.length === 1 && chatMessages.firstChild === chatMessagesPlaceholder) {
            chatMessagesPlaceholder.textContent = t('noMessagesYet');
        }
        if (discussionListLoader.classList.contains('hidden') && discussionList.children.length === 0) {
             discussionList.innerHTML = `<li class="text-center text-xs text-secondary-400 p-2">${t('noDiscussionsFound')}</li>`;
        }
        messageInput.disabled = !currentDiscussionId || isSendingMessage;
        sendButton.disabled = !currentDiscussionId || isSendingMessage || (!messageInput.value.trim() && attachedImageFiles.length === 0);
    }

    languageSelect.addEventListener('change', (e) => loadTranslations(e.target.value));

    function showFlashMessage(message, type = 'info', duration = 5000) {
        const flashDiv = document.createElement('div');
        let bgColor = 'bg-primary text-white'; 
        if (type === 'success') bgColor = 'bg-accent text-white';
        else if (type === 'error') bgColor = 'bg-danger text-white';
        else if (type === 'warning') bgColor = 'bg-warning text-secondary-900';
        
        flashDiv.className = `fixed bottom-4 right-4 p-3 rounded-lg shadow-lg text-sm z-[100] animate-fade-in ${bgColor}`;
        flashDiv.textContent = message;
        document.body.appendChild(flashDiv);
        setTimeout(() => {
            flashDiv.style.transition = 'opacity 0.5s ease-out';
            flashDiv.style.opacity = '0';
            setTimeout(() => flashDiv.remove(), 500);
        }, duration);
    }

    function updateStatus(elementId, message, type = 'info', duration = 5000) {
        const statusElement = $(elementId);
        if (!statusElement) return;
        statusElement.textContent = message;
        let textColor = 'text-secondary-600 dark:text-secondary-400'; 
        if (type === 'success') textColor = 'text-accent dark:text-accent-light';
        else if (type === 'error') textColor = 'text-danger dark:text-danger-light';
        else if (type === 'warning') textColor = 'text-warning dark:text-warning-light';
        statusElement.className = `text-xs text-center min-h-[1rem] ${textColor}`;
        if (duration > 0 && message) { 
            setTimeout(() => { if (statusElement.textContent === message) statusElement.textContent = ''; }, duration);
        } else if (!message) { 
            statusElement.textContent = '';
        }
    }

     function applyTheme(theme) {
        if (theme === 'dark') {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
        localStorage.setItem('theme', theme);
        document.querySelectorAll('.CodeMirror').forEach(cmWrapper => {
            const cmInstance = cmWrapper.CodeMirror;
            if (cmInstance) {
                cmInstance.setOption("theme", theme === 'dark' ? 'material-darker' : 'default');
            }
        });
    }

    themeToggleBtn.addEventListener('click', () => {
        const isDark = document.documentElement.classList.contains('dark');
        applyTheme(isDark ? 'light' : 'dark');
    });

    function showLoginScreen() {
        currentAuth = null; currentUserDetails = null; currentDiscussionId = null;
        loginScreen.classList.remove('hidden');
        initialLoadingOverlay.classList.add('hidden');
        appContainer.classList.add('hidden');
        settingsModal.classList.add('hidden');
        fileManagerModal.classList.add('hidden');
        exportModal.classList.add('hidden');
        discussionList.innerHTML = ''; chatMessages.innerHTML = '';
        chatTitleText.textContent = t('selectDiscussionPrompt'); 
        editChatTitleBtn.classList.add('hidden');
        messageInput.disabled = true; sendButton.disabled = true; 
        usernameInput.value = ''; passwordInput.value = '';
        loginError.textContent = ''; loginError.classList.add('hidden'); 
        loginButton.disabled = false; loginSpinner.classList.add('hidden');
        adminBtn.classList.add('hidden'); 
        clearImagePreviews(); 
    }

    loginFormTag.addEventListener('submit', async (e) => {
        e.preventDefault(); 
        loginButton.disabled = true; loginSpinner.classList.remove('hidden');
        loginError.classList.add('hidden');
        const usernameVal = usernameInput.value, passwordVal = passwordInput.value;
        if (!usernameVal || !passwordVal) {
            loginError.textContent = t('credentialsRequiredError'); loginError.classList.remove('hidden');
            loginButton.disabled = false; loginSpinner.classList.add('hidden'); return;
        }
        currentAuth = btoa(`${usernameVal}:${passwordVal}`);
        try {
            const response = await apiRequest('/api/auth/me');
            if (!response.ok) {
                 const errorData = await response.json().catch(() => ({ detail: t('invalidCredentialsError') }));
                 loginError.textContent = errorData.detail || t('invalidCredentialsError');
                 loginError.classList.remove('hidden');
                 currentAuth = null; 
                 loginButton.disabled = false; loginSpinner.classList.add('hidden');
                 return;
            }
            currentUserDetails = await response.json();
            userDisplayName.textContent = currentUserDetails.username;
            adminBtn.classList.toggle('hidden', !currentUserDetails.is_admin);
            
            loginScreen.classList.add('hidden');
            initialLoadingOverlay.classList.remove('hidden');

            languageSelect.value = localStorage.getItem('preferredLanguage') || currentUserDetails.language || currentLanguage;
            await loadTranslations(languageSelect.value);
            
            await Promise.all([
                loadDiscussions(),
                loadLollmsModels(),
                loadStoreVectorizers()
            ]);
            
            ragToggleContainer.style.display = currentUserDetails.safe_store_vectorizer ? 'flex' : 'none';
            useRagCheckbox.checked = !!currentUserDetails.safe_store_vectorizer;

            initialLoadingOverlay.classList.add('hidden');
            appContainer.classList.remove('hidden');      

            chatTitleText.textContent = t('selectDiscussionPrompt');
            editChatTitleBtn.classList.add('hidden');
            messageInput.disabled = true;
            sendButton.disabled = true;
            updateSendButtonState();

            showFlashMessage(t('loginSuccess'), 'success');

        } catch (error) {
            if (!error.message.includes("Authentication failed") && !error.message.includes("Not authenticated")) {
                loginError.textContent = t('loginFailedError');
                loginError.classList.remove('hidden');
            }
            currentAuth = null; 
        } finally {
            loginButton.disabled = false; loginSpinner.classList.add('hidden');
        }
    });

    logoutBtn.addEventListener('click', showLoginScreen);
    adminBtn.addEventListener('click', () => window.open('/admin', '_blank'));

    async function loadDiscussions(selectLastActive = false) {
        discussionListLoader.classList.remove('hidden');
        discussionList.innerHTML = '';
        try {
            const response = await apiRequest('/api/discussions');
            if (!response.ok) { 
                console.error("Failed to load discussions, status:", response.status); 
                discussionList.innerHTML = `<li class="text-center text-xs text-danger p-2">${t('discussionLoadError')}</li>`;
                return; 
            }
            const discussions = await response.json();
            if (discussions.length === 0) {
                discussionList.innerHTML = `<li class="text-center text-xs text-secondary-400 p-2">${t('noDiscussionsFound')}</li>`;
            } else {
                discussions.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
                discussions.forEach(disc => discussionList.appendChild(renderDiscussionListItem(disc)));
            }
            
            if (selectLastActive && currentDiscussionId) {
                const stillExists = discussions.some(d => d.id === currentDiscussionId);
                if (stillExists) {
                    await selectDiscussion(currentDiscussionId, false);
                } else {
                    currentDiscussionId = null; 
                }
            }
            if (!currentDiscussionId) { 
                clearChatArea();
            }

        } catch (error) { 
            console.error('Failed to load discussions:', error); 
            discussionList.innerHTML = `<li class="text-center text-xs text-danger p-2">${t('discussionLoadError')}</li>`;
        } finally {
            discussionListLoader.classList.add('hidden');
        }
    }

    function renderDiscussionListItem(disc) {
        const li = document.createElement('li');
        const isActive = disc.id === currentDiscussionId;
        li.className = `group p-2 rounded-lg cursor-pointer flex justify-between items-center text-sm transition-colors duration-150 ${
            isActive ? 'bg-primary text-white font-medium' : 'text-secondary-300 hover:bg-secondary-700 hover:text-white'
        }`;
        li.dataset.id = disc.id;

        const titleSpan = document.createElement('span');
        titleSpan.className = "truncate mr-2 flex-grow";
        titleSpan.textContent = disc.title || t('untitledDiscussion', {id: disc.id.substring(0,8)});
        li.appendChild(titleSpan);

        const deleteBtn = document.createElement('button');
        deleteBtn.className = `shrink-0 text-secondary-500 hover:text-danger opacity-0 group-hover:opacity-100 focus:opacity-100 transition-opacity p-1 rounded ${isActive ? 'text-primary-light hover:text-red-300' : ''}`;
        deleteBtn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>`;
        deleteBtn.setAttribute('aria-label', t('deleteDiscussionAriaLabel'));
        deleteBtn.title = t('deleteDiscussionAriaLabel');
        deleteBtn.onclick = async (e) => { e.stopPropagation(); if (confirm(t('deleteDiscussionConfirm', {title: titleSpan.textContent}))) { await deleteDiscussionApi(disc.id); } };
        li.appendChild(deleteBtn);

        li.addEventListener('click', () => selectDiscussion(disc.id, true)); 
        return li;
    }
    
    function clearChatArea() {
        chatMessages.innerHTML = '';
        chatMessagesPlaceholder.textContent = t('noMessagesYet');
        chatMessagesPlaceholder.classList.remove('hidden');
        chatTitleText.textContent = t('selectDiscussionPrompt');
        editChatTitleBtn.classList.add('hidden');
        messageInput.disabled = true;
        sendButton.disabled = true;
        messageInput.value = ''; messageInput.style.height = 'auto';
        clearImagePreviews();
    }

    async function selectDiscussion(discussionId, forceReload = false) {
        if (currentDiscussionId === discussionId && !forceReload && chatMessages.children.length > (chatMessagesPlaceholder.classList.contains('hidden') ? 0:1) ) {
            return;
        }

        currentDiscussionId = discussionId;
        document.querySelectorAll('#discussion-list li').forEach(item => {
            const isSelected = item.dataset.id === discussionId;
            item.classList.toggle('bg-primary', isSelected); item.classList.toggle('text-white', isSelected);
            item.classList.toggle('font-medium', isSelected); item.classList.toggle('text-secondary-300', !isSelected);
            item.classList.toggle('hover:bg-secondary-700', !isSelected); item.classList.toggle('hover:text-white', !isSelected);
        });

        chatMessages.innerHTML = `<p class="text-center text-secondary-500">${t('loadingDiscussion')}</p>`;
        chatMessagesPlaceholder.classList.add('hidden');
        const activeLi = document.querySelector(`#discussion-list li[data-id='${discussionId}'] span`);
        chatTitleText.textContent = activeLi ? activeLi.textContent : t('loadingDiscussion');
        editChatTitleBtn.classList.remove('hidden');
        messageInput.disabled = false; 
        clearImagePreviews(); 

        try {
            const response = await apiRequest(`/api/discussions/${discussionId}`);
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ detail: "Unknown error." }));
                throw new Error(errorData.detail || `Status: ${response.status}`);
            }
            const messages = await response.json();
            chatMessages.innerHTML = ''; 
            if (!Array.isArray(messages)) throw new Error('Messages data is not an array');

            if (messages.length === 0) {
                chatMessagesPlaceholder.textContent = t('noMessagesYet');
                chatMessagesPlaceholder.classList.remove('hidden');
            } else {
                chatMessagesPlaceholder.classList.add('hidden');
                messages.forEach(msg => renderMessage(msg.sender, msg.content, msg.id, false, msg.metadata));
            }
            chatMessages.scrollTop = chatMessages.scrollHeight;
        } catch (error) {
            console.error(`Failed to load messages for discussion ${discussionId}:`, error);
            chatMessages.innerHTML = ''; 
            renderMessage('system', t('errorLoadingDiscussion') + `: ${error.message}`);
            chatTitleText.textContent = t('errorLoadingDiscussion');
            editChatTitleBtn.classList.add('hidden');
            messageInput.disabled = true; 
        }
        updateSendButtonState();
    }

    newDiscussionBtn.addEventListener('click', async () => {
        showFlashMessage(t('creatingNewDiscussion'), 'info');
        try {
            const response = await apiRequest('/api/discussions', { method: 'POST' });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ detail: "Failed to create discussion."}));
                throw new Error(errorData.detail || response.statusText);
            }
            const newDiscussion = await response.json();
            await loadDiscussions(); 
            selectDiscussion(newDiscussion.id, true); 
            showFlashMessage(t('newDiscussionCreated', { title: newDiscussion.title }), 'success');
        } catch (error) {
            console.error('Failed to create new discussion:', error);
            showFlashMessage(t('newDiscussionError', { error: error.message }), 'error');
        }
    });

    async function deleteDiscussionApi(discussionIdToDelete) {
        try {
            const response = await apiRequest(`/api/discussions/${discussionIdToDelete}`, { method: 'DELETE' });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ detail: "Failed to delete discussion."}));
                throw new Error(errorData.detail || response.statusText);
            }
            showFlashMessage((await response.json()).message, 'success');
            if (currentDiscussionId === discussionIdToDelete) {
                currentDiscussionId = null;
                clearChatArea();
            }
            await loadDiscussions(); 
        } catch (error) {
            console.error('Failed to delete discussion:', error);
            showFlashMessage(error.message, 'error');
        }
    }
    
    editChatTitleBtn.addEventListener('click', async () => {
        if (!currentDiscussionId) return;
        const currentTitle = chatTitleText.textContent;
        const newTitle = prompt(t('editTitleTooltip') || "Enter new discussion title:", currentTitle);
        if (newTitle && newTitle.trim() !== "" && newTitle !== currentTitle) {
            try {
                const response = await apiRequest(`/api/discussions/${currentDiscussionId}/title`, {
                    method: 'PUT', body: { title: newTitle.trim() }
                });
                if (!response.ok) throw new Error((await response.json()).detail || "Failed to update title.");
                const updatedInfo = await response.json();
                chatTitleText.textContent = updatedInfo.title;
                const listItemTitle = document.querySelector(`#discussion-list li[data-id='${currentDiscussionId}'] span`);
                if (listItemTitle) listItemTitle.textContent = updatedInfo.title;
                showFlashMessage(t('messageUpdateSuccess'), 'success'); 
            } catch (error) {
                showFlashMessage(error.message, 'error');
            }
        }
    });

    function updateSendButtonState() {
         const hasText = messageInput.value.trim().length > 0;
         const hasImages = attachedImageFiles.length > 0;
         sendButton.disabled = !currentDiscussionId || isSendingMessage || (!hasText && !hasImages);
    }

    messageInput.addEventListener('input', () => { 
        messageInput.style.height = 'auto';
        const maxHeight = 120; 
        messageInput.style.height = `${Math.min(messageInput.scrollHeight, maxHeight)}px`;
        updateSendButtonState();
    });
    messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey && !sendButton.disabled) { e.preventDefault(); sendMessage(); }});
    sendButton.addEventListener('click', () => { if(!sendButton.disabled) sendMessage(); });

    async function sendMessage() {
        const prompt = messageInput.value.trim();
        if (!currentDiscussionId || isSendingMessage || (prompt === "" && attachedImageFiles.length === 0)) return;

        isSendingMessage = true;
        const tempUserMessageId = 'temp-user-' + Date.now();
        chatMessagesPlaceholder.classList.add('hidden');

        renderMessage(
            (currentUserDetails?.username || 'user'),
            prompt,
            tempUserMessageId,
            false, 
            { 
                filenames: attachedImageFiles.map(f => f.name),
                image_count: attachedImageFiles.length,
                image_previews: attachedImageFiles.map(f => f.previewUrl) 
            }
        );

        messageInput.value = ''; messageInput.style.height = 'auto';
        messageInput.disabled = true; 
        sendButton.classList.add('send-button-loading'); 
        updateSendButtonState();

        const formData = new FormData();
        formData.append('prompt', prompt);
        formData.append('use_rag', useRagCheckbox.checked.toString());
        attachedImageFiles.forEach(imgFile => {
            formData.append('files', imgFile.fileObject, imgFile.name);
        });

        clearImagePreviews(); 

        let assistantMessageDiv = null;
        let accumulatedResponseText = "";
        const assistantStreamId = 'assistant-stream-' + Date.now();

        try {
            const response = await fetch(`/api/discussions/${currentDiscussionId}/chat`, {
                method: 'POST',
                headers: { 'Authorization': `Basic ${currentAuth}` },
                body: formData
            });

            if (!response.ok || !response.body) {
                const errorData = await response.json().catch(() => ({ detail: "Unknown server error." }));
                renderMessage('system', t('sendError', { error: errorData.detail || response.statusText }));
                const tempUserMsgEl = $(`message-${tempUserMessageId}`); 
                if (tempUserMsgEl) tempUserMsgEl.remove();
                return;
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let cmUpdateDebounceTimer = null;

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split('\n');

                for (const line of lines) {
                    if (line.trim() === "") continue;
                    try {
                        const data = JSON.parse(line);
                        if (data.type === "chunk") {
                            if (!assistantMessageDiv) {
                                const assistantName = currentUserDetails?.lollms_client_ai_name || 'LoLLMs';
                                chatMessagesPlaceholder.classList.add('hidden');
                                assistantMessageDiv = renderMessage(assistantName, '', assistantStreamId, true);
                            }
                            accumulatedResponseText += data.content;
                            
                            if (cmUpdateDebounceTimer) clearTimeout(cmUpdateDebounceTimer);
                            cmUpdateDebounceTimer = setTimeout(() => {
                                if (assistantMessageDiv) { // Check if div still exists
                                     renderMessageContent(assistantMessageDiv.querySelector('.message-text-content'), accumulatedResponseText, 'assistant');
                                     chatMessages.scrollTop = chatMessages.scrollHeight;
                                }
                            }, 50); // Debounce CM updates slightly

                        } else if (data.type === "error") {
                            if (cmUpdateDebounceTimer) clearTimeout(cmUpdateDebounceTimer);
                            if (assistantMessageDiv && $(`message-${assistantStreamId}`)) {
                                $(`message-${assistantStreamId}`).remove();
                            }
                            renderMessage('system', t('llmError', { error: data.content }));
                            accumulatedResponseText = ""; 
                            break; 
                        }
                    } catch (e) {
                        console.warn("Stream parsing error:", e, "Line:", line);
                    }
                }
            }
            // Final update after loop if any pending
            if (cmUpdateDebounceTimer) clearTimeout(cmUpdateDebounceTimer);
            if (assistantMessageDiv && accumulatedResponseText) {
                 renderMessageContent(assistantMessageDiv.querySelector('.message-text-content'), accumulatedResponseText, 'assistant');
                 chatMessages.scrollTop = chatMessages.scrollHeight;
            }

        } catch (error) {
            console.error('Failed to send message or process stream:', error);
            renderMessage('system', t('networkError', { error: error.message }));
            const tempUserMsgElOnError = $(`message-${tempUserMessageId}`);
            if (tempUserMsgElOnError) tempUserMsgElOnError.remove();
        } finally {
            isSendingMessage = false;
            messageInput.disabled = !currentDiscussionId; 
            sendButton.classList.remove('send-button-loading');
            updateSendButtonState();

            if (currentDiscussionId) {
                 setTimeout(async () => { 
                    await selectDiscussion(currentDiscussionId, true); 
                 }, 150);
            }
        }
    }

    function renderMessage(sender, text, id, isStreaming = false, metadata = {}) {
        const msgOuterDiv = document.createElement('div');
        const messageElementId = `message-${id}`;
        const isUser = sender.toLowerCase() === (currentUserDetails?.username?.toLowerCase() || 'user');
        const aiName = currentUserDetails?.lollms_client_ai_name || 'LoLLMs';

        msgOuterDiv.className = `message-bubble-outer w-full mb-1 group ${isUser ? 'user-message flex flex-col items-end' : 'assistant-message flex flex-col items-start'}`;
        msgOuterDiv.id = messageElementId;

        const senderNameDiv = document.createElement('div');
        senderNameDiv.className = `sender-label px-3 ${isUser ? 'text-right' : 'text-left'}`;
        senderNameDiv.textContent = isUser ? (currentUserDetails?.username || 'User') : aiName;
        msgOuterDiv.appendChild(senderNameDiv);

        const msgBubble = document.createElement('div');
        msgBubble.className = `p-3 rounded-xl max-w-[85%] sm:max-w-[75%] lg:max-w-[70%] break-words shadow-md relative ${
            isUser ? 'bg-primary text-white ml-auto rounded-br-lg' : 
            sender.toLowerCase() === 'system' ? 'bg-warning/20 dark:bg-warning/30 text-warning-dark dark:text-warning-light text-xs italic text-center max-w-md mx-auto px-2 py-1 shadow-none rounded-md' :
            'bg-secondary-200 dark:bg-secondary-700 text-secondary-800 dark:text-secondary-100 prose dark:prose-invert max-w-none rounded-bl-lg'
        }`;
        msgBubble.dataset.messageId = id;
        msgBubble.dataset.sender = sender;
        
        if(isUser || sender.toLowerCase() === 'system') {
             msgBubble.dataset.originalContent = text;
        }

        if (isUser && metadata && metadata.image_previews && metadata.image_previews.length > 0) {
            const imgContainer = document.createElement('div');
            imgContainer.className = 'flex flex-wrap gap-2 mb-2';
            metadata.image_previews.forEach(srcUrl => {
                const img = document.createElement('img');
                img.src = srcUrl;
                img.alt = 'Uploaded image';
                img.className = 'max-h-24 max-w-32 rounded border border-primary-light/30 object-cover';
                imgContainer.appendChild(img);
            });
            msgBubble.appendChild(imgContainer);
        }
        
        const textContentDiv = document.createElement('div');
        textContentDiv.className = 'message-text-content';
        renderMessageContent(textContentDiv, text, sender);
        msgBubble.appendChild(textContentDiv);

        if (sender.toLowerCase() !== 'system' && !isStreaming && id && 
            !String(id).startsWith('temp-') && !String(id).startsWith('assistant-stream-')) {
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'message-actions flex gap-1 p-0.5 bg-secondary-100/80 dark:bg-secondary-900/80 rounded-md shadow backdrop-blur-sm';

            const editBtn = document.createElement('button');
            editBtn.innerHTML = `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>`;
            editBtn.className = 'message-action-btn p-1 rounded hover:bg-secondary-200 dark:hover:bg-secondary-700 text-secondary-600 dark:text-secondary-400';
            editBtn.title = t('editMessage');
            editBtn.onclick = (e) => { e.stopPropagation(); editMessage(id, sender, msgBubble); };
            actionsDiv.appendChild(editBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>`;
            deleteBtn.className = 'message-action-btn p-1 rounded hover:bg-secondary-200 dark:hover:bg-secondary-700 text-danger/80 hover:text-danger';
            deleteBtn.title = t('deleteMessage');
            deleteBtn.onclick = (e) => { e.stopPropagation(); deleteMessage(id, msgOuterDiv); };
            actionsDiv.appendChild(deleteBtn);

            msgOuterDiv.appendChild(actionsDiv);
        }

        msgOuterDiv.appendChild(msgBubble);
        chatMessages.appendChild(msgOuterDiv);
        
        const isScrolledToBottom = chatMessages.scrollHeight - chatMessages.clientHeight <= chatMessages.scrollTop + 50; 
        if (isScrolledToBottom || isStreaming || isUser) {
           chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        return msgBubble; 
    }

    function renderMessageContent(targetElement, text, sender) {
        targetElement.innerHTML = ''; 

        const isUser = sender.toLowerCase() === (currentUserDetails?.username?.toLowerCase() || 'user');
        if (isUser || sender.toLowerCase() === 'system') {
            if(text && text.trim() !== "") targetElement.textContent = text;
        } else { 
            let mainContent = text;
            let thinkContent = null;
            const thinkMatch = text.match(/<think>(.*?)<\/think>/is);
            if (thinkMatch && thinkMatch[1]) {
                thinkContent = thinkMatch[1].trim();
                mainContent = text.replace(/<think>.*?<\/think>/is, '').trim();
            }

            if (thinkContent) {
                const details = document.createElement('details');
                details.className = 'think-block';
                const summary = document.createElement('summary');
                summary.textContent = t('assistantThoughts');
                const thinkDiv = document.createElement('div');
                thinkDiv.textContent = thinkContent; 
                details.appendChild(summary);
                details.appendChild(thinkDiv);
                targetElement.appendChild(details);
            }
            
            const contentDiv = document.createElement('div');
            if (mainContent.trim() !== "") {
                if (typeof marked !== 'undefined') {
                    contentDiv.innerHTML = marked.parse(mainContent); 
                } else {
                    contentDiv.textContent = mainContent; 
                }
                targetElement.appendChild(contentDiv);

                contentDiv.querySelectorAll('pre').forEach((preElement, preIndex) => {
                    const codeElement = preElement.querySelector('code');
                    if (!codeElement || preElement.classList.contains('cm-processed')) return;

                    const langClass = Array.from(codeElement.classList).find(cls => cls.startsWith('language-'));
                    const language = langClass ? langClass.substring('language-'.length) : 'plaintext';
                    
                    let cmMode = language;
                    const modeInfo = CodeMirror.findModeByName(language) || CodeMirror.findModeByExtension(language) || CodeMirror.findModeByMIME(language);
                    if(modeInfo) {
                        cmMode = modeInfo.mode;
                        // Ensure mode is loaded if found (may require dynamic script loading for less common modes)
                        if (modeInfo.mode && !CodeMirror.modes[modeInfo.mode] && modeInfo.mime !== 'text/plain') { // Don't try to load 'null' mode
                            // console.warn(`CodeMirror mode '${modeInfo.mode}' for language '${language}' not loaded. Attempting to load.`);
                            // This is where dynamic script loading for CM modes would go if needed.
                            // For now, we rely on pre-loaded common modes.
                        }
                    } else if (language === 'python' || language === 'py') cmMode = 'python';
                    else if (language === 'javascript' || language === 'js') cmMode = 'javascript';
                    else if (language === 'json') cmMode = {name: "javascript", json: true};
                    else if (language === 'html' || language === 'xml') cmMode = 'xml';
                    else if (language === 'css') cmMode = 'css';
                    else if (language === 'markdown' || language === 'md') cmMode = 'markdown';
                    else if (language === 'bash' || language === 'sh' || language === 'shell') cmMode = 'shell';
                    else if (language === 'sql') cmMode = 'sql';
                    else if (language === 'yaml' || language === 'yml') cmMode = 'yaml';
                    else cmMode = 'null'; // Default to plain text like


                    try {
                        CodeMirror(function(elt) {
                           preElement.parentNode.replaceChild(elt, preElement);
                           elt.classList.add('cm-processed'); // Mark as processed
                        }, {
                            value: codeElement.textContent || '',
                            mode: cmMode,
                            theme: document.documentElement.classList.contains('dark') ? 'material-darker' : 'default',
                            lineNumbers: true,
                            readOnly: 'nocursor',
                            scrollbarStyle: "null", 
                            viewportMargin: Infinity 
                        }).getWrapperElement().classList.add('cm-readonly-display', 'prose-code-block', 'max-w-full', 'overflow-x-auto');
                    } catch (e) {
                         console.warn(`CodeMirror init error for mode '${cmMode}':`, e);
                    }
                });
            } else if (!thinkContent && !mainContent.trim()) {
                 targetElement.innerHTML = '<span class="italic opacity-75">...</span>';
            }
        }
    }

    async function editMessage(messageId, sender, bubbleElement) {
        const textContentElement = bubbleElement.querySelector('.message-text-content');
        const originalContent = textContentElement ? (bubbleElement.dataset.originalContent || textContentElement.textContent) : (bubbleElement.dataset.originalContent || '');

        const newContent = prompt(t('editMessagePrompt'), originalContent);
        if (newContent === null || newContent.trim() === "" || newContent.trim() === originalContent.trim()) return;

        try {
            const response = await apiRequest(`/api/discussions/${currentDiscussionId}/messages/${messageId}`, {
                method: 'PUT', body: { content: newContent.trim() }
            });
            if (!response.ok) {
                 const errorData = await response.json().catch(() => ({detail: "Failed to update message"}));
                 throw new Error(errorData.detail);
            }
            await selectDiscussion(currentDiscussionId, true); 
            showFlashMessage(t('messageUpdateSuccess'), 'success');
        } catch (error) {
            console.error('Failed to edit message:', error);
            showFlashMessage(t('messageUpdateError', {error: error.message}), 'error');
        }
    }

    async function deleteMessage(messageId, messageOuterDiv) {
        if (!confirm(t('deleteMessageConfirm'))) return;
        try {
            const response = await apiRequest(`/api/discussions/${currentDiscussionId}/messages/${messageId}`, { method: 'DELETE' });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({detail: "Failed to delete message"}));
                throw new Error(errorData.detail);
            }
            messageOuterDiv.remove();
            showFlashMessage(t('messageDeleteSuccess'), 'success');
             if (chatMessages.children.length === 0 && chatMessagesPlaceholder) { 
                chatMessagesPlaceholder.classList.remove('hidden');
            }
        } catch (error) {
            console.error('Failed to delete message:', error);
             showFlashMessage(t('messageDeleteError', {error: error.message}), 'error');
        }
    }

    imageUploadBtn.addEventListener('click', () => imageUploadInput.click());
    imageUploadInput.addEventListener('change', (event) => {
        handleImageFiles(event.target.files);
        imageUploadInput.value = ''; 
    });

    function handleImageFiles(files) {
        imagePreviewArea.classList.remove('hidden');
        for (const file of files) {
            if (!file.type.startsWith('image/')) continue;
            if (attachedImageFiles.length >= 5) { 
                 showFlashMessage(t('maxImagesReached', {max: 5}), 'warning');
                 break;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const previewUrl = e.target.result;
                const fileId = 'img-' + Date.now() + '-' + Math.random().toString(16).slice(2);
                attachedImageFiles.push({ id: fileId, fileObject: file, previewUrl: previewUrl, name: file.name });

                const previewItem = document.createElement('div');
                previewItem.className = 'image-preview-item';
                previewItem.dataset.fileId = fileId;
                const img = document.createElement('img');
                img.src = previewUrl; img.alt = file.name;
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-image-btn'; removeBtn.innerHTML = '&times;';
                removeBtn.title = t('removeImageTooltip');
                removeBtn.onclick = () => removeImagePreview(fileId);
                previewItem.appendChild(img); previewItem.appendChild(removeBtn);
                imagePreviewArea.appendChild(previewItem);
                updateSendButtonState(); 
            }
            reader.readAsDataURL(file);
        }
    }

    function removeImagePreview(fileId) {
        attachedImageFiles = attachedImageFiles.filter(f => f.id !== fileId);
        const previewElement = imagePreviewArea.querySelector(`[data-file-id="${fileId}"]`);
        if (previewElement) previewElement.remove();
        if (attachedImageFiles.length === 0) imagePreviewArea.classList.add('hidden');
        updateSendButtonState(); 
    }

    function clearImagePreviews() {
        attachedImageFiles = [];
        imagePreviewArea.innerHTML = '';
        imagePreviewArea.classList.add('hidden');
        updateSendButtonState(); 
    }

    settingsBtn.addEventListener('click', () => settingsModal.classList.remove('hidden'));
    closeSettingsBtn.addEventListener('click', () => settingsModal.classList.add('hidden'));
    settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) settingsModal.classList.add('hidden'); });

    async function loadLollmsModels() {
        lollmsModelSelect.innerHTML = `<option value="">${t('selectModelPlaceholder')}</option>`;
        try {
            const response = await apiRequest('/api/config/lollms-models');
            if (!response.ok) { throw new Error( (await response.json().catch(()=>({detail:"Failed to fetch models"}))).detail || 'Failed to fetch models'); }
            const models = await response.json();
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.name;
                option.textContent = model.name;
                lollmsModelSelect.appendChild(option);
            });
            if (currentUserDetails && currentUserDetails.lollms_model_name) {
                lollmsModelSelect.value = currentUserDetails.lollms_model_name;
            } else {
                 lollmsModelSelect.value = ""; 
            }
        } catch (error) {
            console.error('Failed to load LoLLMs models:', error);
            updateStatus('settings-status', t('modelLoadError') + `: ${error.message}`, 'error');
        }
    }

    setLollmsModelBtn.addEventListener('click', async () => {
        const modelName = lollmsModelSelect.value;
        if (!modelName) { updateStatus('settings-status', t('selectModelError'), 'error'); return; }
        updateStatus('settings-status', t('settingModelStatus'), 'info', 0);
        try {
            const formData = new FormData(); formData.append('model_name', modelName);
            const response = await apiRequest('/api/config/lollms-model', { method: 'POST', body: formData });
            if (!response.ok) {
                const errorData = await response.json().catch(()=>({detail: "Server error"}));
                throw new Error(errorData.detail);
            }
            updateStatus('settings-status', t('modelSetSuccess', {model: modelName}), 'success');
            if(currentUserDetails) currentUserDetails.lollms_model_name = modelName;
        } catch (error) {
            console.error('Failed to set LoLLMs model:', error);
            updateStatus('settings-status', t('modelSetError', {error: error.message}), 'error');
        }
    });

    async function loadStoreVectorizers() {
        vectorizerSelect.innerHTML = `<option value="">${t('selectVectorizerPlaceholder')}</option>`;
        try {
            const response = await apiRequest('/api/store/vectorizers');
            if (!response.ok) { throw new Error((await response.json().catch(()=>({detail:"Failed to fetch vectorizers"}))).detail || 'Failed to fetch vectorizers'); }
            const vectorizers = await response.json();
            vectorizers.forEach(vec => {
                const option = document.createElement('option');
                option.value = vec.name;
                option.textContent = vec.method_name; 
                vectorizerSelect.appendChild(option);
            });
            await fetchActiveVectorizer(); 
        } catch (error) {
            console.error('Failed to load SafeStore vectorizers:', error);
            updateStatus('settings-status', t('vectorizerLoadError') + `: ${error.message}`, 'error');
        }
    }

    async function fetchActiveVectorizer() {
        try {
            const response = await apiRequest('/api/store/active-vectorizer');
            if (!response.ok) { throw new Error((await response.json().catch(()=>({detail:"Failed to get active vectorizer"}))).detail); }
            const data = await response.json();
            const activeVec = data.active_vectorizer;
            if (activeVec) {
                 const exists = Array.from(vectorizerSelect.options).some(opt => opt.value === activeVec);
                 vectorizerSelect.value = exists ? activeVec : "";
                 if (currentUserDetails) currentUserDetails.safe_store_vectorizer = activeVec;
            } else {
                 vectorizerSelect.value = ""; 
                 if (currentUserDetails) currentUserDetails.safe_store_vectorizer = null;
            }
            ragToggleContainer.style.display = currentUserDetails?.safe_store_vectorizer ? 'flex' : 'none';
            useRagCheckbox.checked = !!currentUserDetails?.safe_store_vectorizer;

        } catch (error) {
            console.error('Failed to fetch active vectorizer:', error);
             if (currentUserDetails) currentUserDetails.safe_store_vectorizer = null;
            vectorizerSelect.value = "";
            ragToggleContainer.style.display = 'none';
            useRagCheckbox.checked = false;
        }
    }

    async function setActiveSessionVectorizer(vectorizerName) {
        if (!vectorizerName) {
            if (currentUserDetails) currentUserDetails.safe_store_vectorizer = null;
            ragToggleContainer.style.display = 'none';
            useRagCheckbox.checked = false;
            try {
                const formData = new FormData(); formData.append('vectorizer_name', ''); 
                await apiRequest('/api/store/active-vectorizer', { method: 'POST', body: formData });
            } catch (error) {
                console.error('Failed to clear active vectorizer on backend:', error);
            }
            return true; 
        }
        updateStatus('settings-status', t('settingVectorizerStatus'), 'info', 0);
        try {
            const formData = new FormData(); formData.append('vectorizer_name', vectorizerName);
            const response = await apiRequest('/api/store/active-vectorizer', { method: 'POST', body: formData });
             if (!response.ok) {
                const errorData = await response.json().catch(() => ({detail: t('vectorizerSetError')}));
                updateStatus('settings-status', `${t('vectorizerSetError')}: ${errorData.detail}`, 'error');
                return false;
            }
            if (currentUserDetails) currentUserDetails.safe_store_vectorizer = vectorizerName;
            ragToggleContainer.style.display = 'flex';
            useRagCheckbox.checked = true;
            return true;
        } catch (error) {
            console.error('Failed to set active vectorizer:', error);
            updateStatus('settings-status', `${t('vectorizerSetError')}: ${error.message}`, 'error');
            return false;
        }
    }

    setVectorizerBtn.addEventListener('click', async () => {
        let vectorizerName = newVectorizerNameInput.value.trim() || vectorizerSelect.value;
        if (!vectorizerName && vectorizerSelect.value === "") { 
             vectorizerName = ""; 
        } else if (!vectorizerName) {
             updateStatus('settings-status', t('selectOrEnterVectorizerError'), 'error'); return;
        }

        const success = await setActiveSessionVectorizer(vectorizerName);
        if (success) {
            newVectorizerNameInput.value = '';
            await loadStoreVectorizers(); 
            const statusMsg = vectorizerName ? t('vectorizerSetSuccess', {vectorizer: vectorizerName}) : t('vectorizerCleared');
            updateStatus('settings-status', statusMsg, 'success');
        }
    });

    fileManagerBtn.addEventListener('click', () => {
        fileManagerModal.classList.remove('hidden');
        loadRagFiles();
    });
    closeFileManagerBtn.addEventListener('click', () => fileManagerModal.classList.add('hidden'));
    fileManagerModal.addEventListener('click', (e) => { if (e.target === fileManagerModal) fileManagerModal.classList.add('hidden'); });

    uploadFolderBtn.addEventListener('click', () => folderUploadInput.click());
    folderUploadInput.addEventListener('change', handleFileUpload);
    fileUploadInputFM.addEventListener('change', handleFileUpload); 
    uploadDocumentBtn.addEventListener('click', () => {
        if (fileUploadInputFM.files.length > 0) {
             handleFileUpload({target: fileUploadInputFM});
        } else {
            updateStatus('upload-status', t('selectFileError'), 'warning');
        }
    });

    async function handleFileUpload(event) { 
        const filesToUpload = event.target.files;
        if (!filesToUpload || filesToUpload.length === 0) {
             updateStatus('upload-status', t('selectFileError'), 'warning'); return;
        }
        const activeVectorizer = currentUserDetails?.safe_store_vectorizer;
        if (!activeVectorizer) {
            updateStatus('upload-status', t('noActiveVectorizerError'), 'error');
            showFlashMessage(t('noActiveVectorizerError'), 'error');
            return;
        }
        updateStatus('upload-status', t('uploadingStatus', {count: filesToUpload.length}), 'info', 0);
        const formData = new FormData();
        for (let i = 0; i < filesToUpload.length; i++) { formData.append('files', filesToUpload[i]); }
        formData.append('vectorizer_name', activeVectorizer);

        try {
            const response = await apiRequest('/api/store/upload-files', { method: 'POST', body: formData });
            const result = await response.json(); 

            let message = result.message || '';
            let messageType = 'info';

            if (response.ok) { 
                 messageType = 'success';
                 if (result.processed_files && result.processed_files.length > 0) {
                    message += ` (${t('processedFiles', {count: result.processed_files.length})})`;
                 } else if (!result.processed_files || result.processed_files.length === 0){
                    message = result.message || "Files checked, no new data indexed (possibly duplicates).";
                 }
            } else if (response.status === 207) { 
                 messageType = 'warning';
                 if (result.processed_files && result.processed_files.length > 0) message += ` (${t('processedFiles', {count: result.processed_files.length})})`;
                 if (result.errors && result.errors.length > 0) {
                      message += ` ${t('uploadErrorsEncountered', {count: result.errors.length})}`;
                      result.errors.forEach(err => console.warn(`Upload error for ${err.filename}: ${err.error}`));
                 }
            } else { 
                messageType = 'error';
                message = t('uploadError', {error: result.detail || response.statusText || "Unknown upload error" });
            }
            updateStatus('upload-status', message || t('uploadAttemptFinished'), messageType);
            await loadRagFiles();
        } catch (error) {
            console.error('Upload failed:', error);
            updateStatus('upload-status', t('uploadNetworkError') + `: ${error.message}`, 'error');
        } finally {
             if (event.target.id === 'file-upload-input-fm') { fileUploadInputFM.value = ''; }
             else if (event.target.id === 'folder-upload-input') { folderUploadInput.value = ''; }
        }
    }

    async function loadRagFiles() {
        ragFileList.innerHTML = '';
        ragListLoader.classList.remove('hidden');
        try {
            const response = await apiRequest('/api/store/files');
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({detail: t('errorLoadingFiles')}));
                throw new Error(errorData.detail || response.statusText);
            }
            const files = await response.json();
            if (files.length === 0) {
                ragFileList.innerHTML = `<li class="p-2 text-center text-secondary-500 dark:text-secondary-400 text-xs">${t('noFilesFound')}</li>`;
            } else {
                files.sort((a,b) => a.filename.localeCompare(b.filename)).forEach(file => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center text-sm py-1 px-2 rounded hover:bg-secondary-100 dark:hover:bg-secondary-700';
                    const fileNameSpan = document.createElement('span');
                    fileNameSpan.textContent = file.filename;
                    fileNameSpan.className = 'truncate text-secondary-700 dark:text-secondary-200 mr-2';
                    li.appendChild(fileNameSpan);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>`;
                    deleteBtn.className = 'p-1 text-danger/70 hover:text-danger rounded shrink-0';
                    deleteBtn.title = t('deleteFileTooltip', {filename: file.filename});
                    deleteBtn.onclick = (e) => { e.stopPropagation(); deleteRagFile(file.filename); };
                    li.appendChild(deleteBtn);
                    ragFileList.appendChild(li);
                });
            }
        } catch (error) {
            console.error('Failed to load RAG files:', error);
            ragFileList.innerHTML = `<li class="p-2 text-center text-danger text-xs">${t('errorLoadingFiles')}: ${error.message}</li>`;
        } finally {
            ragListLoader.classList.add('hidden');
        }
    }

    async function deleteRagFile(filename) {
        if (!confirm(t('deleteFileConfirm', {filename: filename}))) return;
        updateStatus('upload-status', t('deletingFile', {filename: filename}), 'info', 0);
        try {
            const encodedFilename = encodeURIComponent(filename);
            const response = await apiRequest(`/api/store/files/${encodedFilename}`, { method: 'DELETE' });
            const result = await response.json(); 

            if (response.ok) {
                updateStatus('upload-status', result.message || t('fileDeletedSuccess', {filename: filename}), 'success');
                await loadRagFiles(); 
            } else {
                throw new Error(result.detail || `Server responded with status ${response.status}`);
            }
        } catch (error) {
             console.error('Failed to delete RAG file:', error);
            updateStatus('upload-status', t('fileDeleteError', {filename: filename, error: error.message}), 'error');
        }
    }

    exportDiscussionsBtnModalTrigger.addEventListener('click', async () => {
        exportModal.classList.remove('hidden');
        exportDiscussionList.innerHTML = '';
        exportDiscussionListLoader.classList.remove('hidden');
        updateStatus('export-status', '', 'info', 0); 
        try {
            const response = await apiRequest('/api/discussions');
            if (!response.ok) throw new Error(t('discussionLoadError'));
            const discussions = await response.json();
            
            if (discussions.length === 0) {
                 exportDiscussionList.innerHTML = `<li class="text-center text-xs text-secondary-400 p-2">${t('noDiscussionsFound')}</li>`;
            } else {
                discussions.sort((a, b) => (a.title || '').localeCompare(b.title || '')).forEach(disc => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center p-1.5 rounded hover:bg-secondary-100 dark:hover:bg-secondary-700';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `export-disc-${disc.id}`;
                    checkbox.value = disc.id;
                    checkbox.className = 'h-4 w-4 text-primary border-secondary-300 dark:border-secondary-600 rounded focus:ring-primary dark:bg-secondary-700 mr-2 shrink-0';
                    const label = document.createElement('label');
                    label.htmlFor = `export-disc-${disc.id}`;
                    label.textContent = disc.title || t('untitledDiscussion', {id: disc.id.substring(0,8)});
                    label.className = 'text-sm text-secondary-700 dark:text-secondary-200 cursor-pointer flex-grow truncate';
                    li.appendChild(checkbox);
                    li.appendChild(label);
                    exportDiscussionList.appendChild(li);
                });
            }
        } catch (error) {
            console.error("Error populating export list:", error);
            exportDiscussionList.innerHTML = `<li class="text-center text-xs text-danger p-2">${error.message}</li>`;
            updateStatus('export-status', error.message, 'error');
        } finally {
            exportDiscussionListLoader.classList.add('hidden');
        }
    });

    closeExportModalBtn.addEventListener('click', () => exportModal.classList.add('hidden'));
    exportModal.addEventListener('click', (e) => { if(e.target === exportModal) exportModal.classList.add('hidden'); });

    exportSelectAllBtn.addEventListener('click', () => {
        exportDiscussionList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
    });
    exportSelectNoneBtn.addEventListener('click', () => {
        exportDiscussionList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    });

    confirmExportBtn.addEventListener('click', async () => {
        const selectedIds = Array.from(exportDiscussionList.querySelectorAll('input[type="checkbox"]:checked'))
                                 .map(cb => cb.value);
        updateStatus('export-status', t('exportingDataStatus'), 'info', 0);
        try {
            const response = await apiRequest('/api/discussions/export', {
                method: 'POST',
                body: { discussion_ids: selectedIds.length > 0 ? selectedIds : null }
            });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({detail: "Export failed."}));
                throw new Error(errorData.detail || "Failed to fetch export data.");
            }
            const data = await response.json();
            const filename = `lollms_export_${currentUserDetails.username}_${new Date().toISOString().split('T')[0]}.json`;
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(url);
            updateStatus('export-status', t('exportSuccess'), 'success');
            setTimeout(() => exportModal.classList.add('hidden'), 1500); 
        } catch (error) {
            updateStatus('export-status', t('exportError', {error: error.message}), 'error');
        }
    });

    document.addEventListener('DOMContentLoaded', async () => {
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        applyTheme(savedTheme || (prefersDark ? 'dark' : 'light'));
        
        await loadTranslations(currentLanguage); 
        showLoginScreen();
    });

</script>
</body>
</html>
