<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simplified LoLLMs Chat</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <!-- Tailwind CSS via Play CDN (for development/demo) -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <!-- Marked.js for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- KaTeX for Math Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>
    <!-- CodeMirror 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/material-darker.min.css"> <!-- Example theme -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/meta.min.js"></script>
    <!-- Load common modes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/shell/shell.min.js"></script>
    <!-- Pyodide (for Python execution) -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>

    <style>
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        /* CodeMirror styling adjustments */
        .cm-editor { border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em; }
        .code-block-header { background-color: #f0f0f0; padding: 4px 8px; font-size: 0.8em; border-top-left-radius: 4px; border-top-right-radius: 4px; display: flex; justify-content: space-between; align-items: center;}
        .code-block-buttons button { background-color: #e0e0e0; border: none; padding: 2px 6px; font-size: 0.8em; cursor: pointer; border-radius: 3px; margin-left: 5px;}
        .code-block-buttons button:hover { background-color: #d0d0d0; }
        /* KaTeX display math */
        .katex-display { margin: 0.5em 0 !important; }
        /* Message Bubbles */
        .message-bubble { max-width: 85%; padding: 10px 15px; border-radius: 15px; margin-bottom: 10px; word-wrap: break-word; }
        .user-bubble { background-color: #dbeafe; /* Lighter Blue */ align-self: flex-end; border-bottom-right-radius: 5px; }
        .ai-bubble { background-color: #f3f4f6; /* Lighter Gray */ align-self: flex-start; border-bottom-left-radius: 5px; }
        .system-bubble { background-color: #fef3c7; /* Lighter Yellow */ color: #78350f; /* Darker amber */ align-self: center; font-style: italic; font-size: 0.9em; text-align: center; width: 90%; border-radius: 8px; }
        .sender-name { font-size: 0.8em; font-weight: bold; margin-bottom: 4px; color: #4b5563; } /* Gray-600 */
        /* RAG Toggle Button */
        .rag-toggle { padding: 6px 12px; border-radius: 20px; cursor: pointer; transition: background-color 0.3s, color 0.3s; font-weight: 500; border: 1px solid transparent; }
        .rag-toggle-off { background-color: #e5e7eb; color: #4b5563; border-color: #d1d5db; }
        .rag-toggle-on { background-color: #10b981; color: white; }
        .rag-toggle:disabled { opacity: 0.5; cursor: not-allowed; }
        /* Star Icon */
        .star-icon { cursor: pointer; color: #d1d5db; /* Gray-300 */ }
        .star-icon.starred { color: #facc15; /* Amber-400 */ }
        /* Grade Buttons */
        .grade-btn { background: none; border: none; padding: 2px; cursor: pointer; opacity: 0.6; }
        .grade-btn:hover { opacity: 1; }
        .grade-btn.selected-up { color: #10b981; opacity: 1; } /* Emerald-500 */
        .grade-btn.selected-down { color: #ef4444; opacity: 1; } /* Red-500 */
        .grade-score { font-size: 0.8em; margin: 0 5px; color: #6b7280; } /* Gray-500 */
        /* Modal Styles */
        .modal { position: fixed; inset: 0; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; pointer-events: none; transition: opacity 0.3s ease-in-out; padding: 1rem;}
        .modal.active { opacity: 1; pointer-events: auto; }
        .modal-content { background-color: white; padding: 1.5rem 2rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); max-width: 95vw; width: 600px; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-header { border-bottom: 1px solid #e5e7eb; padding-bottom: 0.75rem; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;}
        .modal-title { font-size: 1.125rem; font-weight: 600; color: #1f2937; }
        .modal-body { flex-grow: 1; overflow-y: auto; padding-right: 0.5rem; /* For scrollbar */}
        .modal-footer { border-top: 1px solid #e5e7eb; padding-top: 1rem; margin-top: 1rem; display: flex; justify-content: flex-end; gap: 0.75rem; }
        .modal-close-btn { position: absolute; top: 0.75rem; right: 0.75rem; color: #9ca3af; background: none; border: none; cursor: pointer; padding: 0.25rem;}
        .modal-close-btn:hover { color: #1f2937; }
        /* Sidebar button styles */
        .sidebar-btn { display: flex; align-items: center; width: 100%; text-align: left; padding: 0.5rem 0.75rem; font-size: 0.875rem; color: #4b5563; border-radius: 0.375rem; background-color: #f9fafb; border: 1px solid #e5e7eb; }
        .sidebar-btn:hover { background-color: #f3f4f6; }
        .sidebar-btn svg { margin-right: 0.5rem; width: 1rem; height: 1rem; color: #6b7280; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900">
    <div id="app-container" class="flex h-screen overflow-hidden">

        <!-- Sidebar -->
        <aside class="w-72 bg-white border-r border-gray-200 flex flex-col">
            <!-- Logo/Header -->
            <div class="p-4 border-b border-gray-200">
                 <img src="/logo.png" alt="Logo" class="h-10 mx-auto mb-2">
                 <h2 class="text-xl font-semibold text-center text-gray-700">Discussions</h2>
            </div>

            <!-- New Discussion Button -->
            <div class="p-3 border-b border-gray-200">
                <button id="newDiscussionBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                    New Discussion
                </button>
            </div>

            <!-- Discussion List -->
            <div id="discussionListContainer" class="flex-1 overflow-y-auto p-2 space-y-1">
                <!-- Discussions will be loaded here -->
                <p class="text-gray-500 text-sm text-center italic p-4">Loading discussions...</p>
            </div>

            <!-- User/Settings Footer -->
            <div class="p-3 border-t border-gray-200 bg-gray-50 space-y-3">
                <div id="userInfo" class="text-sm text-center">
                    Logged in as: <span id="usernameDisplay" class="font-semibold">...</span>
                    <span id="adminBadge" class="ml-1 text-xs bg-red-100 text-red-800 px-1.5 py-0.5 rounded-full font-medium" style="display: none;">Admin</span>
                </div>
                 <div class="space-y-2">
                     <button id="settingsBtn" class="sidebar-btn">
                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 0 1 0 1.255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 0 1 0-1.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>
                         Settings
                     </button>
                     <button id="filesBtn" class="sidebar-btn">
                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z" /></svg>
                         Files / RAG
                     </button>
                     <a href="/admin" id="adminLink" class="sidebar-btn" style="display: none;">
                          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" /></svg>
                         Admin Panel
                     </a>
                     <div class="flex space-x-2">
                         <button id="exportDataBtn" class="flex-1 text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 py-1 px-2 rounded border border-gray-300">Export Data</button>
                         <button id="importDataBtn" class="flex-1 text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 py-1 px-2 rounded border border-gray-300">Import Data</button>
                     </div>
                 </div>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="flex-1 flex flex-col bg-gray-50">
            <!-- Chat Header -->
            <header class="bg-white border-b border-gray-200 p-3 flex items-center justify-between min-h-[65px] shadow-sm">
                <h3 id="discussionTitle" class="text-lg font-semibold text-gray-800 truncate px-2">Select or Create a Discussion</h3>
                <div id="discussionActions" class="flex items-center space-x-2" style="display: none;">
                     <button id="renameDiscussionBtn" title="Rename Discussion" class="p-1.5 rounded-full text-gray-500 hover:text-gray-700 hover:bg-gray-100">
                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" /></svg>
                     </button>
                     <button id="deleteDiscussionBtn" title="Delete Discussion" class="p-1.5 rounded-full text-red-500 hover:text-red-700 hover:bg-red-50">
                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12.508 0A48.067 48.067 0 0 1 7.8 5.397m7.454 0M12 10.75h.008v.008H12v-.008Z" /></svg>
                     </button>
                </div>
            </header>

            <!-- Messages Area -->
            <div id="chatMessages" class="flex-1 overflow-y-auto p-4 flex flex-col space-y-2">
                <!-- Messages will appear here -->
                <div class="text-center text-gray-500 italic mt-10">Select a discussion to start chatting.</div>
            </div>

            <!-- Input Area -->
            <footer class="bg-white border-t border-gray-200 p-3 shadow-inner">
                <div class="flex items-end space-x-3">
                    <textarea id="messageInput" rows="1" class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 text-sm" placeholder="Type your message... (Shift+Enter for new line)" style="resize: none; overflow-y: hidden;"></textarea>
                    <button id="ragToggleBtn" class="rag-toggle rag-toggle-off self-center mb-1" title="Toggle RAG">RAG</button>
                    <button id="sendMessageBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out self-end disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" /></svg>
                    </button>
                </div>
                 <div id="statusMessage" class="text-xs text-red-600 mt-1 h-4"></div>
                 <div id="pyodideStatus" class="text-xs text-blue-600 mt-1 h-4"></div>
            </footer>
        </main>

    </div>

    <!-- Modals Container -->
    <div>
        <!-- Rename Modal -->
        <div id="renameModal" class="modal">
            <div class="modal-content">
                <button class="modal-close-btn" onclick="closeModal('renameModal')">×</button>
                <div class="modal-header">
                    <h3 class="modal-title">Rename Discussion</h3>
                </div>
                <div class="modal-body">
                    <label for="renameInput" class="block text-sm font-medium text-gray-700 mb-1">New discussion title:</label>
                    <input type="text" id="renameInput" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Enter new title">
                    <div id="renameStatus" class="text-xs text-red-600 mt-1 h-4"></div>
                </div>
                <div class="modal-footer">
                    <button onclick="closeModal('renameModal')" class="px-4 py-2 bg-gray-200 text-gray-800 text-sm font-medium rounded-md hover:bg-gray-300">Cancel</button>
                    <button id="confirmRenameBtn" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700">Rename</button>
                </div>
            </div>
        </div>

        <!-- Export Modal -->
        <div id="exportModal" class="modal">
             <div class="modal-content">
                 <button class="modal-close-btn" onclick="closeModal('exportModal')">×</button>
                 <div class="modal-header">
                     <h3 class="modal-title">Export Discussions</h3>
                 </div>
                 <div class="modal-body">
                     <p class="text-sm text-gray-600 mb-3">Select discussions to export (leave all unchecked to export all):</p>
                     <div id="exportDiscussionList" class="max-h-60 overflow-y-auto border border-gray-200 rounded p-3 space-y-2 bg-gray-50">
                         <!-- Checkboxes will be loaded here -->
                         <p class="text-gray-500 italic">Loading discussions...</p>
                     </div>
                 </div>
                 <div class="modal-footer">
                     <button onclick="closeModal('exportModal')" class="px-4 py-2 bg-gray-200 text-gray-800 text-sm font-medium rounded-md hover:bg-gray-300">Cancel</button>
                     <button id="confirmExportBtn" class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700">Export Selected</button>
                 </div>
            </div>
        </div>

        <!-- Import Modal -->
         <div id="importModal" class="modal">
            <div class="modal-content">
                <button class="modal-close-btn" onclick="closeModal('importModal')">×</button>
                <div class="modal-header">
                    <h3 class="modal-title">Import Discussions</h3>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <label for="importFile" class="block text-sm font-medium text-gray-700 mb-1">Select Exported JSON File (.json):</label>
                        <input type="file" id="importFile" accept=".json" class="block w-full text-sm text-gray-500 file:mr-4 file:py-1.5 file:px-3 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 border border-gray-300 rounded-md cursor-pointer"/>
                    </div>
                    <div id="importPreviewArea" class="mb-4" style="display: none;">
                        <p class="text-sm text-gray-600 mb-2">Select discussions to import from the file:</p>
                         <div id="importDiscussionList" class="max-h-60 overflow-y-auto border border-gray-200 rounded p-3 space-y-2 bg-gray-50">
                             <!-- Checkboxes will be loaded here -->
                         </div>
                    </div>
                    <p id="importStatus" class="text-sm text-red-600 h-4"></p>
                </div>
                <div class="modal-footer">
                    <button onclick="closeModal('importModal')" class="px-4 py-2 bg-gray-200 text-gray-800 text-sm font-medium rounded-md hover:bg-gray-300">Cancel</button>
                    <button id="confirmImportBtn" class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Import Selected</button>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settingsModal" class="modal">
            <div class="modal-content">
                <button class="modal-close-btn" onclick="closeModal('settingsModal')">×</button>
                <div class="modal-header">
                    <h3 class="modal-title">User Settings</h3>
                </div>
                <div class="modal-body space-y-5">
                    <div>
                        <label for="settingsLollmsModelSelect" class="block text-sm font-medium text-gray-700 mb-1">Default LoLLMs Model</label>
                        <select id="settingsLollmsModelSelect" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            <!-- Options loaded dynamically -->
                            <option>Loading models...</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Select the default model for new chat sessions.</p>
                        <div class="text-right mt-2">
                             <button id="saveLollmsModelBtn" class="px-3 py-1 bg-blue-600 text-white text-xs font-medium rounded-md hover:bg-blue-700 disabled:opacity-50" disabled>Save Model</button>
                        </div>
                    </div>
                     <hr>
                    <div>
                        <label for="settingsVectorizerSelect" class="block text-sm font-medium text-gray-700 mb-1">Default SafeStore Vectorizer</label>
                        <select id="settingsVectorizerSelect" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            <!-- Options loaded dynamically -->
                             <option>Loading vectorizers...</option>
                        </select>
                         <p class="text-xs text-gray-500 mt-1">Select the default vectorizer for RAG.</p>
                        <div class="text-right mt-2">
                            <button id="saveVectorizerBtn" class="px-3 py-1 bg-blue-600 text-white text-xs font-medium rounded-md hover:bg-blue-700 disabled:opacity-50" disabled>Save Vectorizer</button>
                        </div>
                    </div>
                    <div id="settingsStatus" class="text-sm h-4"></div>
                </div>
                <div class="modal-footer">
                    <button onclick="closeModal('settingsModal')" class="px-4 py-2 bg-gray-200 text-gray-800 text-sm font-medium rounded-md hover:bg-gray-300">Close</button>
                </div>
            </div>
        </div>

        <!-- File Management Modal -->
        <div id="fileManagementModal" class="modal">
            <div class="modal-content">
                <button class="modal-close-btn" onclick="closeModal('fileManagementModal')">×</button>
                <div class="modal-header">
                    <h3 class="modal-title">RAG File Management</h3>
                </div>
                <div class="modal-body space-y-5">
                    <!-- Upload Section -->
                    <div class="border border-gray-200 rounded-md p-4">
                         <h4 class="text-md font-medium text-gray-800 mb-3">Upload New Documents</h4>
                         <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                             <div>
                                 <label for="fileVectorizerSelect" class="block text-sm font-medium text-gray-700 mb-1">Vectorizer for Upload</label>
                                 <select id="fileVectorizerSelect" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                     <option value="">Select Vectorizer</option>
                                      <!-- Options loaded dynamically -->
                                 </select>
                             </div>
                             <div>
                                <label for="fileUploadInput" class="block text-sm font-medium text-gray-700 mb-1">Select Files</label>
                                <input type="file" id="fileUploadInput" multiple class="block w-full text-sm text-gray-500 file:mr-4 file:py-1.5 file:px-3 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 border border-gray-300 rounded-md cursor-pointer"/>
                            </div>
                         </div>
                         <div class="text-right mt-3">
                            <button id="confirmUploadBtn" class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 disabled:opacity-50" disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline-block mr-1 align-text-bottom"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0 3 3m-3-3-3 3M6.75 19.5a4.5 4.5 0 0 1-1.41-8.775 5.25 5.25 0 0 1 10.233-2.33 3 3 0 0 1 3.758 3.848A3.752 3.752 0 0 1 18 19.5H6.75Z" /></svg>
                                Upload Files
                            </button>
                         </div>
                         <div id="uploadStatus" class="text-sm h-4 mt-2"></div>
                    </div>

                    <!-- File List Section -->
                     <div class="border border-gray-200 rounded-md p-4">
                         <h4 class="text-md font-medium text-gray-800 mb-3">Indexed Documents</h4>
                         <div id="indexedFileList" class="max-h-60 overflow-y-auto space-y-2 bg-gray-50 border border-gray-100 rounded p-3">
                            <p class="text-gray-500 italic">Loading files...</p>
                            <!-- File list loaded dynamically -->
                         </div>
                          <div id="fileListStatus" class="text-sm h-4 mt-2"></div>
                    </div>
                </div>
                 <div class="modal-footer">
                    <button onclick="closeModal('fileManagementModal')" class="px-4 py-2 bg-gray-200 text-gray-800 text-sm font-medium rounded-md hover:bg-gray-300">Close</button>
                </div>
            </div>
        </div>

    </div> <!-- End Modals Container -->


    <script>
        // --- Global State ---
        let currentUser = null;
        let currentDiscussionId = null;
        let discussions = {}; // { id: { title: '...', is_starred: false } }
        let currentMessages = []; // Array of message objects { id, sender, content, user_grade, ... }
        let aiMessageStreaming = false;
        let currentAiMessageElement = null;
        let currentAiMessageContent = "";
        let currentAiMessageId = null;
        let codeMirrorInstances = {}; // { messageId-index: instance }
        let pyodide = null;
        let pyodideLoading = false;
        let isRagActive = false;
        let availableLollmsModels = []; // For settings [{name: 'model1'}]
        let availableVectorizers = []; // For settings & file management [{name: 'vec1', method_name: 'Vectorizer 1 (dim: 128)'}]
        let userLollmsModel = null; // User's default model setting
        let userDefaultVectorizer = null; // User's default vectorizer setting
        let sessionActiveVectorizer = null; // Vectorizer currently active for RAG toggle
        let indexedRagFiles = []; // [{filename: 'doc1.txt'}]
        let lastUserMessageId = null;

        // --- DOM Elements ---
        // Sidebar
        const discussionListContainer = document.getElementById('discussionListContainer');
        const newDiscussionBtn = document.getElementById('newDiscussionBtn');
        const usernameDisplay = document.getElementById('usernameDisplay');
        const adminBadge = document.getElementById('adminBadge');
        const adminLink = document.getElementById('adminLink');
        const settingsBtn = document.getElementById('settingsBtn');
        const filesBtn = document.getElementById('filesBtn');
        const exportDataBtn = document.getElementById('exportDataBtn');
        const importDataBtn = document.getElementById('importDataBtn');
        // Chat Area
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const discussionTitle = document.getElementById('discussionTitle');
        const discussionActions = document.getElementById('discussionActions');
        const renameDiscussionBtn = document.getElementById('renameDiscussionBtn');
        const deleteDiscussionBtn = document.getElementById('deleteDiscussionBtn');
        const ragToggleBtn = document.getElementById('ragToggleBtn');
        const statusMessage = document.getElementById('statusMessage');
        const pyodideStatus = document.getElementById('pyodideStatus');
        // Modals & Controls
        const renameModal = document.getElementById('renameModal');
        const renameInput = document.getElementById('renameInput');
        const confirmRenameBtn = document.getElementById('confirmRenameBtn');
        const renameStatus = document.getElementById('renameStatus');
        const exportModal = document.getElementById('exportModal');
        const exportDiscussionList = document.getElementById('exportDiscussionList');
        const confirmExportBtn = document.getElementById('confirmExportBtn');
        const importModal = document.getElementById('importModal');
        const importFile = document.getElementById('importFile');
        const importPreviewArea = document.getElementById('importPreviewArea');
        const importDiscussionList = document.getElementById('importDiscussionList');
        const confirmImportBtn = document.getElementById('confirmImportBtn');
        const importStatus = document.getElementById('importStatus');
        const settingsModal = document.getElementById('settingsModal');
        const settingsLollmsModelSelect = document.getElementById('settingsLollmsModelSelect');
        const saveLollmsModelBtn = document.getElementById('saveLollmsModelBtn');
        const settingsVectorizerSelect = document.getElementById('settingsVectorizerSelect');
        const saveVectorizerBtn = document.getElementById('saveVectorizerBtn');
        const settingsStatus = document.getElementById('settingsStatus');
        const fileManagementModal = document.getElementById('fileManagementModal');
        const fileVectorizerSelect = document.getElementById('fileVectorizerSelect');
        const fileUploadInput = document.getElementById('fileUploadInput');
        const confirmUploadBtn = document.getElementById('confirmUploadBtn');
        const uploadStatus = document.getElementById('uploadStatus');
        const indexedFileList = document.getElementById('indexedFileList');
        const fileListStatus = document.getElementById('fileListStatus');


        // --- API Helper ---
        async function apiRequest(url, options = {}) {
            // Clear general status unless a modal status is targeted
            if (!options.statusElement) showStatus('');

            try {
                const response = await fetch(url, options);
                if (response.status === 401) {
                    const msg = "Authentication failed. Please login.";
                    showStatus(msg, "error", options.statusElement);
                    alert("Authentication required. Please refresh and login.");
                    throw new Error(msg);
                }
                if (!response.ok) {
                     const errorData = await response.json().catch(() => ({ detail: `HTTP error ${response.status}` }));
                     const errorMsg = `API Error: ${errorData.detail || response.statusText}`;
                     showStatus(errorMsg, "error", options.statusElement);
                     // Throw error so caller handling (e.g., in modals) knows it failed
                     throw new Error(errorMsg);
                }
                return response;
            } catch (error) {
                console.error("API Request Error:", url, options, error);
                // Use provided status element or global one
                showStatus(`Request failed: ${error.message}`, "error", options.statusElement || statusMessage);
                throw error; // Re-throw for caller handling if needed
            }
        }

        // --- Initialization ---
        window.onload = async () => {
            marked.setOptions({
                highlight: (code, lang) => code, // Rely on CodeMirror
                gfm: true,
                breaks: true,
            });

            showStatus('Initializing...', 'info');
            try {
                // 1. Fetch User Info (includes default settings from DB)
                const response = await apiRequest('/api/auth/me');
                currentUser = await response.json();
                usernameDisplay.textContent = currentUser.username;
                userLollmsModel = currentUser.lollms_model_name;
                userDefaultVectorizer = currentUser.safe_store_vectorizer;
                 sessionActiveVectorizer = userDefaultVectorizer; // Start session active with user default

                if (currentUser.is_admin) {
                    adminBadge.style.display = 'inline-block';
                    adminLink.style.display = 'flex'; // Use flex for sidebar-btn style
                }

                // 2. Load Discussions
                await loadDiscussions();

                // 3. Load Initial RAG / Settings Data
                await loadAvailableLollmsModels();
                await loadAvailableVectorizers();
                await loadIndexedRagFiles();

                // 4. Update Initial UI states based on loaded data
                updateRagToggleButtonState(); // Update based on initially loaded active vectorizer


                showStatus('Ready.', 'success');

            } catch (error) {
                 showStatus('Initialization failed. Please refresh.', 'error');
                 console.error("Initialization error:", error)
                 // Disable interactive elements if init fails?
                 sendMessageBtn.disabled = true;
                 newDiscussionBtn.disabled = true;
            }
        };

        // --- Modal Management ---
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
                // Trigger specific loading/refresh logic when opening
                if (modalId === 'settingsModal') {
                    populateSettingsModal();
                } else if (modalId === 'fileManagementModal') {
                    populateFileManagementModal();
                } else if (modalId === 'exportModal') {
                    populateExportModal(); // Renamed from direct call
                }
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
            }
             // Clear modal-specific status messages on close
             const statusElement = document.getElementById(modalId.replace('Modal', 'Status'));
             if (statusElement) {
                 showStatus('', 'info', statusElement);
             }
        }

        // Close modal if clicking outside the content area
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (event) => {
                if (event.target === modal) { // Check if the click is on the background overlay
                    closeModal(modal.id);
                }
            });
        });

        // --- Discussion Management ---
        async function loadDiscussions() {
            try {
                const response = await apiRequest('/api/discussions');
                const loadedDiscussions = await response.json();
                discussions = {};
                loadedDiscussions.forEach(d => { discussions[d.id] = d; });
                renderDiscussionList();
                if (currentDiscussionId && discussions[currentDiscussionId]) {
                    selectDiscussion(currentDiscussionId); // Re-select if possible
                } else if (currentDiscussionId) {
                    clearChatArea(); // Clear chat if previous discussion gone
                    currentDiscussionId = null;
                }
            } catch (error) {
                console.error("Failed to load discussions:", error);
                discussionListContainer.innerHTML = '<p class="text-red-500 text-sm text-center p-4">Failed to load discussions.</p>';
            }
        }

        function renderDiscussionList() {
            discussionListContainer.innerHTML = '';
            const sortedIds = Object.keys(discussions).sort((a, b) => {
                // Sort starred first, then by title
                const starA = discussions[a].is_starred ? 0 : 1;
                const starB = discussions[b].is_starred ? 0 : 1;
                if (starA !== starB) return starA - starB;
                return (discussions[a].title || '').localeCompare(discussions[b].title || '');
            });

            if (sortedIds.length === 0) {
                 discussionListContainer.innerHTML = '<p class="text-gray-500 text-sm text-center italic p-4">No discussions yet.</p>';
                 return;
            }

            sortedIds.forEach(id => {
                const d = discussions[id];
                const item = document.createElement('div');
                item.className = `p-2 rounded cursor-pointer hover:bg-gray-100 flex justify-between items-center text-sm transition-colors duration-150 ${id === currentDiscussionId ? 'bg-blue-100 font-medium text-blue-800' : 'text-gray-700'}`;
                item.dataset.id = id;
                item.onclick = () => selectDiscussion(id);

                const titleSpan = document.createElement('span');
                titleSpan.textContent = d.title || `Discussion ${id.substring(0, 6)}`;
                titleSpan.className = 'truncate mr-2 flex-1';

                const starSpan = document.createElement('span');
                starSpan.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" stroke-width="1.5" stroke="none" class="w-4 h-4 star-icon ${d.is_starred ? 'starred' : ''} transition-colors duration-150"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-2.885a.562.562 0 0 0-.586 0L6.982 21.1a.562.562 0 0 1-.84-.61l1.285-5.386a.562.562 0 0 0-.182-.557l-4.204-3.602a.562.562 0 0 1 .321-.988l5.518-.442a.563.563 0 0 0 .475-.345L11.48 3.5Z" /></svg>`;
                starSpan.title = d.is_starred ? 'Unstar Discussion' : 'Star Discussion';
                starSpan.className = 'flex-shrink-0 p-1 hover:bg-gray-200 rounded-full';
                starSpan.onclick = (e) => {
                    e.stopPropagation(); // Prevent selecting discussion
                    toggleStarDiscussion(id, d.is_starred);
                };

                item.appendChild(titleSpan);
                item.appendChild(starSpan);
                discussionListContainer.appendChild(item);
            });
        }

        newDiscussionBtn.onclick = async () => {
            showStatus('Creating new discussion...', 'info');
            try {
                const response = await apiRequest('/api/discussions', { method: 'POST' });
                const newDiscussion = await response.json();
                discussions[newDiscussion.id] = newDiscussion; // Add to local cache
                renderDiscussionList();
                selectDiscussion(newDiscussion.id);
                showStatus('New discussion created.', 'success');
            } catch (error) {
                 console.error("Failed to create discussion:", error);
                 // status shown by apiRequest
            }
        };

        async function selectDiscussion(id) {
            if (!discussions[id] || aiMessageStreaming) return; // Ignore if discussion missing or busy

            currentDiscussionId = id;
            discussionTitle.textContent = discussions[id].title;
            discussionActions.style.display = 'flex';
            sendMessageBtn.disabled = false;
            renderDiscussionList(); // Update selection highlight
            clearChatArea(false); // Clear messages but keep header title etc.
            chatMessages.innerHTML = '<p class="text-gray-500 text-center italic mt-10">Loading messages...</p>';
            lastUserMessageId = null; // Reset parent tracking

            try {
                const response = await apiRequest(`/api/discussions/${id}`);
                currentMessages = await response.json();
                renderMessages(currentMessages);
            } catch (error) {
                 console.error(`Failed to load messages for ${id}:`, error);
                 chatMessages.innerHTML = '<p class="text-red-500 text-center mt-10">Error loading messages.</p>';
                 // Keep discussion selected but show error
            }
        }

        renameDiscussionBtn.onclick = () => {
            if (!currentDiscussionId) return;
            renameInput.value = discussions[currentDiscussionId].title;
            showStatus('', 'info', renameStatus); // Clear previous status
            openModal('renameModal');
            renameInput.focus();
        };

        confirmRenameBtn.onclick = async () => {
             if (!currentDiscussionId) return;
             const newTitle = renameInput.value.trim();
             if (!newTitle) {
                 showStatus('Title cannot be empty.', 'error', renameStatus);
                 return;
             }
             showStatus('Renaming...', 'info', renameStatus);

             try {
                 const response = await apiRequest(`/api/discussions/${currentDiscussionId}/title`, {
                     method: 'PUT',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify({ title: newTitle }),
                     statusElement: renameStatus // Target modal status
                 });
                 const updatedInfo = await response.json();
                 discussions[currentDiscussionId].title = updatedInfo.title;
                 discussionTitle.textContent = updatedInfo.title; // Update header
                 renderDiscussionList(); // Update list display
                 showStatus('Renamed successfully.', 'success', renameStatus);
                 setTimeout(() => closeModal('renameModal'), 1000); // Close after success
             } catch (error) {
                 console.error("Rename failed:", error);
                 // Status already shown by apiRequest in modal status element
             }
        };


        deleteDiscussionBtn.onclick = async () => {
             if (!currentDiscussionId) return;
             const titleToDelete = discussions[currentDiscussionId].title;
             if (confirm(`Are you sure you want to delete discussion "${titleToDelete}"? This cannot be undone.`)) {
                 showStatus('Deleting discussion...', 'info');
                 try {
                     await apiRequest(`/api/discussions/${currentDiscussionId}`, { method: 'DELETE' });

                     const deletedId = currentDiscussionId;
                     delete discussions[deletedId];
                     currentDiscussionId = null; // Deselect
                     clearChatArea(true); // Clear everything
                     renderDiscussionList();
                     showStatus(`Discussion "${titleToDelete}" deleted.`, 'success');

                 } catch (error) {
                     console.error("Delete failed:", error);
                     // Status shown by apiRequest
                 }
             }
        };

        async function toggleStarDiscussion(id, isCurrentlyStarred) {
             const method = isCurrentlyStarred ? 'DELETE' : 'POST';
             const action = isCurrentlyStarred ? 'Unstarring' : 'Starring';
             // No status message needed for quick action like starring
             try {
                await apiRequest(`/api/discussions/${id}/star`, { method: method });
                discussions[id].is_starred = !isCurrentlyStarred;
                renderDiscussionList(); // Re-render to update star and order
             } catch (error) {
                  console.error(`${action} failed:`, error);
                  showStatus(`Failed to ${action.toLowerCase()} discussion.`, 'error');
             }
        }

        // --- Chat Interaction ---
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
            autoGrowTextarea(messageInput); // Handle resize on keydown too
        });

        messageInput.addEventListener('input', () => autoGrowTextarea(messageInput));

        sendMessageBtn.onclick = sendMessage;

        function autoGrowTextarea(element) {
            element.style.height = 'auto'; // Reset height to shrink if needed
            const maxHeight = 200; // Max height in pixels (approx 8-10 lines)
            element.style.height = Math.min(element.scrollHeight, maxHeight) + 'px';
            // Enable scroll if content exceeds max height
            element.style.overflowY = element.scrollHeight > maxHeight ? 'auto' : 'hidden';
        }


        async function sendMessage() {
            if (aiMessageStreaming || !currentDiscussionId) return;
            const prompt = messageInput.value.trim();
            if (!prompt) return;

            // Add user message optimistically
            const userMessage = {
                id: `temp-user-${Date.now()}`,
                sender: currentUser.lollms_client_ai_name ? 'You' : (currentUser.username || 'User'),
                content: prompt,
                user_grade: 0
            };
             // If the last message was also from the user, add spacing
             const lastMessageElement = chatMessages.lastElementChild;
             if (lastMessageElement && lastMessageElement.classList.contains('user-bubble')) {
                 userMessage.addSpacing = true; // Custom flag for renderMessage
             }
            renderMessage(userMessage);
            lastUserMessageId = userMessage.id;
            messageInput.value = '';
            autoGrowTextarea(messageInput); // Reset input height
            sendMessageBtn.disabled = true;
            scrollChatToBottom();

             const formData = new FormData();
             formData.append('prompt', prompt);
             formData.append('use_rag', isRagActive);
             // Optional: formData.append('parent_message_id', lastUserMessageId); // If backend supports using it

             aiMessageStreaming = true;
             currentAiMessageContent = "";
             currentAiMessageElement = null;
             currentAiMessageId = `temp-ai-${Date.now()}`;

             try {
                 const response = await fetch(`/api/discussions/${currentDiscussionId}/chat`, {
                     method: 'POST',
                     body: formData
                 });

                 if (!response.ok || !response.body) {
                     const errorData = await response.json().catch(() => ({ detail: `HTTP error ${response.status}` }));
                     throw new Error(`Error starting chat stream: ${errorData.detail || response.statusText}`);
                 }

                 const reader = response.body.getReader();
                 const decoder = new TextDecoder();

                 while (true) {
                     const { done, value } = await reader.read();
                     if (done) break;
                     const textChunk = decoder.decode(value, { stream: true });
                     const lines = textChunk.split('\n').filter(line => line.trim() !== '');
                     lines.forEach(line => {
                         try {
                             handleStreamChunk(JSON.parse(line));
                         } catch (e) {
                             console.warn("Error parsing stream chunk:", line, e);
                             renderMessage({ id: `warn-${Date.now()}`, sender: 'system', content: `Warning: Received malformed data chunk.` });
                         }
                     });
                 }
                 handleStreamEnd();

             } catch (error) {
                 console.error("Chat stream error:", error);
                 showStatus(`Chat stream failed: ${error.message}`, "error");
                 renderMessage({ id: `err-${Date.now()}`, sender: 'system', content: `Stream Error: ${error.message}` });
                 handleStreamEnd(true); // Pass error flag
             }
        }

        function handleStreamChunk(data) {
             if (data.type === 'chunk') {
                 if (!currentAiMessageElement) {
                     const aiMessage = {
                         id: currentAiMessageId,
                         sender: currentUser.lollms_client_ai_name || 'Assistant',
                         content: "",
                         user_grade: 0
                     };
                     // Add spacing if last message was user message
                     const lastMessageElement = chatMessages.lastElementChild;
                     if (lastMessageElement && lastMessageElement.classList.contains('user-bubble')) {
                        aiMessage.addSpacing = true;
                     }
                     renderMessage(aiMessage);
                 }
                 currentAiMessageContent += data.content;
                 const contentDiv = currentAiMessageElement?.querySelector('.message-content');
                 if (contentDiv) {
                     contentDiv.textContent = currentAiMessageContent; // Update plain text during stream
                 }
                 scrollChatToBottom();
             } else if (data.type === 'error') {
                 console.error("LLM Error:", data.content);
                 renderMessage({ id: `err-${Date.now()}`, sender: 'system', content: `LLM Error: ${data.content}` });
                 handleStreamEnd(true);
             } else if (data.type === 'full_message_info' && currentAiMessageElement) {
                 // Hypothetical: Update final ID if backend sends it
                 if(data.id) {
                    const oldId = currentAiMessageElement.id;
                    currentAiMessageElement.id = `message-${data.id}`;
                    currentAiMessageId = data.id; // Update state
                    // Update grading button onclick handlers etc. if they depend on the ID
                    updateMessageElementId(oldId, `message-${data.id}`);
                 }
             }
        }

        function handleStreamEnd(errorOccurred = false) {
            aiMessageStreaming = false;
            sendMessageBtn.disabled = false;

            if (currentAiMessageElement && currentAiMessageContent && !errorOccurred) {
                const contentDiv = currentAiMessageElement.querySelector('.message-content');
                if (contentDiv) {
                     renderMarkdownContent(contentDiv, currentAiMessageContent, currentAiMessageId);
                }
            }
             // Always refresh messages from server after stream finishes to ensure consistency
             if (currentDiscussionId) {
                 refreshMessagesAfterStream();
             }

            currentAiMessageElement = null;
            currentAiMessageContent = "";
            currentAiMessageId = null;
            scrollChatToBottom();
        }

        async function refreshMessagesAfterStream() {
            await new Promise(resolve => setTimeout(resolve, 300)); // Short delay
             if (!currentDiscussionId || aiMessageStreaming) return; // Don't refresh if another stream started
            try {
                const response = await apiRequest(`/api/discussions/${currentDiscussionId}`);
                currentMessages = await response.json();
                 // Smart update? Or full re-render? Full re-render is simpler for now.
                 renderMessages(currentMessages);
            } catch (error) {
                 console.error(`Failed to refresh messages for ${currentDiscussionId}:`, error);
                 // Maybe show a subtle error?
            }
        }

         // Helper to update IDs in DOM elements (e.g., for grading buttons after getting real ID)
         function updateMessageElementId(oldDomId, newDomId) {
             const element = document.getElementById(oldDomId);
             if (element) {
                 element.id = newDomId;
                 // Find grade buttons and update their onclick messageId parameter
                 element.querySelectorAll('.grade-btn').forEach(btn => {
                    const onclickAttr = btn.getAttribute('onclick');
                    if (onclickAttr && onclickAttr.includes(oldDomId.replace('message-', ''))) {
                        btn.setAttribute('onclick', onclickAttr.replace(oldDomId.replace('message-', ''), newDomId.replace('message-', '')));
                    }
                });
             }
         }

        // --- Message Rendering ---
        function clearChatArea(clearHeader = true) {
            chatMessages.innerHTML = '';
             if (clearHeader) {
                discussionTitle.textContent = 'Select or Create a Discussion';
                discussionActions.style.display = 'none';
                sendMessageBtn.disabled = true;
             }
            currentMessages = [];
            codeMirrorInstances = {};
        }

        function renderMessages(messagesToRender) {
            chatMessages.innerHTML = ''; // Clear existing
            codeMirrorInstances = {};
            messagesToRender.forEach((msg, index) => {
                 // Add spacing logic based on sender change
                 if (index > 0 && messagesToRender[index-1].sender !== msg.sender) {
                     msg.addSpacing = true;
                 } else {
                     msg.addSpacing = false;
                 }
                 renderMessage(msg);
            });
            scrollChatToBottom();
        }

        function renderMessage(message) {
             if (!message || !message.sender || typeof message.content !== 'string') {
                 console.warn("Skipping invalid message:", message);
                 return;
             }
            const messageId = message.id || `temp-${Date.now()}`;
            const domId = `message-${messageId}`;

            if (document.getElementById(domId)) return; // Avoid duplicates

            const messageContainer = document.createElement('div');
            messageContainer.className = 'message-container flex flex-col';
             if (message.addSpacing) {
                 messageContainer.classList.add('mt-3'); // Add margin-top for spacing
             }


            let bubbleClass = 'ai-bubble';
            let senderName = message.sender;
            let showGrade = false;
            const userNames = [currentUser.username, 'user', 'You']; // Include backend default 'user'

            if (userNames.includes(senderName)) {
                bubbleClass = 'user-bubble';
                senderName = ''; // Hide own name
            } else if (senderName.toLowerCase() === 'system' || senderName.toLowerCase() === 'error') {
                bubbleClass = 'system-bubble';
                senderName = '';
            } else {
                bubbleClass = 'ai-bubble';
                senderName = currentUser.lollms_client_ai_name || message.sender; // Use configured AI name
                showGrade = true; // Grade AI messages
            }

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = `message-bubble ${bubbleClass}`;
             bubbleDiv.id = domId; // Set ID on the bubble itself for easier targeting


            if (senderName) {
                const senderDiv = document.createElement('div');
                senderDiv.className = 'sender-name';
                senderDiv.textContent = senderName;
                bubbleDiv.appendChild(senderDiv);
            }

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content prose prose-sm max-w-none prose-pre:bg-gray-800 prose-pre:text-gray-100 prose-code:before:content-none prose-code:after:content-none prose-code:font-normal prose-code:bg-gray-100 prose-code:text-gray-800 prose-code:px-1 prose-code:py-0.5 prose-code:rounded';

            if (aiMessageStreaming && messageId === currentAiMessageId) {
                 contentDiv.textContent = currentAiMessageContent;
                 currentAiMessageElement = bubbleDiv; // Track the bubble element
            } else {
                 renderMarkdownContent(contentDiv, message.content, messageId);
            }
            bubbleDiv.appendChild(contentDiv);

            // Add Grading buttons (only if not temporary ID)
             if (showGrade && message.id && !message.id.startsWith('temp-')) {
                const gradeDiv = document.createElement('div');
                gradeDiv.className = 'flex items-center justify-end mt-1 text-xs';

                const userGrade = message.user_grade || 0;

                const upvoteBtn = document.createElement('button');
                 upvoteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" /></svg>`;
                 upvoteBtn.title = "Good response";
                 upvoteBtn.className = `grade-btn ${userGrade > 0 ? 'selected-up' : ''} p-1 rounded hover:bg-gray-200`;
                 upvoteBtn.onclick = () => gradeMessage(message.id, 1);

                const gradeSpan = document.createElement('span');
                gradeSpan.className = 'grade-score font-medium';
                gradeSpan.textContent = userGrade;

                const downvoteBtn = document.createElement('button');
                 downvoteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>`;
                 downvoteBtn.title = "Bad response";
                 downvoteBtn.className = `grade-btn ${userGrade < 0 ? 'selected-down' : ''} p-1 rounded hover:bg-gray-200`;
                 downvoteBtn.onclick = () => gradeMessage(message.id, -1);

                gradeDiv.appendChild(upvoteBtn);
                gradeDiv.appendChild(gradeSpan);
                gradeDiv.appendChild(downvoteBtn);
                bubbleDiv.appendChild(gradeDiv);
            }

            messageContainer.appendChild(bubbleDiv);
            chatMessages.appendChild(messageContainer);
        }

        function renderMarkdownContent(element, markdownText, messageId) {
            element.innerHTML = marked.parse(markdownText || "");
             try {
                renderMathInElement(element, { delimiters: [ {left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}, {left: '\\(', right: '\\)', display: false}, {left: '\\[', right: '\\]', display: true} ], throwOnError: false });
             } catch(e) { console.warn("KaTeX rendering error:", e); }

            element.querySelectorAll('pre > code').forEach((codeBlock, index) => {
                const preElement = codeBlock.parentNode;
                const language = codeBlock.className.match(/language-(\w+)/)?.[1] || 'plaintext';
                const code = codeBlock.textContent || '';
                 const uniqueCmId = `${messageId}-${index}`; // Unique ID for CM instance

                const header = document.createElement('div');
                header.className = 'code-block-header text-gray-600';
                const langSpan = document.createElement('span');
                langSpan.textContent = language;
                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'code-block-buttons';

                const copyBtn = document.createElement('button');
                 copyBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>Copy`;
                 copyBtn.onclick = () => {
                    navigator.clipboard.writeText(code)
                        .then(() => { copyBtn.textContent = 'Copied!'; setTimeout(() => copyBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>Copy`); }, 1500)
                };
                buttonsDiv.appendChild(copyBtn);

                if (language === 'python') {
                    const execBtn = document.createElement('button');
                     execBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>Run`;
                    execBtn.onclick = () => executePythonCode(code, preElement.parentNode); // Pass container of pre
                    buttonsDiv.appendChild(execBtn);
                }

                header.appendChild(langSpan);
                header.appendChild(buttonsDiv);
                preElement.parentNode.insertBefore(header, preElement);

                 const cmContainer = document.createElement('div');
                 preElement.parentNode.replaceChild(cmContainer, preElement);

                 let modeInfo = CodeMirror.findModeByName(language) || CodeMirror.findModeByExtension(language);
                 let mode = modeInfo ? modeInfo.mode : 'null'; // Fallback to plain text

                 try {
                    const cmInstance = CodeMirror(cmContainer, {
                         value: code, mode: mode, theme: "material-darker",
                         lineNumbers: true, readOnly: true, lineWrapping: true,
                     });
                     codeMirrorInstances[uniqueCmId] = cmInstance;
                      // Refresh needed if dimensions change later, but usually okay on initial render
                      // setTimeout(() => cmInstance.refresh(), 100);
                 } catch(e) {
                      console.error("CodeMirror initialization failed:", e);
                      cmContainer.appendChild(preElement); // Fallback
                 }
            });
        }

        async function gradeMessage(messageId, change) {
             if (!currentDiscussionId || !messageId || messageId.startsWith('temp-')) return;
             // Subtle UI update, no full status needed
             const messageElement = document.getElementById(`message-${messageId}`);
             if (!messageElement) return;

             // Optimistic UI update (can be reverted on error)
             const gradeSpan = messageElement.querySelector('.grade-score');
             const upBtn = messageElement.querySelector('.grade-btn:nth-child(1)');
             const downBtn = messageElement.querySelector('.grade-btn:nth-child(3)');
             let currentGrade = parseInt(gradeSpan?.textContent || '0');
             let newGrade = currentGrade;
             // Logic: If clicking upvote and current is 0 or -1, new grade is 1. If current is 1, new grade is 0 (toggle off).
             // If clicking downvote and current is 0 or 1, new grade is -1. If current is -1, new grade is 0.
             // This differs from backend which just increments/decrements. Let's match backend.
             // Backend seems to sum user changes. Let's assume the UI reflects the *next* state.
             let requestedChange = change;
             // If user clicks up (change=1) but it's already upvoted (currentGrade=1), the effective change is -1 to reset.
             // If user clicks down (change=-1) but it's already downvoted (currentGrade=-1), the effective change is +1 to reset.
             if (change === 1 && currentGrade === 1) requestedChange = -1; // Undo upvote
             else if (change === -1 && currentGrade === -1) requestedChange = 1; // Undo downvote
             else if (change === 1 && currentGrade === -1) requestedChange = 2; // Downvote to Upvote
             else if (change === -1 && currentGrade === 1) requestedChange = -2; // Upvote to Downvote

             // For simplicity, let's just send the intended +1 or -1 and let backend handle state.
             // UI will update based on returned value.

             try {
                const response = await apiRequest(`/api/discussions/${currentDiscussionId}/messages/${messageId}/grade`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ change: change }) // Send the simple change intention
                });
                 const updatedMessage = await response.json();

                 // Update UI based on response
                 if (gradeSpan) gradeSpan.textContent = updatedMessage.user_grade;
                 if (upBtn) upBtn.classList.toggle('selected-up', updatedMessage.user_grade > 0);
                 if (downBtn) downBtn.classList.toggle('selected-down', updatedMessage.user_grade < 0);

                 // Update local cache
                 const msgIndex = currentMessages.findIndex(m => m.id === messageId);
                 if (msgIndex > -1) {
                     currentMessages[msgIndex].user_grade = updatedMessage.user_grade;
                 }

             } catch (error) {
                 console.error("Grading failed:", error);
                  showStatus('Failed to update grade.', 'error');
                  // Revert optimistic UI? Too complex for now. Rely on refresh.
             }
        }


        // --- Pyodide Python Execution ---
        async function loadPyodide() {
            if (pyodide || pyodideLoading) return;
            pyodideLoading = true;
            showPyodideStatus('Loading Python interpreter...');
            try {
                pyodide = await loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.25.1/full/" });
                await pyodide.loadPackage("micropip");
                showPyodideStatus('Python ready.');
                setTimeout(() => showPyodideStatus(''), 3000);
            } catch (error) {
                console.error("Pyodide loading failed:", error);
                showPyodideStatus('Error loading Python interpreter.', true);
                pyodide = null;
            } finally {
                pyodideLoading = false;
            }
        }

        async function executePythonCode(code, codeContainerElement) {
             await loadPyodide();
             if (!pyodide) {
                 showPyodideStatus('Python interpreter not available.', true);
                 return;
             }

             const existingOutput = codeContainerElement.querySelector('.code-output');
             if (existingOutput) existingOutput.remove();

             const outputDiv = document.createElement('pre'); // Use <pre> for better formatting
             outputDiv.className = 'code-output mt-2 p-2 border-t border-gray-300 bg-gray-900 text-white text-xs font-mono overflow-x-auto max-h-40 rounded-b-md'; // Style as console output
             outputDiv.textContent = 'Executing...\n';
             codeContainerElement.appendChild(outputDiv); // Append directly after the code block header/CM

            let stdout = '';
            let stderr = '';
            pyodide.setStdout({ batched: (msg) => { stdout += msg + '\n'; outputDiv.textContent += msg + '\n'; }});
            pyodide.setStderr({ batched: (msg) => { stderr += msg + '\n'; outputDiv.textContent += `Error: ${msg}\n`; }});

             showPyodideStatus('Running Python code...');
             try {
                 const lines = code.split('\n');
                 const installCommands = lines.filter(line => line.trim().startsWith('%pip install') || line.trim().startsWith('!pip install'));
                 const codeToRun = lines.filter(line => !line.trim().startsWith('%pip install') && !line.trim().startsWith('!pip install')).join('\n');

                 if (installCommands.length > 0) {
                     outputDiv.textContent += 'Installing packages...\n';
                     const micropip = pyodide.pyimport("micropip");
                     for (const cmd of installCommands) {
                         const packages = cmd.split('install')[1].trim().split(' ');
                         outputDiv.textContent += `> ${cmd}\n`;
                         await micropip.install(packages);
                         outputDiv.textContent += `Packages installed: ${packages.join(', ')}\n`;
                     }
                     outputDiv.textContent += 'Installation complete. Running code...\n';
                 }

                 let result = await pyodide.runPythonAsync(codeToRun);
                 if (result !== undefined) {
                    outputDiv.textContent += `\nResult: ${result}\n`;
                 }
                  if (!stderr) outputDiv.textContent += '\nExecution finished.';
                  showPyodideStatus('Python execution finished.');
             } catch (error) {
                 console.error("Python execution error:", error);
                 outputDiv.textContent += `\nExecution Error: ${error.message}\n`;
                 showPyodideStatus('Python execution failed.', true);
             } finally {
                 pyodide.setStdout({}); // Reset stdout
                 pyodide.setStderr({}); // Reset stderr
                 setTimeout(() => showPyodideStatus(''), 3000);
             }
        }

         function showPyodideStatus(msg, isError = false) {
            pyodideStatus.textContent = msg;
            pyodideStatus.className = `text-xs mt-1 h-4 ${isError ? 'text-red-600' : 'text-blue-600'}`;
        }

        // --- Settings Modal Logic ---
        settingsBtn.onclick = () => openModal('settingsModal');

        async function loadAvailableLollmsModels() {
            console.log("Attempting to load LoLLMs models..."); // DEBUG
             try {
                console.log("here before")
                const response = await apiRequest('/api/config/lollms-models');
                 console.log("here")
                 // Check if the request itself was okay before processing JSON
                 if (!response.ok) {
                     // apiRequest should throw, but double-check
                     throw new Error(`API request failed with status ${response.status}`);
                 }
                 availableLollmsModels = await response.json();
                 console.log("Received models data:", availableLollmsModels); // DEBUG
                 // Update select in settings modal if it exists
                 populateDropdown(settingsLollmsModelSelect, availableLollmsModels, userLollmsModel, "No models found");
             } catch (error) {
                 console.error("Failed to load LoLLMs models:", error);
                 availableLollmsModels = [];
                 // Make sure the dropdown explicitly shows the error
                 populateDropdown(settingsLollmsModelSelect, [], null, `Error: ${error.message || 'Failed to load'}`);
             }
         }

         settingsLollmsModelSelect.onchange = () => {
             saveLollmsModelBtn.disabled = settingsLollmsModelSelect.value === userLollmsModel;
         };

         saveLollmsModelBtn.onclick = async () => {
             const selectedModel = settingsLollmsModelSelect.value;
             if (!selectedModel || selectedModel === userLollmsModel) return;

             showStatus('Saving model setting...', 'info', settingsStatus);
             saveLollmsModelBtn.disabled = true;

             try {
                const formData = new FormData();
                formData.append('model_name', selectedModel);
                await apiRequest('/api/config/lollms-model', {
                     method: 'POST',
                     body: formData,
                     statusElement: settingsStatus
                 });
                 userLollmsModel = selectedModel; // Update local state
                 showStatus(`Default model set to ${selectedModel}. Client will re-init on next chat.`, 'success', settingsStatus);
                 // No need to repopulate, just disable button again
             } catch (error) {
                 console.error("Failed to save model:", error);
                  // Status shown by apiRequest
                  saveLollmsModelBtn.disabled = false; // Re-enable on error
             }
         };

         settingsVectorizerSelect.onchange = () => {
             saveVectorizerBtn.disabled = settingsVectorizerSelect.value === userDefaultVectorizer;
         };

         saveVectorizerBtn.onclick = async () => {
             const selectedVectorizer = settingsVectorizerSelect.value;
             if (!selectedVectorizer || selectedVectorizer === userDefaultVectorizer) return;

             showStatus('Saving vectorizer setting...', 'info', settingsStatus);
             saveVectorizerBtn.disabled = true;

             try {
                const formData = new FormData();
                formData.append('vectorizer_name', selectedVectorizer);
                 await apiRequest('/api/store/active-vectorizer', { // This endpoint sets the user's default
                     method: 'POST',
                     body: formData,
                     statusElement: settingsStatus
                 });
                 userDefaultVectorizer = selectedVectorizer; // Update local state for user default
                 sessionActiveVectorizer = selectedVectorizer; // Also update session active
                 updateRagToggleButtonState(); // Update chat toggle state
                 showStatus(`Default vectorizer set to ${selectedVectorizer}.`, 'success', settingsStatus);
             } catch (error) {
                 console.error("Failed to save vectorizer:", error);
                  saveVectorizerBtn.disabled = false;
             }
         };


         function populateSettingsModal() {
             // Assumes lists are already loaded during init or refreshed if needed
             populateDropdown(settingsLollmsModelSelect, availableLollmsModels, userLollmsModel, "No models found");
             populateDropdown(settingsVectorizerSelect, availableVectorizers, userDefaultVectorizer, "No vectorizers found");
             saveLollmsModelBtn.disabled = true; // Disable save initially
             saveVectorizerBtn.disabled = true;
             showStatus('', 'info', settingsStatus); // Clear status
         }


        // --- File Management Modal Logic ---
        filesBtn.onclick = () => openModal('fileManagementModal');

        async function loadAvailableVectorizers() {
             try {
                 const response = await apiRequest('/api/store/vectorizers');
                 availableVectorizers = await response.json();
                 // Update selects in Settings and File Management modals
                 populateDropdown(settingsVectorizerSelect, availableVectorizers, userDefaultVectorizer, "No vectorizers found");
                 populateDropdown(fileVectorizerSelect, availableVectorizers, null, "Select Vectorizer", true); // Allow empty selection for upload
             } catch (error) {
                 console.error("Failed to load vectorizers:", error);
                 availableVectorizers = [];
                 populateDropdown(settingsVectorizerSelect, [], null, "Error loading vectorizers");
                 populateDropdown(fileVectorizerSelect, [], null, "Error loading vectorizers", true);
             }
         }

         async function loadIndexedRagFiles() {
             try {
                 const response = await apiRequest('/api/store/files');
                 indexedRagFiles = await response.json();
                 renderRagFileList(indexedRagFiles); // Update list in File modal
             } catch (error) {
                 console.error("Failed to load RAG files:", error);
                 indexedRagFiles = [];
                 renderRagFileList(null, "Error loading files."); // Show error in list
             }
         }

        function populateFileManagementModal() {
             // Assumes data (vectorizers, files) is loaded/up-to-date
             populateDropdown(fileVectorizerSelect, availableVectorizers, null, "Select Vectorizer", true);
             renderRagFileList(indexedRagFiles);
             fileUploadInput.value = ''; // Clear file input
             confirmUploadBtn.disabled = true; // Disable upload initially
             showStatus('', 'info', uploadStatus); // Clear statuses
             showStatus('', 'info', fileListStatus);
         }

         fileVectorizerSelect.onchange = () => {
             updateConfirmUploadBtnState();
         };
         fileUploadInput.onchange = () => {
            updateConfirmUploadBtnState();
         };

         function updateConfirmUploadBtnState() {
              const filesSelected = fileUploadInput.files && fileUploadInput.files.length > 0;
              const vectorizerSelected = fileVectorizerSelect.value !== "";
              confirmUploadBtn.disabled = !(filesSelected && vectorizerSelected);
         }

         confirmUploadBtn.onclick = async () => {
            const files = fileUploadInput.files;
            const vectorizer = fileVectorizerSelect.value;
            if (!files || files.length === 0 || !vectorizer) return;

            const formData = new FormData();
            for (const file of files) {
                formData.append('files', file);
            }
            formData.append('vectorizer_name', vectorizer);

             showStatus(`Uploading ${files.length} file(s) using ${vectorizer}...`, 'info', uploadStatus);
             confirmUploadBtn.disabled = true;

             try {
                 const response = await apiRequest('/api/store/upload-files', {
                     method: 'POST',
                     body: formData,
                     statusElement: uploadStatus // Target modal status
                 });

                 const result = await response.json();
                 let message = result.message || "Upload completed.";
                 let statusType = response.status === 207 ? 'warning' : 'success'; // 207 is partial success

                 if (response.status === 207) {
                     message = `Upload finished. Processed: ${result.processed_files?.length || 0}, Errors: ${result.errors?.length || 0}`;
                     console.warn("Upload errors:", result.errors);
                 }

                 showStatus(message, statusType, uploadStatus);
                 await loadIndexedRagFiles(); // Refresh file list
                 fileUploadInput.value = ''; // Clear file input
                 // Keep vectorizer selected, disable button again
                 updateConfirmUploadBtnState();


             } catch (error) {
                 console.error("Upload failed:", error);
                  // Status shown by apiRequest in modal status
                  confirmUploadBtn.disabled = false; // Re-enable on error
                  updateConfirmUploadBtnState(); // Check state again
             }
         };

         function renderRagFileList(files, message = null) {
             indexedFileList.innerHTML = ''; // Clear current list
             if (message) {
                  const msgElement = document.createElement('p');
                  msgElement.className = 'text-gray-500 italic px-1';
                  if(message.toLowerCase().includes("error")) msgElement.classList.add('text-red-500');
                  msgElement.textContent = message;
                  indexedFileList.appendChild(msgElement);
                  return;
             }

             if (!files || files.length === 0) {
                 indexedFileList.innerHTML = '<p class="text-gray-500 italic px-1">No documents indexed yet.</p>';
                 return;
             }

             files.forEach(file => {
                 const fileDiv = document.createElement('div');
                 fileDiv.className = 'flex justify-between items-center py-1 px-1 hover:bg-gray-100 rounded';
                 const fileNameSpan = document.createElement('span');
                 fileNameSpan.textContent = file.filename;
                 fileNameSpan.className = 'truncate text-sm text-gray-700';
                 fileNameSpan.title = file.filename; // Show full name on hover

                 const deleteBtn = document.createElement('button');
                 deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>`;
                 deleteBtn.className = 'flex-shrink-0 text-red-500 hover:text-red-700 p-1 rounded hover:bg-red-100 ml-2';
                 deleteBtn.title = `Delete ${file.filename}`;
                 deleteBtn.onclick = () => deleteRagFileInModal(file.filename);

                 fileDiv.appendChild(fileNameSpan);
                 fileDiv.appendChild(deleteBtn);
                 indexedFileList.appendChild(fileDiv);
             });
         }

          async function deleteRagFileInModal(filename) {
             if (!confirm(`Are you sure you want to delete the RAG document "${filename}"?`)) return;
             showStatus(`Deleting ${filename}...`, 'info', fileListStatus);
             try {
                 const response = await apiRequest(`/api/store/files/${encodeURIComponent(filename)}`, {
                     method: 'DELETE',
                     statusElement: fileListStatus
                 });
                 const result = await response.json();
                 showStatus(result.message || `Deleted ${filename}.`, 'success', fileListStatus);
                 // Remove from local cache and re-render list
                 indexedRagFiles = indexedRagFiles.filter(f => f.filename !== filename);
                 renderRagFileList(indexedRagFiles);
             } catch (error) {
                 console.error(`Delete failed for ${filename}:`, error);
                 // Status shown by apiRequest
             }
         }


        // --- RAG Toggle Logic ---
        ragToggleBtn.onclick = () => {
             if (!sessionActiveVectorizer) {
                 showStatus('Cannot enable RAG without an active vectorizer. Set one in Settings.', 'warning');
                 return;
             }
             isRagActive = !isRagActive;
             updateRagToggleButtonState();
             showStatus(`RAG is now ${isRagActive ? 'ACTIVE' : 'INACTIVE'}.`, 'info');
        };

        function updateRagToggleButtonState() {
            const hasVectorizer = !!sessionActiveVectorizer;
            ragToggleBtn.disabled = !hasVectorizer;

            if (!hasVectorizer) {
                 ragToggleBtn.classList.remove('rag-toggle-on');
                 ragToggleBtn.classList.add('rag-toggle-off');
                 ragToggleBtn.title = "No active vectorizer (Set in Settings)";
                 isRagActive = false; // Force off
                 return;
            }

            if (isRagActive) {
                ragToggleBtn.classList.remove('rag-toggle-off');
                ragToggleBtn.classList.add('rag-toggle-on');
                ragToggleBtn.title = `RAG Active (Using ${sessionActiveVectorizer}) - Click to disable`;
            } else {
                ragToggleBtn.classList.remove('rag-toggle-on');
                ragToggleBtn.classList.add('rag-toggle-off');
                ragToggleBtn.title = `RAG Inactive (Using ${sessionActiveVectorizer}) - Click to enable`;
            }
        }


        // --- Export / Import Logic ---
        function populateExportModal() {
             const allIds = Object.keys(discussions);
             exportDiscussionList.innerHTML = '';
             if (allIds.length === 0) {
                 exportDiscussionList.innerHTML = '<p class="text-gray-500 italic">No discussions to export.</p>';
             } else {
                 allIds.forEach(id => {
                     const div = document.createElement('div');
                     div.className = 'flex items-center';
                     const checkbox = document.createElement('input');
                     checkbox.type = 'checkbox';
                     checkbox.id = `export-check-${id}`;
                     checkbox.value = id;
                     checkbox.className = 'h-4 w-4 mr-2 rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-offset-0 focus:ring-blue-200 focus:ring-opacity-50';
                     const label = document.createElement('label');
                     label.htmlFor = `export-check-${id}`;
                     label.textContent = discussions[id].title;
                     label.className = 'text-sm text-gray-700';
                     div.appendChild(checkbox);
                     div.appendChild(label);
                     exportDiscussionList.appendChild(div);
                 });
             }
        }

        exportDataBtn.onclick = () => openModal('exportModal');

        confirmExportBtn.onclick = async () => {
            const selectedIds = Array.from(exportDiscussionList.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
             closeModal('exportModal');
             showStatus('Exporting data...', 'info');

             try {
                 const requestBody = { discussion_ids: selectedIds.length > 0 ? selectedIds : null };
                 const response = await apiRequest('/api/discussions/export', {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify(requestBody)
                 });

                 const exportData = await response.json();
                 const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                 const url = URL.createObjectURL(blob);
                 const a = document.createElement('a');
                 a.href = url;
                 const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                 a.download = `simplified_lollms_export_${currentUser.username}_${timestamp}.json`;
                 document.body.appendChild(a);
                 a.click();
                 document.body.removeChild(a);
                 URL.revokeObjectURL(url);
                 showStatus('Data exported successfully.', 'success');

             } catch (error) {
                 console.error("Export failed:", error);
                 // Status shown by apiRequest
             }
        };

        importDataBtn.onclick = () => {
             importFile.value = '';
             importPreviewArea.style.display = 'none';
             importDiscussionList.innerHTML = '';
             confirmImportBtn.disabled = true;
             showStatus('', 'info', importStatus);
             parsedImportData = null; // Reset parsed data
             openModal('importModal');
        };

         let parsedImportData = null;
         importFile.onchange = async () => {
            const file = importFile.files[0];
            parsedImportData = null; // Reset on new file selection
            importPreviewArea.style.display = 'none';
            importDiscussionList.innerHTML = '';
            confirmImportBtn.disabled = true;
            showStatus('', 'info', importStatus);

            if (!file) return;

             if (file.type !== 'application/json') {
                 showStatus('Error: Please select a valid JSON file.', 'error', importStatus);
                 return;
             }

            showStatus('Reading file...', 'info', importStatus);
            try {
                const content = await file.text();
                parsedImportData = JSON.parse(content);

                if (!parsedImportData || !Array.isArray(parsedImportData.discussions)) {
                    throw new Error("Invalid export file format (missing 'discussions' array).");
                }

                 if (parsedImportData.discussions.length === 0) {
                     importDiscussionList.innerHTML = '<p class="text-gray-500 italic">No discussions found in the file.</p>';
                     confirmImportBtn.disabled = true; // No discussions to select
                 } else {
                     parsedImportData.discussions.forEach((disc, index) => {
                        if (!disc || typeof disc.discussion_id !== 'string') {
                             console.warn("Skipping invalid discussion data in import file:", disc);
                             return; // Skip malformed entries
                        }
                        const div = document.createElement('div');
                        div.className = 'flex items-center';
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = `import-check-${disc.discussion_id}`; // Use original ID as value
                        checkbox.value = disc.discussion_id;
                        checkbox.checked = true; // Select all by default
                        checkbox.className = 'h-4 w-4 mr-2 rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-offset-0 focus:ring-blue-200 focus:ring-opacity-50';
                        const label = document.createElement('label');
                        label.htmlFor = `import-check-${disc.discussion_id}`;
                        label.textContent = `${disc.title || 'Untitled'} (ID: ...${disc.discussion_id.slice(-6)})`;
                        label.className = 'text-sm text-gray-700';
                        div.appendChild(checkbox);
                        div.appendChild(label);
                        importDiscussionList.appendChild(div);
                    });
                     confirmImportBtn.disabled = importDiscussionList.childElementCount === 0; // Disable if all entries were invalid
                 }
                 importPreviewArea.style.display = 'block';
                 showStatus('', 'info', importStatus); // Clear 'Reading file...'

            } catch (error) {
                console.error("Error reading import file:", error);
                showStatus(`Error reading file: ${error.message}`, 'error', importStatus);
                parsedImportData = null;
                confirmImportBtn.disabled = true;
            }
         };

         confirmImportBtn.onclick = async () => {
             if (!parsedImportData || !importFile.files[0]) return;

             const selectedOriginalIds = Array.from(importDiscussionList.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
             if (selectedOriginalIds.length === 0) {
                 showStatus('Please select at least one discussion to import.', 'error', importStatus);
                 return;
             }

             showStatus('Importing discussions...', 'info', importStatus);
             confirmImportBtn.disabled = true; // Prevent double-click

             try {
                const importRequest = { discussion_ids_to_import: selectedOriginalIds };
                const formData = new FormData();
                formData.append('import_file', importFile.files[0]);
                formData.append('import_request_json', JSON.stringify(importRequest));

                 const response = await apiRequest('/api/discussions/import', {
                     method: 'POST',
                     body: formData,
                     statusElement: importStatus // Target modal status
                 });

                 const result = await response.json();
                 showStatus(result.message || `Imported ${result.imported_count} discussions.`, 'success', importStatus);
                 console.log("Import errors/skipped:", result.errors);
                 await loadDiscussions(); // Refresh the discussion list
                 setTimeout(() => closeModal('importModal'), 2000); // Close after success

             } catch (error) {
                 console.error("Import failed:", error);
                 // Status shown by apiRequest in modal status
                 confirmImportBtn.disabled = false; // Re-enable on error
             }
         };


        // --- Utilities ---
        function scrollChatToBottom() {
            requestAnimationFrame(() => {
                 chatMessages.scrollTop = chatMessages.scrollHeight;
            });
        }

        function showStatus(msg, type = 'info', statusElement = statusMessage) {
            const targetElement = statusElement || statusMessage; // Fallback to global status
            if (targetElement) {
                 targetElement.textContent = msg;
                 let typeClass = 'text-gray-600'; // Default info
                 if (type === 'error') typeClass = 'text-red-600';
                 else if (type === 'success') typeClass = 'text-green-600';
                 else if (type === 'warning') typeClass = 'text-yellow-600';
                 // Reset classes then add the correct one
                 targetElement.className = targetElement.className.replace(/text-(gray|red|green|yellow)-600/g, '');
                 targetElement.classList.add(typeClass);

                 // Auto-clear global status, but not modal statuses
                 if (targetElement === statusMessage && msg) {
                    clearTimeout(targetElement.timer); // Clear previous timer if any
                    targetElement.timer = setTimeout(() => {
                         if (targetElement.textContent === msg) { // Only clear if message hasn't changed
                             targetElement.textContent = '';
                         }
                    }, 5000);
                 }
             } else {
                 console.log(`Status [${type}]: ${msg}`);
             }
        }

        // Helper to populate select dropdowns
        function populateDropdown(selectElement, items, selectedValue, emptyText = "Nothing found", allowEmpty = false) {
            if (!selectElement) {
                console.error("populateDropdown: selectElement is null or undefined"); // DEBUG
                return;
            }
            console.log(`Populating dropdown '${selectElement.id}':`, { items, selectedValue, emptyText, allowEmpty }); // DEBUG
            selectElement.innerHTML = ''; // Clear existing

            if (allowEmpty) {
                 const emptyOption = document.createElement('option');
                 emptyOption.value = "";
                 emptyOption.textContent = emptyText; // Use provided text for the empty option
                 selectElement.appendChild(emptyOption);
             }

             if (!items || !Array.isArray(items) || items.length === 0) { // Add Array.isArray check
                console.log(`Dropdown '${selectElement.id}': No items to populate.`); // DEBUG
                if (!allowEmpty) { // Only add placeholder if empty selection isn't allowed
                    const placeholder = document.createElement('option');
                    placeholder.disabled = true;
                    placeholder.selected = true;
                    placeholder.textContent = emptyText;
                    selectElement.appendChild(placeholder);
                }
             } else {
                 items.forEach(item => {
                     const option = document.createElement('option');
                     if (!item || typeof item.name !== 'string') { // Add check for valid item structure
                         console.warn(`Dropdown '${selectElement.id}': Skipping invalid item:`, item); // DEBUG
                         return; // Skip this invalid item
                     }
                     option.value = item.name; // Assuming items have { name: 'value', method_name: 'Display Text' } or just {name: 'value'}
                     option.textContent = item.method_name || item.name; // Use descriptive name if available
                     if (item.name === selectedValue) {
                         option.selected = true;
                     }
                     selectElement.appendChild(option);
                 });
             }
        }


    </script>

</body>
</html>